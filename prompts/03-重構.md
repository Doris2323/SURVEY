---
name: refactor
description: Improve code quality while keeping tests passing.
args:
  SPECS_ROOT_DIR: /specs
  FEATURE_SPECS_DIR: ${SPECS_ROOT_DIR}/features
input: Passing tests from green-light phase
output: Refactored src/*.js
---

# 04 - é‡æ§‹éšŽæ®µ

## ç›®æ¨™

åœ¨æ¸¬è©¦ä¿è­·ä¸‹ï¼Œæ”¹å–„ç¨‹å¼ç¢¼å“è³ªã€‚

## âš ï¸ å‰ç½®æ¢ä»¶

**åªè™•ç†æ²’æœ‰ `@ignore` æ¨™ç±¤çš„ Feature**

- å¸¶æœ‰ `@ignore` çš„ Feature å°šæœªé€²å…¥é–‹ç™¼æµç¨‹ï¼Œæœƒè¢« `npm test` è·³éŽ
- åªæœ‰å·²å®Œæˆç¶ ç‡ˆéšŽæ®µï¼ˆæ¸¬è©¦é€šéŽï¼‰çš„ Feature æ‰èƒ½é€²å…¥é‡æ§‹éšŽæ®µ
- å¦‚æžœç›®æ¨™ Feature é‚„æœ‰ `@ignore`ï¼Œè«‹å…ˆå›žåˆ° [01-ç´…ç‡ˆ.md](./01-ç´…ç‡ˆ.md) å®Œæˆå‰ç½®æ­¥é©Ÿ

## âš ï¸ æœ€é‡è¦çš„è¦å‰‡ï¼šçµ•å°ç¦æ­¢ä¿®æ”¹ .feature æª”æ¡ˆ

**åœ¨æ•´å€‹ BDD æµç¨‹ä¸­ï¼Œçµ•å°ä¸èƒ½ä¿®æ”¹ `.feature` æª”æ¡ˆã€‚**

- Feature æª”æ¡ˆæ˜¯éœ€æ±‚è¦æ ¼ï¼ˆSpecificationï¼‰ï¼Œæ˜¯éœ€æ±‚å¥‘ç´„
- é‡æ§‹éšŽæ®µåªæ”¹å–„ç¨‹å¼ç¢¼å“è³ªï¼Œä¸æ”¹è®Šè¡Œç‚º
- **çµ•å°ä¸èƒ½**å› ç‚ºé‡æ§‹è€Œä¿®æ”¹ Feature æª”æ¡ˆ
- **çµ•å°ä¸èƒ½**å› ç‚ºæƒ³è¦ã€Œæ›´å¥½çš„æ¸¬è©¦ã€è€Œä¿®æ”¹ Feature æª”æ¡ˆ

**ä½ çš„è·è²¬**ï¼š
- âœ… é‡æ§‹æ¥­å‹™é‚è¼¯ï¼ˆ`src/*.js`ï¼‰
- âœ… é‡æ§‹æ¸¬è©¦ç¨‹å¼ç¢¼ï¼ˆStep Definitionï¼‰
- âœ… ä¿æŒæ¸¬è©¦é€šéŽ
- âŒ **çµ•å°ä¸èƒ½**ä¿®æ”¹ Feature æª”æ¡ˆ
- âŒ **çµ•å°ä¸èƒ½**å› ç‚ºé‡æ§‹è€Œæ”¹è®Š Feature çš„èªžæ„

## TDD é‡æ§‹åŽŸå‰‡

åœ¨ TDD ä¸­ï¼Œ**é‡æ§‹**æ˜¯åœ¨ä¸æ”¹è®Šç¨‹å¼è¡Œç‚ºçš„å‰æä¸‹ï¼Œæ”¹å–„ç¨‹å¼ç¢¼çµæ§‹ã€‚

é‡æ§‹çš„å‰æï¼š
1. æ‰€æœ‰æ¸¬è©¦å¿…é ˆé€šéŽï¼ˆç¶ ç‡ˆï¼‰
2. æ¯æ¬¡å°æ”¹å‹•å¾Œéƒ½è¦åŸ·è¡Œæ¸¬è©¦
3. æ¸¬è©¦å¤±æ•—å°±å›žé€€
4. **çµ•å°ä¸ä¿®æ”¹ Feature æª”æ¡ˆ**ï¼ˆéœ€æ±‚è¦æ ¼æ‡‰ä¿æŒç©©å®šï¼‰

## é‡æ§‹æ™‚æ©Ÿ

### âœ… é©åˆé‡æ§‹

- é‡è¤‡çš„ç¨‹å¼ç¢¼
- éŽé•·çš„å‡½å¼
- é­”è¡“æ•¸å­—ï¼ˆMagic Numbersï¼‰
- å‘½åä¸æ¸…æ¥š

### âŒ ä¸é©åˆé‡æ§‹

- æ¸¬è©¦é‚„æ²’é€šéŽ
- è¶•æ™‚é–“äº¤ä»˜
- æ²’æœ‰æ¸¬è©¦ä¿è­·

## å¸¸è¦‹é‡æ§‹æŠ€å·§

### 1. æŠ½å–å¸¸æ•¸

```javascript
// Before
function addToCart(productId) {
  const sheet = getSheet('è³¼ç‰©è»Š');
  // ...
}

// After
const SHEET_NAME = 'è³¼ç‰©è»Š';

function addToCart(productId) {
  const sheet = getSheet(SHEET_NAME);
  // ...
}
```

### 2. æŠ½å–è¼”åŠ©å‡½å¼

```javascript
// Before
function addToCart(productId) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('è³¼ç‰©è»Š');
  if (!sheet) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    sheet = ss.insertSheet('è³¼ç‰©è»Š');
    sheet.appendRow(['å•†å“ID', 'æ•¸é‡', 'å–®åƒ¹', 'å»ºç«‹æ™‚é–“']);
  }
  // ...
}

// After
function getSheet(name) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.appendRow(['å•†å“ID', 'æ•¸é‡', 'å–®åƒ¹', 'å»ºç«‹æ™‚é–“']);
  }
  return sheet;
}

function addToCart(productId) {
  const sheet = getSheet(SHEET_NAME);
  // ...
}
```

### 3. æ”¹å–„å‘½å

```javascript
// Before
function a(p, q) {
  const s = getSheet(SHEET_NAME);
  const d = new Date();
  s.appendRow([p, q, d]);
}

// After
function addToCart(productId, quantity) {
  const sheet = getSheet(SHEET_NAME);
  const now = new Date();
  const cartItem = createCartItem(productId, quantity, now);
  sheet.appendRow(cartItemToRow(cartItem));
}
```

### 4. çµæ§‹åŒ–è³‡æ–™

```javascript
// Before
sheet.appendRow([productId, quantity, price, time]);

// After
function createCartItem(productId, quantity, price) {
  return {
    productId: productId,
    quantity: quantity,
    price: price,
    createdAt: formatDateZhTW(new Date())
  };
}

function cartItemToRow(item) {
  return [item.productId, item.quantity, item.price, item.createdAt];
}
```

## é‡æ§‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                 â”‚
â”‚   1. ç¢ºèªæ¸¬è©¦å…¨éƒ¨é€šéŽï¼ˆç¶ ç‡ˆï¼‰                   â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   2. åšä¸€å€‹å°æ”¹å‹•                               â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   3. åŸ·è¡Œæ¸¬è©¦                                   â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   4. æ¸¬è©¦é€šéŽï¼Ÿ                                 â”‚
â”‚        â”‚                                        â”‚
â”‚        â”œâ”€â”€ æ˜¯ â”€â”€â†’ å›žåˆ°æ­¥é©Ÿ 2ï¼ˆç¹¼çºŒé‡æ§‹ï¼‰        â”‚
â”‚        â”‚                                        â”‚
â”‚        â””â”€â”€ å¦ â”€â”€â†’ å›žé€€æ”¹å‹•ï¼Œå›žåˆ°æ­¥é©Ÿ 2          â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸŽ¯ å¸¸è¦‹é‡æ§‹æ¨¡å¼

### 1. æŠ½å–æ¬„ä½ç´¢å¼•å¸¸æ•¸

```javascript
// âœ… æŽ¨è–¦ï¼šä½¿ç”¨å‘½åå¸¸æ•¸
const COLUMN = {
  PRODUCT_ID: 0,
  QUANTITY: 1,
  PRICE: 2,
  CREATED_AT: 3
};

function getCartItems() {
  // ...
  const productId = row[COLUMN.PRODUCT_ID];    // æ¸…æ¥š
  const quantity = row[COLUMN.QUANTITY];       // æ¸…æ¥š
}

// âŒ é¿å…ï¼šé­”è¡“æ•¸å­—
function getCartItems() {
  const productId = row[0];   // 0 æ˜¯ä»€éº¼ï¼Ÿ
  const quantity = row[1];    // 1 æ˜¯ä»€éº¼ï¼Ÿ
}
```

### 2. æŠ½å–ç‹€æ…‹å¸¸æ•¸

```javascript
// âœ… æŽ¨è–¦
const ORDER_STATUS = {
  PENDING: 'PENDING',
  PAID: 'PAID',
  SHIPPED: 'SHIPPED',
  COMPLETED: 'COMPLETED'
};

if (status === ORDER_STATUS.PAID) {
  // ...
}

// âŒ é¿å…ï¼šå­—ä¸²å­—é¢å€¼
if (status === 'PAID') {  // å®¹æ˜“æ‰“éŒ¯
  // ...
}
```

### 3. æŠ½å–æ—¥æœŸåˆ¤æ–·é‚è¼¯

```javascript
// âœ… æŽ¨è–¦ï¼šè¼”åŠ©å‡½å¼
function getTodayDateRange() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  return { today, tomorrow };
}

function isToday(createdAtISO) {
  const { today, tomorrow } = getTodayDateRange();
  const createdAt = new Date(createdAtISO);
  return createdAt >= today && createdAt < tomorrow;
}

function getTodayOrders() {
  // ...
  if (isToday(row[COLUMN.CREATED_AT])) {
    orders.push(...);
  }
}

// âŒ é¿å…ï¼šé‡è¤‡çš„æ—¥æœŸé‚è¼¯
function getTodayOrders() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  // ... åœ¨æ¯å€‹å‡½å¼éƒ½é‡è¤‡
}
```

### 4. æŠ½å–é©—è­‰é‚è¼¯

```javascript
// âœ… æŽ¨è–¦
function validateCartItem(productId, quantity) {
  if (!productId) {
    return { valid: false, message: 'è«‹é¸æ“‡å•†å“' };
  }
  if (quantity <= 0) {
    return { valid: false, message: 'æ•¸é‡å¿…é ˆå¤§æ–¼ 0' };
  }
  return { valid: true };
}

function addToCart(productId, quantity) {
  const validation = validateCartItem(productId, quantity);
  if (!validation.valid) {
    return { success: false, message: validation.message };
  }
  // ...
}

// âŒ é¿å…ï¼šé©—è­‰é‚è¼¯æ•£è½å„è™•
function addToCart(productId, quantity) {
  if (!productId) {
    return { success: false, message: 'è«‹é¸æ“‡å•†å“' };
  }
  if (quantity <= 0) {
    return { success: false, message: 'æ•¸é‡å¿…é ˆå¤§æ–¼ 0' };
  }
  // ... å¾ˆé•·çš„å‡½å¼
}
```

### 5. æŠ½å–å·¥ä½œè¡¨æ“ä½œ

```javascript
// âœ… æŽ¨è–¦
function getSheet(name) {
  return SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName(name);
}

function getAllRows(sheetName) {
  return getSheet(sheetName).getDataRange().getValues();
}

// âŒ é¿å…ï¼šé‡è¤‡çš„å·¥ä½œè¡¨æ“ä½œ
function addToCart(productId) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('è³¼ç‰©è»Š');
  // ...
}

function getCartItems() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('è³¼ç‰©è»Š');
  // ... é‡è¤‡çš„ç¨‹å¼ç¢¼
}
```

## é‡æ§‹æª¢æŸ¥æ¸…å–®

- [ ] æŠ½å–å¸¸æ•¸ï¼ˆé¿å…é­”è¡“æ•¸å­—/å­—ä¸²ï¼‰
- [ ] æŠ½å–è¼”åŠ©å‡½å¼ï¼ˆé¿å…é‡è¤‡ç¨‹å¼ç¢¼ï¼‰
- [ ] æ”¹å–„å‘½åï¼ˆæ¸…æ¥šè¡¨é”æ„åœ–ï¼‰
- [ ] çµæ§‹åŒ–è³‡æ–™ï¼ˆä½¿ç”¨ç‰©ä»¶è€Œéžé™£åˆ—ï¼‰
- [ ] æ¯æ¬¡æ”¹å‹•å¾Œæ¸¬è©¦éƒ½é€šéŽ
- [ ] **æ—¥æœŸåˆ¤æ–·é‚è¼¯å·²æŠ½å–**
- [ ] **æ¬„ä½ç´¢å¼•ä½¿ç”¨å¸¸æ•¸è€Œéžæ•¸å­—**
- [ ] **ç‹€æ…‹å€¼ä½¿ç”¨å¸¸æ•¸è€Œéžå­—ä¸²**

## å®Œæˆæ¢ä»¶

```bash
npm test
```

```
15 scenarios (15 passed)
77 steps (77 passed)
```

ç¨‹å¼ç¢¼ç¬¦åˆä»¥ä¸‹æ¨™æº–ï¼š
- [ ] æ²’æœ‰é‡è¤‡çš„ç¨‹å¼ç¢¼
- [ ] å‡½å¼é•·åº¦é©ä¸­ï¼ˆ<20 è¡Œï¼‰
- [ ] å‘½åæ¸…æ¥š
- [ ] å¸¸æ•¸å·²æŠ½å–
- [ ] æ‰€æœ‰æ¸¬è©¦é€šéŽ

## ä¸‹ä¸€æ­¥

é‡æ§‹å®Œæˆå¾Œï¼Œå¯ä»¥ï¼š
1. æäº¤ç¨‹å¼ç¢¼ï¼ˆ`git commit`ï¼‰
2. æŽ¨é€åˆ° Apps Scriptï¼ˆ`clasp push`ï¼‰
3. éƒ¨ç½² Web App æ¸¬è©¦
4. é–‹å§‹ä¸‹ä¸€å€‹ TDD å¾ªç’°
