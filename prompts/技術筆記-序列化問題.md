# Google Apps Script åºåˆ—åŒ–å•é¡ŒæŠ€è¡“ç­†è¨˜

## ğŸ› å•é¡Œæè¿°

åœ¨ Google Apps Script Web App ä¸­ï¼Œå¾å¾Œç«¯å‚³éè³‡æ–™åˆ°å‰ç«¯æ™‚é‡åˆ° `null` éŒ¯èª¤ï¼š

```javascript
// å‰ç«¯éŒ¯èª¤
TypeError: Cannot read properties of null (reading 'records')
```

## ğŸ” æ ¹æœ¬åŸå› 

### Date ç‰©ä»¶åºåˆ—åŒ–å¤±æ•—

**å•é¡Œç¨‹å¼ç¢¼**ï¼š
```javascript
// å¾Œç«¯
function getAllRecords() {
  const sheet = getSheet();
  const data = sheet.getDataRange().getValues();  // âŒ åŒ…å« Date ç‰©ä»¶
  return data.slice(1);
}

function getRecordsForWeb() {
  return {
    records: getTodayRecords(),  // åŒ…å« Date ç‰©ä»¶
    workHours: getTodayWorkHours()
  };
}
```

```javascript
// å‰ç«¯
google.script.run
  .withSuccessHandler(function(data) {
    // data æ˜¯ nullï¼å› ç‚º Date ç‰©ä»¶ç„¡æ³•æ­£ç¢ºåºåˆ—åŒ–
    console.log(data.records);  // âŒ TypeError
  })
  .getRecordsForWeb();
```

### ç‚ºä»€éº¼ Date ç‰©ä»¶ç„¡æ³•åºåˆ—åŒ–ï¼Ÿ

ç•¶è³‡æ–™é€é `google.script.run` å¾å¾Œç«¯å‚³éåˆ°å‰ç«¯æ™‚ï¼š

1. Google Apps Script æœƒå°‡å›å‚³å€¼è½‰æ›ç‚º JSON
2. `getValues()` å›å‚³çš„ Date ç‰©ä»¶åœ¨è½‰æ›æ™‚å¤±æ•—
3. å‰ç«¯æ”¶åˆ° `null`

**ç¯„ä¾‹**ï¼š
```javascript
// Sheet ä¸­çš„è³‡æ–™ï¼š
// | ID | é¡å‹ | æ‰“å¡æ™‚é–“ | å»ºç«‹æ™‚é–“ |
// | abc123 | IN | 2026-01-26 22:00:00 | 2026-01-26 22:00:00 |

// getValues() å›å‚³ï¼š
[
  ['abc123', 'IN', Dateå°è±¡, Dateå°è±¡]  // âŒ Date ç‰©ä»¶
]

// é€é google.script.run å‚³éæ™‚ï¼š
// JSON.stringify([Dateå°è±¡]) â†’ åºåˆ—åŒ–å¤±æ•— â†’ å‰ç«¯æ”¶åˆ° null
```

## âœ… è§£æ±ºæ–¹æ¡ˆ

### ä½¿ç”¨ getDisplayValues()

```javascript
// å¾Œç«¯ - ä¿®æ­£å¾Œ
function getAllRecords() {
  const sheet = getSheet();
  const data = sheet.getDataRange().getDisplayValues();  // âœ… å›å‚³å­—ä¸²
  return data.slice(1);
}
```

**å·®ç•°å°ç…§**ï¼š

| æ–¹æ³• | å›å‚³é¡å‹ | ç¯„ä¾‹ | åºåˆ—åŒ– |
|------|----------|------|--------|
| `getValues()` | åŸå§‹å‹åˆ¥ï¼ˆDateã€Numberï¼‰ | `[Dateå°è±¡]` | âŒ å¤±æ•— |
| `getDisplayValues()` | æ ¼å¼åŒ–å­—ä¸² | `['2026/1/26 22:00:00']` | âœ… æˆåŠŸ |

### å‰ç«¯è™•ç†å­—ä¸²

ç”±æ–¼ `getDisplayValues()` å›å‚³å­—ä¸²ï¼Œéœ€è¦åœ¨ä½¿ç”¨æ™‚è½‰æ›ï¼š

```javascript
// æ—¥æœŸè½‰æ›
const punchTime = record[RECORD_FIELDS.PUNCH_TIME];  // å­—ä¸²
const date = new Date(punchTime);  // è½‰æ›ç‚º Date ç‰©ä»¶
```

å¹¸é‹çš„æ˜¯ï¼ŒJavaScript çš„ `new Date()` å¯ä»¥æ¥å—å¤šç¨®æ ¼å¼çš„å­—ä¸²è¼¸å…¥ï¼š

```javascript
new Date('2026/1/26 22:00:00')     // âœ… å¯ä»¥
new Date('2026-01-26T22:00:00Z')   // âœ… å¯ä»¥
new Date('2026-01-26 22:00:00')    // âœ… å¯ä»¥
```

## ğŸ“Š æ¸¬è©¦çµæœ

### ä¿®æ­£å‰
```
âŒ å‰ç«¯æ”¶åˆ° null
âŒ TypeError: Cannot read properties of null
```

### ä¿®æ­£å¾Œ
```
âœ… 15 scenarios (15 passed)
âœ… 72 steps (72 passed)
âœ… å‰ç«¯æ­£å¸¸é¡¯ç¤ºè³‡æ–™
```

## ğŸ¯ æœ€ä½³å¯¦è¸

### è¦å‰‡ 1ï¼šå¾Œç«¯çµ±ä¸€ä½¿ç”¨ getDisplayValues()

```javascript
// âœ… æ­£ç¢º
function getData() {
  return sheet.getDataRange().getDisplayValues();
}

// âŒ éŒ¯èª¤
function getData() {
  return sheet.getDataRange().getValues();  // Date ç‰©ä»¶æœƒå‡ºå•é¡Œ
}
```

### è¦å‰‡ 2ï¼šå‰ç«¯è½‰æ›ç‚ºéœ€è¦çš„å‹åˆ¥

```javascript
// å­—ä¸²è½‰ Date
const date = new Date(dateString);

// å­—ä¸²è½‰æ•¸å­—
const number = parseFloat(numberString);
const integer = parseInt(integerString, 10);
```

### è¦å‰‡ 3ï¼šåœ¨æ¸¬è©¦ç’°å¢ƒä¸­æ¨¡æ“¬ç›¸åŒè¡Œç‚º

```javascript
// gas-mock.js
getDisplayValues() {
  return data.map(row => row.map(cell => String(cell)));
}
```

ç¢ºä¿æ¸¬è©¦ç’°å¢ƒå’ŒçœŸå¯¦ç’°å¢ƒçš„è¡Œç‚ºä¸€è‡´ã€‚

## ğŸ”¬ ç›¸é—œçš„ Google Apps Script API

### SpreadsheetApp.Sheet æ–¹æ³•å°ç…§

| æ–¹æ³• | ç”¨é€” | å›å‚³å‹åˆ¥ | Web App é©ç”¨ |
|------|------|----------|--------------|
| `getValues()` | å–å¾—åŸå§‹å€¼ | åŸå§‹å‹åˆ¥ | âŒ |
| `getDisplayValues()` | å–å¾—é¡¯ç¤ºå€¼ | å­—ä¸² | âœ… |
| `getFormulas()` | å–å¾—å…¬å¼ | å­—ä¸² | âœ… |

### å…¶ä»–éœ€æ³¨æ„çš„ç‰©ä»¶

é™¤äº† Date ç‰©ä»¶ï¼Œä»¥ä¸‹ç‰©ä»¶ä¹Ÿä¸èƒ½ç›´æ¥é€é `google.script.run` å‚³éï¼š

- âŒ `Range` ç‰©ä»¶
- âŒ `Sheet` ç‰©ä»¶
- âŒ `Spreadsheet` ç‰©ä»¶
- âŒ `File` ç‰©ä»¶
- âœ… ç´”è³‡æ–™ï¼ˆå­—ä¸²ã€æ•¸å­—ã€é™£åˆ—ã€ç‰©ä»¶ï¼‰

## ğŸ’¡ å»¶ä¼¸é–±è®€

### ç‚ºä»€éº¼æ¸¬è©¦ç’°å¢ƒæ²’ç™¼ç¾é€™å€‹å•é¡Œï¼Ÿ

å› ç‚ºæˆ‘å€‘çš„ Mock ç’°å¢ƒ (`gas-mock.js`) æ­£ç¢ºæ¨¡æ“¬äº†å…©ç¨®æ–¹æ³•çš„è¡Œç‚ºï¼š

```javascript
// gas-mock.js çš„å¯¦ä½œ
getDataRange() {
  return {
    getValues() {
      return data.map(row => row.map(cell => convertToDateIfNeeded(cell)));
    },
    getDisplayValues() {
      return data.map(row => row.map(cell => String(cell)));
    }
  };
}
```

ä½†æ¸¬è©¦ç’°å¢ƒä¸ç¶“é `google.script.run` åºåˆ—åŒ–ï¼Œæ‰€ä»¥ Date ç‰©ä»¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

### å¦‚ä½•ææ—©ç™¼ç¾é€™é¡å•é¡Œï¼Ÿ

1. **é–±è®€å®˜æ–¹æ–‡ä»¶**ï¼šGoogle Apps Script æ–‡ä»¶æœ‰èªªæ˜ç‰©ä»¶åºåˆ—åŒ–çš„é™åˆ¶
2. **E2E æ¸¬è©¦**ï¼šåŒ…å«çœŸå¯¦çš„å‰å¾Œç«¯é€šè¨Šæ¸¬è©¦
3. **æ—©æœŸéƒ¨ç½²æ¸¬è©¦**ï¼šåœ¨é–‹ç™¼æ—©æœŸå°±éƒ¨ç½²åˆ°çœŸå¯¦ç’°å¢ƒæ¸¬è©¦

## ğŸ“š åƒè€ƒè³‡æ–™

- [Google Apps Script - Communicate with Server Functions](https://developers.google.com/apps-script/guides/html/communication)
- [SpreadsheetApp.Range - getValues()](https://developers.google.com/apps-script/reference/spreadsheet/range#getvalues)
- [SpreadsheetApp.Range - getDisplayValues()](https://developers.google.com/apps-script/reference/spreadsheet/range#getdisplayvalues)

---

## ğŸ”¥ å»¶ä¼¸å•é¡Œï¼šä¸­æ–‡æ—¥æœŸæ ¼å¼

### å•é¡Œæè¿°

ä½¿ç”¨ `getDisplayValues()` å¾Œï¼Œåœ¨ç¹é«”ä¸­æ–‡ç’°å¢ƒä¸‹æœƒé‡åˆ°æ–°å•é¡Œï¼š

```javascript
// Google Sheets å›å‚³çš„æ ¼å¼
"2026/1/19 ä¸‹åˆ 4:44:36"

// JavaScript å˜—è©¦è§£æ
new Date("2026/1/19 ä¸‹åˆ 4:44:36")  // âŒ Invalid Date
```

### è§£æ±ºæ–¹æ¡ˆ

å¯¦ä½œ `parseDate()` å‡½å¼ä¾†è™•ç†ä¸­æ–‡æ—¥æœŸæ ¼å¼ï¼š

```javascript
function parseDate(dateInput) {
  // è™•ç†ä¸­æ–‡æ ¼å¼ï¼š2026/1/19 ä¸‹åˆ 4:44:36
  const zhFormat = /^(\d{4})\/(\d{1,2})\/(\d{1,2})\s*(ä¸Šåˆ|ä¸‹åˆ)\s*(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
  const match = String(dateInput).match(zhFormat);
  
  if (match) {
    const year = parseInt(match[1]);
    const month = parseInt(match[2]) - 1;
    const day = parseInt(match[3]);
    const period = match[4]; // ä¸Šåˆ/ä¸‹åˆ
    let hour = parseInt(match[5]);
    
    // è™•ç† 12 å°æ™‚åˆ¶
    if (period === 'ä¸‹åˆ' && hour !== 12) {
      hour += 12;
    } else if (period === 'ä¸Šåˆ' && hour === 12) {
      hour = 0;
    }
    
    return new Date(year, month, day, hour, minute, second);
  }
  
  // å…¶ä»–æ ¼å¼ç”¨æ¨™æº–æ–¹å¼è§£æ
  return new Date(dateInput);
}
```

### isToday() æ™ºèƒ½åˆ¤æ–·

æ ¹æ“šæ—¥æœŸæ ¼å¼è‡ªå‹•é¸æ“‡æ¯”è¼ƒæ–¹å¼ï¼š

```javascript
function isToday(punchTime) {
  const isChineseFormat = punchTime.includes('ä¸Šåˆ') || punchTime.includes('ä¸‹åˆ');
  
  if (isChineseFormat) {
    // ä¸­æ–‡æ ¼å¼ï¼šä½¿ç”¨æœ¬åœ°æ—¥æœŸæ¯”è¼ƒ
    return time.getFullYear() === today.getFullYear() && ...
  } else {
    // ISO æ ¼å¼ï¼šä½¿ç”¨ UTC æ—¥æœŸæ¯”è¼ƒ
    return time.getUTCFullYear() === today.getUTCFullYear() && ...
  }
}
```

---

## ğŸ‰ ç¸½çµ

é€éä½¿ç”¨è€…çš„ç²¾æº–è¨ºæ–·ï¼Œæˆ‘å€‘ç™¼ç¾äº†å…©å€‹é—œéµå•é¡Œï¼š

1. âœ… Date ç‰©ä»¶ç„¡æ³•åºåˆ—åŒ– â†’ ä½¿ç”¨ `getDisplayValues()`
2. âœ… ä¸­æ–‡æ—¥æœŸæ ¼å¼ç„¡æ³•è§£æ â†’ å¯¦ä½œ `parseDate()` å‡½å¼
3. âœ… æ™ºèƒ½åˆ¤æ–·æ ¼å¼ â†’ `isToday()` è‡ªå‹•é¸æ“‡æ¯”è¼ƒæ–¹å¼
4. âœ… åŒæ™‚æ”¯æ´æ¸¬è©¦ç’°å¢ƒï¼ˆISOï¼‰å’ŒçœŸå¯¦ç’°å¢ƒï¼ˆä¸­æ–‡ï¼‰

### æœ€ä½³å¯¦è¸

åœ¨ Google Apps Script Web App ä¸­è™•ç†æ—¥æœŸï¼š

```javascript
// âœ… å¾Œç«¯ï¼šä½¿ç”¨ getDisplayValues()
const data = sheet.getDataRange().getDisplayValues();

// âœ… å¾Œç«¯ï¼šä½¿ç”¨ parseDate() è§£æä¸­æ–‡æ—¥æœŸæ ¼å¼
const date = parseDate(dateString);

// âœ… å‰ç«¯ï¼šä¹Ÿéœ€è¦å¯¦ä½œ parseDate() ä¾†è§£æä¸­æ–‡æ—¥æœŸæ ¼å¼
function parseDate(dateStr) {
  // è™•ç†ä¸­æ–‡æ ¼å¼ï¼š2026/1/19 ä¸‹åˆ 4:44:36
  const zhFormat = /^(\d{4})\/(\d{1,2})\/(\d{1,2})\s*(ä¸Šåˆ|ä¸‹åˆ)\s*(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
  const match = String(dateStr).match(zhFormat);
  
  if (match) {
    // è§£æä¸¦è½‰æ›ç‚º Date ç‰©ä»¶
    // ...
  }
  
  return new Date(dateStr);
}

// âœ… å‰ç«¯ï¼šæ¥æ”¶å­—ä¸²ï¼Œç”¨ parseDate() è§£æå¾Œå†æ ¼å¼åŒ–é¡¯ç¤º
const time = parseDate(dateString);
const displayTime = time.toLocaleTimeString('zh-TW', { 
  hour: '2-digit', 
  minute: '2-digit',
  second: '2-digit'
});
```

### ç¸½çµ

1. âœ… Date ç‰©ä»¶ç„¡æ³•åºåˆ—åŒ– â†’ ä½¿ç”¨ `getDisplayValues()`
2. âœ… ä¸­æ–‡æ—¥æœŸæ ¼å¼ç„¡æ³•è§£æ â†’ **å‰å¾Œç«¯éƒ½è¦å¯¦ä½œ** `parseDate()` å‡½å¼
3. âœ… æ™ºèƒ½åˆ¤æ–·æ ¼å¼ â†’ `isToday()` è‡ªå‹•é¸æ“‡æ¯”è¼ƒæ–¹å¼
4. âœ… åŒæ™‚æ”¯æ´æ¸¬è©¦ç’°å¢ƒï¼ˆISOï¼‰å’ŒçœŸå¯¦ç’°å¢ƒï¼ˆä¸­æ–‡ï¼‰

**åŠŸå‹æ­¸æ–¼ä½¿ç”¨è€…çš„ç´°å¿ƒè§€å¯Ÿå’Œå®Œæ•´è¨ºæ–·ï¼** ğŸŠ
