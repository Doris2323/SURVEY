# 02 - 紅燈階段

## 目標

讓測試失敗，確認測試能夠正確偵測到問題。

## TDD 紅燈原則

在 TDD 中，**紅燈**代表測試失敗。這個階段的目標是：
1. 確認測試邏輯正確
2. 確認測試能偵測到缺失的功能
3. **不要**實作讓測試通過的程式碼

## Cucumber.js 紅燈狀態

### 1. Pending（待實作）

```javascript
When('我執行某個動作', function() {
  return 'pending';
});
```

執行結果：
```
? 我執行某個動作
    Pending
```

**用途**：標記步驟定義已建立，但尚未實作

### 2. Undefined（未定義）

Feature 中有步驟，但沒有對應的 Step Definition。

執行結果：
```
? 我執行某個動作
    Undefined. Implement with the following snippet:

    When('我執行某個動作', function () {
      return 'pending';
    });
```

**用途**：提示需要建立新的步驟定義

### 3. Failed（失敗）

```javascript
When('我執行打卡', function() {
  // ReferenceError: punch is not defined
  const result = ctx.punch('上班');
});

Then('應該有記錄', function() {
  // AssertionError: 0 !== 1
  assert.strictEqual(count, 1);
});
```

執行結果：
```
✖ 我執行打卡
    ReferenceError: punch is not defined

✖ 應該有記錄
    AssertionError [ERR_ASSERTION]: 0 !== 1
```

**用途**：確認測試邏輯正確，等待實作

## 執行測試

```bash
# 執行所有測試
npm test

# 執行特定 Feature
npm test -- features/打卡記錄.feature

# 執行特定場景（使用標籤）
npm test -- --tags @wip
```

## 紅燈階段要做的事

### ✅ 要做

1. **建立 Step Definitions 檔案**
   ```javascript
   // features/step_definitions/打卡記錄.steps.js
   import { Given, When, Then, Before } from '@cucumber/cucumber';
   ```

2. **設定測試上下文（Before hook）**
   ```javascript
   Before(function() {
     ctx = loadGasCodeForTesting({
       sheets: {
         '打卡記錄': ['ID', '類型', '時間', '建立時間']
       }
     });
   });
   ```

3. **寫入斷言邏輯**
   ```javascript
   Then('工作表應該有 {int} 筆記錄', function(count) {
     const sheet = ctx._getSheet('打卡記錄');
     const data = sheet._getData();
     assert.strictEqual(data.length - 1, count);
   });
   ```

4. **呼叫尚未實作的函式**
   ```javascript
   When('我執行「{word}」打卡', function(type) {
     // 這會產生 ReferenceError，因為 punch 還沒實作
     this.result = ctx.punch(type);
   });
   ```

### ❌ 不要做

1. **不要實作 Apps Script 函式**
   - `src/程式碼.js` 應該保持空的或最小化

2. **不要讓測試通過**
   - 如果測試通過了，代表測試寫得不對

3. **不要跳過失敗的測試**
   - 失敗是預期的，不要加 `@skip`

## 預期結果

執行 `npm test` 後應該看到：

```
Feature: 打卡記錄

  Scenario: 新增上班打卡
    ✔ Given 系統已準備好「打卡記錄」工作表
    ✖ When 我執行「上班」打卡
        ReferenceError: ctx.punch is not defined
    - Then 工作表應該有 1 筆記錄
    - And 最新記錄的類型應該是「上班」

1 scenario (1 failed)
4 steps (1 failed, 2 skipped, 1 passed)
```

## ⚠️ 驗證測試的有效性

### 測試應該能捕捉的錯誤

在紅燈階段，確認測試能捕捉以下類型的錯誤：

#### 1. HTML 檔案缺失

```bash
# 預期錯誤
AssertionError: 頁面應包含標題 "打卡系統"，但在 HTML 中找不到
HTML Content: <!-- ERROR: HTML file not found: Index -->
```

**為什麼重要？** 如果測試沒有實際讀取 HTML 檔案，無法捕捉「檔案不存在」的錯誤。

#### 2. 日期過濾未實作

```bash
# 場景：昨天的記錄今天不應該出現
Given 已有一筆打卡記錄：類型「IN」時間「2026/1/26上午9:00:00」  # 昨天
When 我查詢今日打卡記錄
Then 記錄應該有 0 筆

# 預期錯誤（如果未實作 createdAt 過濾）
AssertionError: 記錄數應為 0（今天沒有記錄），實際為 1（包含昨天的）
```

**為什麼重要？** 確保「今日記錄」基於 `createdAt` 欄位，而非「時間」欄位。

#### 3. 記錄順序錯誤

```bash
# 場景：記錄應該倒序（最新在上）
Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
And 已有一筆打卡記錄：類型「OUT」時間「2026/1/27下午6:00:00」
When 我查詢今日打卡記錄
Then 第 1 筆記錄的類型應該是「OUT」  # 最新的

# 預期錯誤（如果未實作倒序）
AssertionError: 第 1 筆記錄應為 OUT（最新），實際為 IN（最舊）
```

**為什麼重要？** 確保記錄以「最新在上」的順序顯示。

#### 4. 假斷言 (False Positive)

```javascript
// ❌ Bad: 永遠會通過
Then('頁面應該顯示錯誤訊息', function() {
  assert.ok(true, '應該有錯誤訊息');  // 假斷言！
});

// ✅ Good: 真實驗證
Then(/^頁面應該顯示錯誤訊息「(.+)」$/, function(expectedMessage) {
  const actualMessage = this.result.message || '';
  assert.ok(actualMessage.includes(expectedMessage),
    `錯誤訊息應包含 "${expectedMessage}"，實際為 "${actualMessage}"`);
});
```

**為什麼重要？** 假斷言會給你錯誤的信心，實際上沒有測試任何東西。

### 驗證方法：破壞性測試

在進入綠燈前，可以執行破壞性測試來驗證測試的有效性：

```bash
# 1. 移除 HTML 檔案
rm src/Index.html
npm test  # 應該失敗，提示找不到 HTML

# 2. 註解掉日期過濾
# 在 getTodayRecords() 中註解掉 createdAt 判斷
npm test  # 應該失敗，提示記錄數不對

# 3. 移除倒序
# 將 records.reverse() 改為 records
npm test  # 應該失敗（如果有順序測試）
```

**原則：如果破壞實作後測試還是通過，代表測試寫得不對！**

## 常見問題

### Q1: 測試直接通過了怎麼辦？
A: 檢查斷言邏輯是否正確。可能是：
- 斷言條件寫反了
- 初始狀態就滿足條件

### Q2: 出現意外的錯誤怎麼辦？
A: 區分「預期的失敗」和「意外的錯誤」：
- **預期的失敗**：`ReferenceError: xxx is not defined`（函式未實作）
- **意外的錯誤**：`TypeError: Cannot read property...`（程式碼有 bug）

### Q3: Step Definition 對不上 Feature 怎麼辦？
A: 確認：
- 參數類型是否正確（`{word}` vs `{string}`）
- 中文字是否完全一致
- 有沒有多餘的空格

## 下一步

確認測試以預期的方式失敗後，進入 [03-綠燈](./03-綠燈.md) 階段。
