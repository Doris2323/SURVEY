---
name: green-light
description: Implement minimal business logic to make tests pass.
args:
  SPECS_ROOT_DIR: /specs
  FEATURE_SPECS_DIR: ${SPECS_ROOT_DIR}/features
input: Failed tests from red-light phase
output: src/*.js
---

# 03 - 綠燈階段

## 目標

寫出最少的程式碼，讓測試通過。

## ⚠️ 前置條件

**只處理沒有 `@ignore` 標籤的 Feature**

- 帶有 `@ignore` 的 Feature 尚未進入開發流程，會被 `npm test` 跳過
- 在紅燈階段已移除 `@ignore` 的 Feature 才能進入綠燈階段
- 如果目標 Feature 還有 `@ignore`，請先回到 [01-紅燈.md](./01-紅燈.md) 完成前置步驟

## 架構規範

### 1. 一個 Feature = 一個模組

每個後端 Apps Script 函數對應一個獨立的 `.js` 檔案：

```
src/
├── main.js              # Web App 入口 (doGet)
├── addToCart.js         # addToCart() 函數
├── checkout.js          # checkout() 函數
├── getCartItems.js      # getCartItems() 函數
└── utils/
    └── date-utils.js    # 共用工具函式
```

**規則**：
- 檔名 = 函數名稱（例：`addToCart.js` 內含 `addToCart()` 函數）
- 每個模組只有**一個公開函數**
- 私有輔助函數以 `_` 開頭（例：`_validateStock()`）

### 2. 模組範本

```javascript
// src/addToCart.js

/**
 * 加入購物車
 * @param {string} productId - 商品編號
 * @param {number} quantity - 數量
 * @returns {{ success: boolean, message: string }}
 */
function addToCart(productId, quantity) {
  // 實作邏輯
}

// 私有輔助函數（選用）
function _checkInventory(productId) {
  // ...
}
```

### 3. 重用工具函式

`src/utils/` 下提供共用工具，可直接使用（GAS 全域命名空間）：

**date-utils.js**：
- `parseChineseDate(dateInput)` - 解析中文日期格式
- `formatDateZhTW(date)` - 格式化為中文日期
- `isToday(dateInput)` - 判斷是否為今天

```javascript
// 範例：在 checkout.js 中使用
function checkout() {
  const orderTime = formatDateZhTW(new Date());
  // ...
}
```

## Apps Script 開發指引

這是 **Google Apps Script** 專案，你可以自由使用所有 GAS API：

### SpreadsheetApp API

```javascript
// 取得工作表
const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('訂單');

// 讀取資料
const lastRow = sheet.getLastRow();
const data = sheet.getRange(2, 1, lastRow - 1, 4).getValues();
const display = sheet.getRange(2, 1, lastRow - 1, 4).getDisplayValues();

// 寫入資料
sheet.appendRow(['ORD-001', 'iPhone 15', 2, 59800]);

// 範圍操作
const range = sheet.getRange(row, col, numRows, numCols);
range.setValues([['A', 'B'], ['C', 'D']]);
```

### 其他常用 API

```javascript
// 工具
const uuid = Utilities.getUuid();
const formatted = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy/MM/dd');

// Session
const email = Session.getActiveUser().getEmail();

// Logger
Logger.log('Debug message');
```

## ⚠️ 最重要的規則：絕對禁止修改 .feature 檔案

**在整個 BDD 流程中，絕對不能修改 `.feature` 檔案。**

- Feature 檔案是需求規格（Specification），是需求契約
- 綠燈階段應該實作業務邏輯來滿足 Feature 的要求
- **絕對不能**因為實作困難而修改 Feature 檔案
- **絕對不能**因為測試難以通過而簡化 Feature 檔案

**你的職責**：
- ✅ 實作業務邏輯（`src/xxx.js`）
- ✅ 讓測試通過（符合 Feature 的要求）
- ❌ **絕對不能**修改 Feature 檔案
- ❌ **絕對不能**修改 Step Definition 以「繞過」Feature 的要求

## TDD 綠燈原則

在 TDD 中，**綠燈**代表測試通過。這個階段的目標是：
1. 用最少的程式碼讓測試通過
2. 不要過度設計
3. 不要寫測試沒有要求的功能
4. **絕對不修改 Feature 檔案**（實作應該符合需求，而非修改需求）

## 執行策略

```bash
# 開發階段：執行特定 Feature（快速回饋）
npm test -- ${FEATURE_SPECS_DIR}/購物車.feature

# 完成驗證：執行所有測試
npm test
```

## Trial-and-Error 流程

這是一個**迭代**的過程：

```
┌─────────────────────────────────────────────────┐
│                                                 │
│   1. 執行測試 ──→ 看錯誤訊息                    │
│        │                                        │
│        ▼                                        │
│   2. 寫最少的程式碼修正這個錯誤                 │
│        │                                        │
│        ▼                                        │
│   3. 再次執行測試                               │
│        │                                        │
│        ▼                                        │
│   4. 還有錯誤？──→ 是 ──→ 回到步驟 2           │
│        │                                        │
│        ▼ 否                                     │
│   5. 測試通過！                                 │
│                                                 │
└─────────────────────────────────────────────────┘
```

## 範例：實作 addToCart 功能

### 第一次執行

```bash
npm test -- ${FEATURE_SPECS_DIR}/購物車.feature
```

錯誤：
```
ReferenceError: addToCart is not defined
```

### 修正 1：建立模組

```javascript
// src/addToCart.js
function addToCart(productId, quantity) {
  // 最小實作
}
```

### 第二次執行

錯誤：
```
AssertionError: 購物車應該有 1 項商品
Expected: 1
Actual: 0
```

### 修正 2：新增記錄

```javascript
// src/addToCart.js
function addToCart(productId, quantity) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('購物車');

  const createdAt = formatDateZhTW(new Date());

  sheet.appendRow([productId, quantity, createdAt]);

  return { success: true, message: '已加入購物車' };
}
```

### 第三次執行

```
✔ 1 scenario (1 passed)
✔ 4 steps (4 passed)
```

測試通過！

## 最小實作原則

### ✅ 好的做法

```javascript
// src/addToCart.js - 只實作測試要求的功能
function addToCart(productId, quantity) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('購物車');

  const createdAt = formatDateZhTW(new Date());

  sheet.appendRow([productId, quantity, createdAt]);

  return { success: true, message: '已加入購物車' };
}
```

### ❌ 避免的做法

```javascript
// 過度設計：測試沒有要求這些
function addToCart(productId, quantity, options = {}) {
  const {
    sheetName = '購物車',
    userId = Session.getActiveUser().getEmail(),
    validateStock = true,
    maxQuantity = 99
  } = options;

  if (validateStock && !_checkInventory(productId, quantity)) {
    throw new Error('庫存不足');
  }
  // ... 一堆測試沒要求的邏輯
}
```

## 常見錯誤類型

### 1. ReferenceError

```
ReferenceError: xxx is not defined
```

**解法**：建立對應的 `.js` 檔案和函數

### 2. TypeError

```
TypeError: Cannot read property 'xxx' of null
```

**解法**：檢查物件是否存在

### 3. AssertionError

```
AssertionError: Expected 1 to equal 0
```

**解法**：調整實作邏輯

## 完成條件

當你看到以下輸出，代表綠燈階段完成：

```
Feature: 購物車

  Scenario: 加入商品到購物車
    ✔ Given 系統已準備好「購物車」工作表
    ✔ When 我將「iPhone 15」加入購物車
    ✔ Then 加入購物車應該成功
    ✔ And 購物車應該有 1 項商品

1 scenario (1 passed)
4 steps (4 passed)
```

**檢查清單**：
- [ ] `npm test` 全部 passed
- [ ] 沒有 Pending 步驟
- [ ] 沒有 Undefined 步驟
- [ ] 沒有 Skipped 步驟

## 下一步

所有測試通過後，進入 [04-重構](./04-重構.md) 階段。
