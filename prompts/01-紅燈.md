# 任務：撰寫 Step Definitions

## ⚠️ 最重要的規則

### 1. 絕對禁止修改 .feature 檔案

Feature 檔案是需求規格，是契約。**絕對不能**因為測試難以實作而修改 Feature。

### 2. 不要覆蓋現有的 Step Definitions

執行前先檢查：
```bash
ls specs/features/step_definitions/
grep -r "Given\|When\|Then" specs/features/step_definitions/
```

---

## 你需要知道的事

### 1. 測試上下文 `this.ctx`

每個 step 都可以存取 `this.ctx`，提供：

- `this.ctx.SpreadsheetApp` - 標準 GAS API
- `this.ctx._setMockTime(timeString)` - 設定測試用時間
- `this.ctx._setMockEmail(email)` - 設定測試用使用者

### 2. 業務函數（定義在 src/*.js）

透過 `this.ctx` 呼叫你的業務函數，例如：

```javascript
this.ctx.addToCart(productId, qty)   // 加入購物車
this.ctx.checkout()                   // 結帳
this.ctx.getCartItems()               // 取得購物車內容
this.ctx.formatDateZhTW(date)         // 格式化日期
```

### 3. GAS API 用法

使用標準 Google Apps Script 語法：

```javascript
// 取得工作表
const sheet = this.ctx.SpreadsheetApp.getActiveSpreadsheet().getSheetByName('訂單');

// 讀取資料
const display = sheet.getDataRange().getDisplayValues();  // 格式化字串
const values = sheet.getDataRange().getValues();          // 原始值（Date 物件）

// 寫入資料
sheet.appendRow(['ORD-001', 'iPhone 15', 2, 59800]);

// 範圍操作（1-based 索引）
const range = sheet.getRange(2, 1, 3, 4);  // row 2, col 1, 3 rows, 4 cols

// 工具
sheet.getLastRow();
sheet.clear();
```

---

## 撰寫規則

### 基本結構

```javascript
import { Given, When, Then } from '@cucumber/cucumber';
import { strict as assert } from 'assert';

Given(/^系統已準備好"(.+)"工作表$/, function(sheetName) {
  const sheet = this.ctx.SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  assert.ok(sheet, `工作表 "${sheetName}" 應該存在`);
});

When(/^我將"(.+)"加入購物車$/, function(productName) {
  this.result = this.ctx.addToCart(productName);
});

Then('加入購物車應該成功', function() {
  assert.ok(this.result.success);
});

Then(/^購物車應該有 (\d+) 項商品$/, function(expectedCount) {
  const items = this.ctx.getCartItems();
  assert.strictEqual(items.length, parseInt(expectedCount));
});
```

### 重要事項

1. **不要加 Before hook** - `this.ctx` 已由 `specs/features/support/hooks.js` 初始化
2. **用 `this` 傳遞資料** - 例如 `this.result`、`this.order`
3. **用 regex 處理中文參數** - `/^我將"(.+)"加入購物車$/`
4. **用 assert 做斷言** - `assert.strictEqual(actual, expected)`

### 新增工作表

如果 feature 使用新的工作表，需在 `specs/features/support/hooks.js` 註冊：

```javascript
const ctx = loadGasCodeForTesting({
  sheets: {
    '訂單': ['訂單編號', '商品', '數量', '金額', 'createdAt'],
    '庫存': ['商品編號', '名稱', '數量', '單價']
  }
});
```

---

## 測試執行

```bash
# 執行所有測試
npm test

# 執行特定 Feature
npm test -- specs/features/購物車.feature
```

---

## 常見問題

### Q: 測試直接通過了？
檢查斷言邏輯是否正確，可能條件寫反了。

### Q: Step Definition 對不上 Feature？
確認：
- 中文字是否完全一致
- 有沒有多餘的空格
- 參數 regex 是否正確

### Q: 出現 `xxx is not a function`？
業務函數尚未實作，這是正常的紅燈狀態。

---

## 輸出

將完整的 step definitions 存到 `specs/features/step_definitions/[feature-name].steps.js`

---

**最少知識原則**：你只需要 GAS API 知識，不需要了解測試環境如何實作。
