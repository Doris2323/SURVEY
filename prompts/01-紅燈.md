---
name: red-light
description: Create complete Step Definitions from Feature files, producing failing tests.
args:
  SPECS_ROOT_DIR: /specs
  FEATURE_SPECS_DIR: ${SPECS_ROOT_DIR}/features
  ENTITY_SPECS_DIR: ${SPECS_ROOT_DIR}
input: ${FEATURE_SPECS_DIR}/*.feature
output: ${FEATURE_SPECS_DIR}/step_definitions/*.steps.js
---

# ä»»å‹™ï¼šæ’°å¯« Step Definitions

## âš ï¸ æœ€é‡è¦çš„è¦å‰‡

### 1. çµ•å°ç¦æ­¢ä¿®æ”¹ .feature æª”æ¡ˆ

Feature æª”æ¡ˆæ˜¯éœ€æ±‚è¦æ ¼ï¼Œæ˜¯å¥‘ç´„ã€‚**çµ•å°ä¸èƒ½**å› ç‚ºæ¸¬è©¦é›£ä»¥å¯¦ä½œè€Œä¿®æ”¹ Featureã€‚

### 2. ä¸è¦è¦†è“‹ç¾æœ‰çš„ Step Definitions

åŸ·è¡Œå‰å…ˆæª¢æŸ¥ï¼š
```bash
ls ${FEATURE_SPECS_DIR}/step_definitions/
grep -r "Given\|When\|Then" ${FEATURE_SPECS_DIR}/step_definitions/
```

### 3. ç§»é™¤ @ignore æ¨™ç±¤

æ–°çš„ Feature File é è¨­å¸¶æœ‰ `@ignore` æ¨™ç±¤ï¼ˆç”±è¦æ ¼åŒ–éšæ®µç”¢å‡ºï¼‰ã€‚
åœ¨é–‹å§‹æ’°å¯« Step Definitions ä¹‹å‰ï¼Œ**å¿…é ˆå…ˆç§»é™¤ @ignore æ¨™ç±¤**ï¼š

1. é–‹å•Ÿç›®æ¨™ Feature æª”æ¡ˆ
2. åˆªé™¤ç¬¬ä¸€è¡Œçš„ `@ignore`
3. å„²å­˜æª”æ¡ˆ

é€™æ¨£ Cucumber æ‰æœƒåŸ·è¡Œé€™å€‹ Feature çš„æ¸¬è©¦ã€‚

### 4. ç¢ºèª hooks.js å·²é…ç½®æ‰€éœ€çš„å·¥ä½œè¡¨

åœ¨æ’°å¯« Step Definitions ä¹‹å‰ï¼Œå¿…é ˆç¢ºèª `${FEATURE_SPECS_DIR}/support/hooks.js` å·²æ ¹æ“š `${ENTITY_SPECS_DIR}/erm.dbml` é…ç½®å°æ‡‰çš„ sheetsã€‚

#### æ­¥é©Ÿ

1. **è®€å– `${ENTITY_SPECS_DIR}/erm.dbml`**ï¼Œæ‰¾å‡ºæ‰€æœ‰ Table å®šç¾©
2. **å°ç…§ `${FEATURE_SPECS_DIR}/support/hooks.js`**ï¼Œç¢ºèª `sheets` ç‰©ä»¶åŒ…å«æ‰€æœ‰éœ€è¦çš„å·¥ä½œè¡¨
3. **å¦‚æœ‰ç¼ºå°‘çš„å·¥ä½œè¡¨**ï¼Œæ›´æ–° hooks.js çš„ sheets é…ç½®

#### DBML Table åˆ° Sheet çš„å°æ‡‰è¦å‰‡

| DBML Table | Sheet åç¨± | æ¬„ä½ï¼ˆå¾ DBML columns æ¨å°ï¼‰ |
|------------|-----------|---------------------------|
| `trip_plan` | `æ—…éŠè¨ˆç•«` | æ ¹æ“š DBML æ¬„ä½å®šç¾© |
| `accommodation` | `ä½å®¿é¸é …` | æ ¹æ“š DBML æ¬„ä½å®šç¾© |
| `transportation` | `äº¤é€šæ–¹å¼` | æ ¹æ“š DBML æ¬„ä½å®šç¾© |

#### hooks.js é…ç½®ç¯„ä¾‹

```javascript
const ctx = loadGasCodeForTesting({
  sheets: {
    'æ—…éŠè¨ˆç•«': ['name', 'start_date', 'end_date', 'participants', 'budget_limit', 'notes', 'createdAt'],
    'ä½å®¿é¸é …': ['trip_plan_id', 'name', 'location', 'price_per_night', 'nights', 'total_price', 'notes', 'source_url', 'createdAt'],
    'äº¤é€šæ–¹å¼': ['trip_plan_id', 'type', 'origin', 'destination', 'cost', 'createdAt']
  }
});
```

#### âš ï¸ é‡è¦ï¼šåœ¨ Google Sheet ä¸­å»ºç«‹å·¥ä½œè¡¨

hooks.js é…ç½®çš„æ˜¯**æ¸¬è©¦ç’°å¢ƒçš„ Fake Sheet**ã€‚
å¯¦éš›éƒ¨ç½²æ™‚ï¼Œéœ€è¦åœ¨ Google Sheet ä¸­å»ºç«‹å°æ‡‰çš„å·¥ä½œè¡¨ã€‚

##### æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªå‹•å»ºç«‹ Scriptï¼ˆæ¨è–¦ï¼‰

ç•¶ hooks.js æœ‰è®Šå‹•æ™‚ï¼Œè«‹ç”¢ç”Ÿä»¥ä¸‹ Script ä¸¦åœ¨ GAS ä¸­åŸ·è¡Œï¼š

```javascript
/**
 * è‡ªå‹•å»ºç«‹æ‰€æœ‰éœ€è¦çš„å·¥ä½œè¡¨
 * ä½¿ç”¨æ–¹å¼ï¼šåœ¨ Apps Script ç·¨è¼¯å™¨ä¸­åŸ·è¡Œæ­¤å‡½æ•¸
 */
function setupSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // å·¥ä½œè¡¨é…ç½®ï¼ˆèˆ‡ hooks.js åŒæ­¥ï¼‰
  const sheetsConfig = {
    'æ—…éŠè¨ˆç•«': ['name', 'start_date', 'end_date', 'participants', 'budget_limit', 'notes', 'createdAt'],
    'ä½å®¿é¸é …': ['trip_plan_id', 'name', 'location', 'price_per_night', 'nights', 'total_price', 'notes', 'source_url', 'createdAt'],
    'äº¤é€šæ–¹å¼': ['trip_plan_id', 'type', 'origin', 'destination', 'cost', 'createdAt']
  };

  for (const [sheetName, headers] of Object.entries(sheetsConfig)) {
    let sheet = ss.getSheetByName(sheetName);

    if (!sheet) {
      // å»ºç«‹æ–°å·¥ä½œè¡¨
      sheet = ss.insertSheet(sheetName);
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
      Logger.log('âœ… å·²å»ºç«‹å·¥ä½œè¡¨: ' + sheetName);
    } else {
      Logger.log('â„¹ï¸ å·¥ä½œè¡¨å·²å­˜åœ¨: ' + sheetName);
    }
  }

  Logger.log('ğŸ‰ å·¥ä½œè¡¨è¨­å®šå®Œæˆï¼');
}
```

##### ä½¿ç”¨æ­¥é©Ÿ

1. é–‹å•Ÿä½ çš„ Google Spreadsheet
2. é»é¸ã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€
3. è²¼ä¸Šä¸Šæ–¹çš„ `setupSheets()` å‡½æ•¸
4. é»é¸åŸ·è¡ŒæŒ‰éˆ• â–¶ï¸
5. æˆæ¬Šå¾Œå³å¯è‡ªå‹•å»ºç«‹æ‰€æœ‰å·¥ä½œè¡¨

##### æ–¹æ³•äºŒï¼šæ‰‹å‹•å»ºç«‹

1. é–‹å•Ÿä½ çš„ Google Spreadsheet
2. æ–°å¢å·¥ä½œè¡¨ï¼Œåç¨±å¿…é ˆèˆ‡ hooks.js é…ç½®ä¸€è‡´
3. åœ¨ç¬¬ä¸€åˆ—å¡«å…¥æ¨™é¡Œï¼ˆæ¬„ä½åç¨±ï¼‰

---

#### ğŸ”„ ç•¶ hooks.js æœ‰è®Šå‹•æ™‚

å¦‚æœä½ åœ¨ hooks.js æ–°å¢äº†å·¥ä½œè¡¨é…ç½®ï¼š

1. **Claude æœƒè‡ªå‹•ç”¢ç”Ÿ**å°æ‡‰çš„ `setupSheets()` Script
2. Script å…§å®¹æœƒæ ¹æ“š hooks.js çš„ `sheets` é…ç½®è‡ªå‹•åŒæ­¥
3. ç”¨æˆ¶åªéœ€è¤‡è£½ Script åˆ° GAS åŸ·è¡Œå³å¯

##### ğŸ“‹ Claude ç”¢ç”Ÿ Script çš„è¦å‰‡

ç•¶æ›´æ–° hooks.js çš„ sheets é…ç½®æ™‚ï¼ŒClaude æ‡‰è©²ï¼š

1. è®€å– hooks.js ä¸­çš„ sheets é…ç½®
2. ç”¢ç”Ÿå°æ‡‰çš„ `setupSheets()` å‡½æ•¸
3. è¼¸å‡ºå®Œæ•´çš„ Script ä¾›ç”¨æˆ¶è¤‡è£½

**ç¯„ä¾‹è¼¸å‡ºæ ¼å¼**ï¼š

```
ğŸ“Œ hooks.js å·²æ›´æ–°ï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹ Script åœ¨ Google Sheet ä¸­å»ºç«‹å·¥ä½œè¡¨ï¼š

[è²¼ä¸Šå®Œæ•´çš„ setupSheets() ç¨‹å¼ç¢¼]

ä½¿ç”¨æ–¹å¼ï¼š
1. é–‹å•Ÿ Google Spreadsheet â†’ æ“´å……åŠŸèƒ½ â†’ Apps Script
2. è²¼ä¸Šä¸Šæ–¹ç¨‹å¼ç¢¼
3. åŸ·è¡Œ setupSheets()
```

**æé†’ç”¨æˆ¶**ï¼š
> å¦‚æœä½ éœ€è¦æ›´æ–° Google Sheet çš„å·¥ä½œè¡¨çµæ§‹ï¼Œå¯ä»¥ä½¿ç”¨ `setupSheets()` Script å¿«é€Ÿå»ºç«‹ã€‚

---

## ä½ éœ€è¦çŸ¥é“çš„äº‹

### 1. æ¸¬è©¦ä¸Šä¸‹æ–‡ `this.ctx`

æ¯å€‹ step éƒ½å¯ä»¥å­˜å– `this.ctx`ï¼Œæä¾›ï¼š

- `this.ctx.SpreadsheetApp` - æ¨™æº– GAS API
- `this.ctx._setMockTime(timeString)` - è¨­å®šæ¸¬è©¦ç”¨æ™‚é–“
- `this.ctx._setMockEmail(email)` - è¨­å®šæ¸¬è©¦ç”¨ä½¿ç”¨è€…

### 2. æ¥­å‹™å‡½æ•¸ï¼ˆå®šç¾©åœ¨ src/*.jsï¼‰

é€é `this.ctx` å‘¼å«ä½ çš„æ¥­å‹™å‡½æ•¸ï¼Œä¾‹å¦‚ï¼š

```javascript
this.ctx.addToCart(productId, qty)   // åŠ å…¥è³¼ç‰©è»Š
this.ctx.checkout()                   // çµå¸³
this.ctx.getCartItems()               // å–å¾—è³¼ç‰©è»Šå…§å®¹
this.ctx.formatDateZhTW(date)         // æ ¼å¼åŒ–æ—¥æœŸ
```

### 3. GAS API ç”¨æ³•

ä½¿ç”¨æ¨™æº– Google Apps Script èªæ³•ï¼š

```javascript
// å–å¾—å·¥ä½œè¡¨
const sheet = this.ctx.SpreadsheetApp.getActiveSpreadsheet().getSheetByName('è¨‚å–®');

// è®€å–è³‡æ–™
const display = sheet.getDataRange().getDisplayValues();  // æ ¼å¼åŒ–å­—ä¸²
const values = sheet.getDataRange().getValues();          // åŸå§‹å€¼ï¼ˆDate ç‰©ä»¶ï¼‰

// å¯«å…¥è³‡æ–™
sheet.appendRow(['ORD-001', 'iPhone 15', 2, 59800]);

// ç¯„åœæ“ä½œï¼ˆ1-based ç´¢å¼•ï¼‰
const range = sheet.getRange(2, 1, 3, 4);  // row 2, col 1, 3 rows, 4 cols

// å·¥å…·
sheet.getLastRow();
sheet.clear();
```

---

## æ’°å¯«è¦å‰‡

### åŸºæœ¬çµæ§‹

```javascript
import { Given, When, Then } from '@cucumber/cucumber';
import { strict as assert } from 'assert';

Given(/^ç³»çµ±å·²æº–å‚™å¥½"(.+)"å·¥ä½œè¡¨$/, function(sheetName) {
  const sheet = this.ctx.SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  assert.ok(sheet, `å·¥ä½œè¡¨ "${sheetName}" æ‡‰è©²å­˜åœ¨`);
});

When(/^æˆ‘å°‡"(.+)"åŠ å…¥è³¼ç‰©è»Š$/, function(productName) {
  this.result = this.ctx.addToCart(productName);
});

Then('åŠ å…¥è³¼ç‰©è»Šæ‡‰è©²æˆåŠŸ', function() {
  assert.ok(this.result.success);
});

Then(/^è³¼ç‰©è»Šæ‡‰è©²æœ‰ (\d+) é …å•†å“$/, function(expectedCount) {
  const items = this.ctx.getCartItems();
  assert.strictEqual(items.length, parseInt(expectedCount));
});
```

### é‡è¦äº‹é …

1. **ä¸è¦åŠ  Before hook** - `this.ctx` å·²ç”± `${FEATURE_SPECS_DIR}/support/hooks.js` åˆå§‹åŒ–
2. **ç”¨ `this` å‚³éè³‡æ–™** - ä¾‹å¦‚ `this.result`ã€`this.order`
3. **ç”¨ regex è™•ç†ä¸­æ–‡åƒæ•¸** - `/^æˆ‘å°‡"(.+)"åŠ å…¥è³¼ç‰©è»Š$/`
4. **ç”¨ assert åšæ–·è¨€** - `assert.strictEqual(actual, expected)`

### æ–°å¢å·¥ä½œè¡¨

å¦‚æœ feature ä½¿ç”¨æ–°çš„å·¥ä½œè¡¨ï¼Œéœ€åœ¨ `${FEATURE_SPECS_DIR}/support/hooks.js` è¨»å†Šï¼š

```javascript
const ctx = loadGasCodeForTesting({
  sheets: {
    'è¨‚å–®': ['è¨‚å–®ç·¨è™Ÿ', 'å•†å“', 'æ•¸é‡', 'é‡‘é¡', 'createdAt'],
    'åº«å­˜': ['å•†å“ç·¨è™Ÿ', 'åç¨±', 'æ•¸é‡', 'å–®åƒ¹']
  }
});
```

---

## æ¸¬è©¦åŸ·è¡Œ

```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
npm test

# åŸ·è¡Œç‰¹å®š Feature
npm test -- ${FEATURE_SPECS_DIR}/è³¼ç‰©è»Š.feature
```

---

## å¸¸è¦‹å•é¡Œ

### Q: æ¸¬è©¦ç›´æ¥é€šéäº†ï¼Ÿ
æª¢æŸ¥æ–·è¨€é‚è¼¯æ˜¯å¦æ­£ç¢ºï¼Œå¯èƒ½æ¢ä»¶å¯«åäº†ã€‚

### Q: Step Definition å°ä¸ä¸Š Featureï¼Ÿ
ç¢ºèªï¼š
- ä¸­æ–‡å­—æ˜¯å¦å®Œå…¨ä¸€è‡´
- æœ‰æ²’æœ‰å¤šé¤˜çš„ç©ºæ ¼
- åƒæ•¸ regex æ˜¯å¦æ­£ç¢º

### Q: å‡ºç¾ `xxx is not a function`ï¼Ÿ
æ¥­å‹™å‡½æ•¸å°šæœªå¯¦ä½œï¼Œé€™æ˜¯æ­£å¸¸çš„ç´…ç‡ˆç‹€æ…‹ã€‚

---

## è¼¸å‡º

å°‡å®Œæ•´çš„ step definitions å­˜åˆ° `${FEATURE_SPECS_DIR}/step_definitions/[feature-name].steps.js`

---

**æœ€å°‘çŸ¥è­˜åŸå‰‡**ï¼šä½ åªéœ€è¦ GAS API çŸ¥è­˜ï¼Œä¸éœ€è¦äº†è§£æ¸¬è©¦ç’°å¢ƒå¦‚ä½•å¯¦ä½œã€‚
