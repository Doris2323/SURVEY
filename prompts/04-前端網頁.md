# 任務：產生前端網頁

## 快速參考卡

| 項目 | 位置/語法 |
|------|-----------|
| **HTML 檔案** | `src/Index.html` |
| **入口函數** | `src/main.js` → `doGet()` |
| **呼叫後端** | `google.script.run.函數名()` |
| **成功處理** | `.withSuccessHandler(callback)` |
| **失敗處理** | `.withFailureHandler(callback)` |
| **讀取資料** | 後端用 `getDisplayValues()`（非 `getValues()`） |

---

## ⚠️ 最重要的規則

### 1. 檔案位置固定

```
src/
├── main.js           # 入口（doGet）- 可修改
├── Index.html        # 主頁面 ← 你要產生這個
├── *.js              # 業務邏輯模組
└── utils/            # 工具函式
```

**絕對不能**在其他位置建立 HTML 檔案。

### 2. main.js 入口

```javascript
// src/main.js
function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
    .setTitle('應用名稱')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```

- `'Index'` 對應 `src/Index.html`
- 可修改標題或設定

### 3. 根據現有實作產生

```bash
# 查看所有業務函數
ls src/*.js

# 查看 Feature 檔案了解需求
ls features/*.feature
```

---

## GAS 特有模式

### 1. google.script.run 呼叫後端

```javascript
// 基本用法
google.script.run
  .withSuccessHandler(onSuccess)
  .withFailureHandler(onError)
  .後端函數名(參數1, 參數2);

// 回調函數
function onSuccess(result) {
  console.log('成功:', result);
}

function onError(error) {
  console.error('失敗:', error.message);
}
```

### 2. 模板語法（進階）

如需動態注入資料，改用 `createTemplateFromFile`：

```javascript
// src/main.js
function doGet() {
  const template = HtmlService.createTemplateFromFile('Index');
  template.userName = Session.getActiveUser().getEmail();
  template.initialData = getInitialData();  // 後端函數
  return template.evaluate()
    .setTitle('應用名稱')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```

```html
<!-- src/Index.html -->
<p>歡迎, <?= userName ?></p>

<script>
  // 取得後端注入的資料
  const data = <?!= JSON.stringify(initialData) ?>;
  console.log(data);
</script>
```

| 語法 | 用途 |
|------|------|
| `<?= value ?>` | HTML 跳脫輸出（安全） |
| `<?!= value ?>` | 原始輸出（用於 JSON） |

### 3. 引入外部檔案（CSS/JS）

```javascript
// src/main.js
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}
```

```html
<!-- src/Index.html -->
<head>
  <?!= include('styles') ?>  <!-- 引入 src/styles.html -->
</head>
<body>
  <?!= include('scripts') ?> <!-- 引入 src/scripts.html -->
</body>
```

---

## 常見錯誤

### ❌ 錯誤 1：Date 物件無法傳到前端

```javascript
// 後端 - 錯誤
function getRecords() {
  return sheet.getDataRange().getValues();  // Date 物件
  // 前端收到 null！
}

// 後端 - 正確
function getRecords() {
  return sheet.getDataRange().getDisplayValues();  // 字串
  // 前端正常收到
}
```

### ❌ 錯誤 2：忘記處理錯誤

```javascript
// 錯誤 - 沒有 withFailureHandler
google.script.run
  .withSuccessHandler(onSuccess)
  .doSomething();  // 如果失敗，使用者看不到任何回饋

// 正確 - 一定要加
google.script.run
  .withSuccessHandler(onSuccess)
  .withFailureHandler(onError)  // 加這行！
  .doSomething();
```

### ❌ 錯誤 3：HTML 放錯位置

```
❌ /Index.html          # 根目錄 - 錯誤
❌ /public/Index.html   # public 目錄 - 錯誤
❌ /web/Index.html      # web 目錄 - 錯誤
✅ /src/Index.html      # src 目錄 - 正確
```

### ❌ 錯誤 4：使用 ES6 語法

GAS 前端支援有限，避免：

```javascript
// ❌ 避免
const fn = () => {};
const { a, b } = obj;
`template ${string}`;

// ✅ 改用
var fn = function() {};
var a = obj.a;
'string ' + value;
```

### ❌ 錯誤 5：同步呼叫後端

```javascript
// ❌ 錯誤 - google.script.run 是非同步的
var result = google.script.run.getData();  // result 是 undefined！

// ✅ 正確 - 使用回調
google.script.run
  .withSuccessHandler(function(result) {
    // 在這裡使用 result
  })
  .getData();
```

---

## 基本 HTML 結構

```html
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>應用名稱</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: sans-serif; padding: 20px; }
    .btn { padding: 10px 20px; cursor: pointer; }
    .loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <h1>應用標題</h1>

  <div id="content">
    <!-- 動態內容 -->
  </div>

  <script>
    // 頁面載入時
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
    });

    // 載入資料
    function loadData() {
      google.script.run
        .withSuccessHandler(displayData)
        .withFailureHandler(showError)
        .getData();
    }

    function displayData(data) {
      var container = document.getElementById('content');
      container.innerHTML = JSON.stringify(data);
    }

    function showError(error) {
      alert('錯誤: ' + error.message);
    }
  </script>
</body>
</html>
```

---

## 檢查清單

- [ ] HTML 檔案放在 `src/Index.html`
- [ ] 使用 `google.script.run` 呼叫後端
- [ ] 每個呼叫都有 `withSuccessHandler` 和 `withFailureHandler`
- [ ] 後端資料用 `getDisplayValues()`（不是 `getValues()`）
- [ ] 沒有使用 ES6 語法（箭頭函數、解構、模板字串）
- [ ] 響應式設計（手機也能用）
- [ ] 有 loading 狀態和錯誤訊息

---

## 輸出

將 HTML 檔案存到 `src/Index.html`

---

**記住**：前端是後端的「使用者」，根據後端 API 來設計 UI。
