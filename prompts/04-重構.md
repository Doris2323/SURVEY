# 04 - é‡æ§‹éšŽæ®µ

## ç›®æ¨™

åœ¨æ¸¬è©¦ä¿è­·ä¸‹ï¼Œæ”¹å–„ç¨‹å¼ç¢¼å“è³ªã€‚

## TDD é‡æ§‹åŽŸå‰‡

åœ¨ TDD ä¸­ï¼Œ**é‡æ§‹**æ˜¯åœ¨ä¸æ”¹è®Šç¨‹å¼è¡Œç‚ºçš„å‰æä¸‹ï¼Œæ”¹å–„ç¨‹å¼ç¢¼çµæ§‹ã€‚

é‡æ§‹çš„å‰æï¼š
1. æ‰€æœ‰æ¸¬è©¦å¿…é ˆé€šéŽï¼ˆç¶ ç‡ˆï¼‰
2. æ¯æ¬¡å°æ”¹å‹•å¾Œéƒ½è¦åŸ·è¡Œæ¸¬è©¦
3. æ¸¬è©¦å¤±æ•—å°±å›žé€€

## é‡æ§‹æ™‚æ©Ÿ

### âœ… é©åˆé‡æ§‹

- é‡è¤‡çš„ç¨‹å¼ç¢¼
- éŽé•·çš„å‡½å¼
- é­”è¡“æ•¸å­—ï¼ˆMagic Numbersï¼‰
- å‘½åä¸æ¸…æ¥š

### âŒ ä¸é©åˆé‡æ§‹

- æ¸¬è©¦é‚„æ²’é€šéŽ
- è¶•æ™‚é–“äº¤ä»˜
- æ²’æœ‰æ¸¬è©¦ä¿è­·

## å¸¸è¦‹é‡æ§‹æŠ€å·§

### 1. æŠ½å–å¸¸æ•¸

```javascript
// Before
function punch(type) {
  const sheet = getSheet('æ‰“å¡è¨˜éŒ„');
  // ...
}

// After
const SHEET_NAME = 'æ‰“å¡è¨˜éŒ„';

function punch(type) {
  const sheet = getSheet(SHEET_NAME);
  // ...
}
```

### 2. æŠ½å–è¼”åŠ©å‡½å¼

```javascript
// Before
function punch(type) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('æ‰“å¡è¨˜éŒ„');
  if (!sheet) {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    sheet = ss.insertSheet('æ‰“å¡è¨˜éŒ„');
    sheet.appendRow(['ID', 'é¡žåž‹', 'æ™‚é–“', 'å»ºç«‹æ™‚é–“']);
  }
  // ...
}

// After
function getSheet(name) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.appendRow(['ID', 'é¡žåž‹', 'æ™‚é–“', 'å»ºç«‹æ™‚é–“']);
  }
  return sheet;
}

function punch(type) {
  const sheet = getSheet(SHEET_NAME);
  // ...
}
```

### 3. æ”¹å–„å‘½å

```javascript
// Before
function p(t) {
  const s = getSheet(SHEET_NAME);
  const d = new Date();
  s.appendRow([Utilities.getUuid(), t, d, d]);
}

// After
function punch(type) {
  const sheet = getSheet(SHEET_NAME);
  const now = new Date();
  const record = createRecord(type, now);
  sheet.appendRow(recordToRow(record));
}
```

### 4. çµæ§‹åŒ–è³‡æ–™

```javascript
// Before
sheet.appendRow([uuid, type, time, time]);

// After
function createRecord(type, time) {
  return {
    id: Utilities.getUuid(),
    type: type,
    time: formatDateTime(time),
    createdAt: formatDateTime(time)
  };
}

function recordToRow(record) {
  return [record.id, record.type, record.time, record.createdAt];
}
```

## é‡æ§‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                 â”‚
â”‚   1. ç¢ºèªæ¸¬è©¦å…¨éƒ¨é€šéŽï¼ˆç¶ ç‡ˆï¼‰                   â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   2. åšä¸€å€‹å°æ”¹å‹•                               â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   3. åŸ·è¡Œæ¸¬è©¦                                   â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   4. æ¸¬è©¦é€šéŽï¼Ÿ                                 â”‚
â”‚        â”‚                                        â”‚
â”‚        â”œâ”€â”€ æ˜¯ â”€â”€â†’ å›žåˆ°æ­¥é©Ÿ 2ï¼ˆç¹¼çºŒé‡æ§‹ï¼‰        â”‚
â”‚        â”‚                                        â”‚
â”‚        â””â”€â”€ å¦ â”€â”€â†’ å›žé€€æ”¹å‹•ï¼Œå›žåˆ°æ­¥é©Ÿ 2          â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸŽ¯ åŸºæ–¼å°ˆæ¡ˆçš„é‡æ§‹å»ºè­°

### 1. æŠ½å–æ¬„ä½ç´¢å¼•å¸¸æ•¸

```javascript
// âœ… æŽ¨è–¦ï¼šä½¿ç”¨å‘½åå¸¸æ•¸
const COLUMN = {
  UUID: 0,
  TYPE: 1,
  TIME: 2,
  CREATED_AT: 3
};

function getTodayRecords() {
  // ...
  const type = row[COLUMN.TYPE];        // æ¸…æ¥š
  const createdAt = row[COLUMN.CREATED_AT];  // æ¸…æ¥š
}

// âŒ é¿å…ï¼šé­”è¡“æ•¸å­—
function getTodayRecords() {
  const type = row[1];        // 1 æ˜¯ä»€éº¼ï¼Ÿ
  const createdAt = row[3];   // 3 æ˜¯ä»€éº¼ï¼Ÿ
}
```

### 2. æŠ½å–æ‰“å¡é¡žåž‹å¸¸æ•¸

```javascript
// âœ… æŽ¨è–¦
const PUNCH_TYPE = {
  IN: 'IN',
  OUT: 'OUT'
};

if (type === PUNCH_TYPE.IN) {
  // ...
}

// âŒ é¿å…ï¼šå­—ä¸²å­—é¢å€¼
if (type === 'IN') {  // å®¹æ˜“æ‰“éŒ¯
  // ...
}
```

### 3. æŠ½å–æ—¥æœŸåˆ¤æ–·é‚è¼¯

```javascript
// âœ… æŽ¨è–¦ï¼šè¼”åŠ©å‡½å¼
function getTodayDateRange() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  return { today, tomorrow };
}

function isToday(createdAtISO) {
  const { today, tomorrow } = getTodayDateRange();
  const createdAt = new Date(createdAtISO);
  return createdAt >= today && createdAt < tomorrow;
}

function getTodayRecords() {
  // ...
  if (isToday(row[COLUMN.CREATED_AT])) {
    records.push(...);
  }
}

// âŒ é¿å…ï¼šé‡è¤‡çš„æ—¥æœŸé‚è¼¯
function getTodayRecords() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  // ... åœ¨æ¯å€‹å‡½å¼éƒ½é‡è¤‡
}

function getTodayWorkHours() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  // ... é‡è¤‡çš„é‚è¼¯
}
```

### 4. æŠ½å–é©—è­‰é‚è¼¯

```javascript
// âœ… æŽ¨è–¦
function validatePunchType(type, lastType) {
  if (type === PUNCH_TYPE.OUT && lastType !== PUNCH_TYPE.IN) {
    return { valid: false, message: 'è«‹å…ˆå®Œæˆ IN æ‰“å¡' };
  }
  if (type === PUNCH_TYPE.IN && lastType === PUNCH_TYPE.IN) {
    return { valid: false, message: 'è«‹å…ˆå®Œæˆ OUT æ‰“å¡' };
  }
  return { valid: true };
}

function punch(type) {
  const validation = validatePunchType(type, lastType);
  if (!validation.valid) {
    return { success: false, message: validation.message };
  }
  // ...
}

// âŒ é¿å…ï¼šé©—è­‰é‚è¼¯æ•£è½å„è™•
function punch(type) {
  if (type === 'OUT' && lastType !== 'IN') {
    return { success: false, message: 'è«‹å…ˆå®Œæˆ IN æ‰“å¡' };
  }
  if (type === 'IN' && lastType === 'IN') {
    return { success: false, message: 'è«‹å…ˆå®Œæˆ OUT æ‰“å¡' };
  }
  // ... å¾ˆé•·çš„å‡½å¼
}
```

### 5. æŠ½å–å·¥ä½œè¡¨æ“ä½œ

```javascript
// âœ… æŽ¨è–¦
function getSheet() {
  return SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName(SHEET_NAME);
}

function getAllRows() {
  return getSheet().getDataRange().getValues();
}

function getLastRecord(rows) {
  if (rows.length <= 1) return null;
  const lastRow = rows[rows.length - 1];
  return {
    type: lastRow[COLUMN.TYPE],
    time: lastRow[COLUMN.TIME]
  };
}

// âŒ é¿å…ï¼šé‡è¤‡çš„å·¥ä½œè¡¨æ“ä½œ
function punch(type) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('æ‰“å¡è¨˜éŒ„');
  const rows = sheet.getDataRange().getValues();
  // ...
}

function getTodayRecords() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('æ‰“å¡è¨˜éŒ„');
  const rows = sheet.getDataRange().getValues();
  // ... é‡è¤‡çš„ç¨‹å¼ç¢¼
}
```

## é‡æ§‹æª¢æŸ¥æ¸…å–®

- [ ] æŠ½å–å¸¸æ•¸ï¼ˆé¿å…é­”è¡“æ•¸å­—/å­—ä¸²ï¼‰
- [ ] æŠ½å–è¼”åŠ©å‡½å¼ï¼ˆé¿å…é‡è¤‡ç¨‹å¼ç¢¼ï¼‰
- [ ] æ”¹å–„å‘½åï¼ˆæ¸…æ¥šè¡¨é”æ„åœ–ï¼‰
- [ ] çµæ§‹åŒ–è³‡æ–™ï¼ˆä½¿ç”¨ç‰©ä»¶è€Œéžé™£åˆ—ï¼‰
- [ ] æ¯æ¬¡æ”¹å‹•å¾Œæ¸¬è©¦éƒ½é€šéŽ
- [ ] **createdAt æ—¥æœŸåˆ¤æ–·é‚è¼¯å·²æŠ½å–**
- [ ] **æ¬„ä½ç´¢å¼•ä½¿ç”¨å¸¸æ•¸è€Œéžæ•¸å­—**
- [ ] **æ‰“å¡é¡žåž‹ä½¿ç”¨å¸¸æ•¸è€Œéžå­—ä¸²**

## å®Œæˆæ¢ä»¶

```bash
npm test
```

```
15 scenarios (15 passed)
77 steps (77 passed)
```

ç¨‹å¼ç¢¼ç¬¦åˆä»¥ä¸‹æ¨™æº–ï¼š
- [ ] æ²’æœ‰é‡è¤‡çš„ç¨‹å¼ç¢¼
- [ ] å‡½å¼é•·åº¦é©ä¸­ï¼ˆ<20 è¡Œï¼‰
- [ ] å‘½åæ¸…æ¥š
- [ ] å¸¸æ•¸å·²æŠ½å–
- [ ] æ‰€æœ‰æ¸¬è©¦é€šéŽ

## ä¸‹ä¸€æ­¥

é‡æ§‹å®Œæˆå¾Œï¼Œå¯ä»¥ï¼š
1. æäº¤ç¨‹å¼ç¢¼ï¼ˆ`git commit`ï¼‰
2. æŽ¨é€åˆ° Apps Scriptï¼ˆ`clasp push`ï¼‰
3. éƒ¨ç½² Web App æ¸¬è©¦
4. é–‹å§‹ä¸‹ä¸€å€‹ TDD å¾ªç’°
