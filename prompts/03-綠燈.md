# 03 - ç¶ ç‡ˆéšæ®µ

## ç›®æ¨™

å¯«å‡ºæœ€å°‘çš„ç¨‹å¼ç¢¼ï¼Œè®“æ¸¬è©¦é€šéã€‚

## TDD ç¶ ç‡ˆåŸå‰‡

åœ¨ TDD ä¸­ï¼Œ**ç¶ ç‡ˆ**ä»£è¡¨æ¸¬è©¦é€šéã€‚é€™å€‹éšæ®µçš„ç›®æ¨™æ˜¯ï¼š
1. ç”¨æœ€å°‘çš„ç¨‹å¼ç¢¼è®“æ¸¬è©¦é€šé
2. ä¸è¦éåº¦è¨­è¨ˆ
3. ä¸è¦å¯«æ¸¬è©¦æ²’æœ‰è¦æ±‚çš„åŠŸèƒ½

## åŸ·è¡Œç­–ç•¥

```bash
# é–‹ç™¼éšæ®µï¼šåŸ·è¡Œç‰¹å®š Featureï¼ˆå¿«é€Ÿå›é¥‹ï¼‰
npm test -- features/æ‰“å¡è¨˜éŒ„.feature

# å®Œæˆé©—è­‰ï¼šåŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
npm test
```

## Trial-and-Error æµç¨‹

é€™æ˜¯ä¸€å€‹**è¿­ä»£**çš„éç¨‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                 â”‚
â”‚   1. åŸ·è¡Œæ¸¬è©¦ â”€â”€â†’ çœ‹éŒ¯èª¤è¨Šæ¯                    â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   2. å¯«æœ€å°‘çš„ç¨‹å¼ç¢¼ä¿®æ­£é€™å€‹éŒ¯èª¤                 â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   3. å†æ¬¡åŸ·è¡Œæ¸¬è©¦                               â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼                                        â”‚
â”‚   4. é‚„æœ‰éŒ¯èª¤ï¼Ÿâ”€â”€â†’ æ˜¯ â”€â”€â†’ å›åˆ°æ­¥é©Ÿ 2           â”‚
â”‚        â”‚                                        â”‚
â”‚        â–¼ å¦                                     â”‚
â”‚   5. æ¸¬è©¦é€šéï¼                                 â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç¯„ä¾‹ï¼šå¯¦ä½œæ‰“å¡åŠŸèƒ½

### ç¬¬ä¸€æ¬¡åŸ·è¡Œ

```bash
npm test -- features/æ‰“å¡è¨˜éŒ„.feature
```

éŒ¯èª¤ï¼š
```
ReferenceError: ctx.punch is not defined
```

### ä¿®æ­£ 1ï¼šå»ºç«‹å‡½å¼

```javascript
// src/ç¨‹å¼ç¢¼.js
function punch(type) {
  // æœ€å°å¯¦ä½œï¼šä»€éº¼éƒ½ä¸åš
}
```

### ç¬¬äºŒæ¬¡åŸ·è¡Œ

éŒ¯èª¤ï¼š
```
AssertionError: å·¥ä½œè¡¨æ‡‰è©²æœ‰ 1 ç­†è¨˜éŒ„
Expected: 1
Actual: 0
```

### ä¿®æ­£ 2ï¼šæ–°å¢è¨˜éŒ„

```javascript
// src/ç¨‹å¼ç¢¼.js
function punch(type) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('æ‰“å¡è¨˜éŒ„');
  sheet.appendRow([type]);
}
```

### ç¬¬ä¸‰æ¬¡åŸ·è¡Œ

éŒ¯èª¤ï¼š
```
AssertionError: æœ€æ–°è¨˜éŒ„çš„é¡å‹æ‡‰è©²æ˜¯ã€Œä¸Šç­ã€
Expected: 'ä¸Šç­'
Actual: undefined
```

### ä¿®æ­£ 3ï¼šèª¿æ•´æ¬„ä½ä½ç½®

```javascript
// src/ç¨‹å¼ç¢¼.js
function punch(type) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('æ‰“å¡è¨˜éŒ„');
  const id = Utilities.getUuid();
  const time = new Date();
  sheet.appendRow([id, type, time, time]);
}
```

### ç¬¬å››æ¬¡åŸ·è¡Œ

```
âœ” 1 scenario (1 passed)
âœ” 4 steps (4 passed)
```

æ¸¬è©¦é€šéï¼

## æœ€å°å¯¦ä½œåŸå‰‡

### âœ… å¥½çš„åšæ³•

```javascript
// åªå¯¦ä½œæ¸¬è©¦è¦æ±‚çš„åŠŸèƒ½
function punch(type) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('æ‰“å¡è¨˜éŒ„');
  sheet.appendRow([Utilities.getUuid(), type, new Date(), new Date()]);
}
```

### âŒ é¿å…çš„åšæ³•

```javascript
// éåº¦è¨­è¨ˆï¼šæ¸¬è©¦æ²’æœ‰è¦æ±‚é€™äº›
function punch(type, options = {}) {
  const {
    sheetName = 'æ‰“å¡è¨˜éŒ„',
    userId = Session.getActiveUser().getEmail(),
    customTime = null,
    validateType = true
  } = options;

  if (validateType && !['ä¸Šç­', 'ä¸‹ç­'].includes(type)) {
    throw new Error('ç„¡æ•ˆçš„æ‰“å¡é¡å‹');
  }

  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName(sheetName);

  // æª¢æŸ¥æ˜¯å¦é‡è¤‡æ‰“å¡
  const data = sheet.getDataRange().getValues();
  // ... ä¸€å †æ¸¬è©¦æ²’è¦æ±‚çš„é‚è¼¯
}
```

## å¸¸è¦‹éŒ¯èª¤é¡å‹

### 1. ReferenceError

```
ReferenceError: xxx is not defined
```

**è§£æ³•**ï¼šå»ºç«‹å‡½å¼æˆ–è®Šæ•¸

### 2. TypeError

```
TypeError: Cannot read property 'xxx' of null
```

**è§£æ³•**ï¼šæª¢æŸ¥ç‰©ä»¶æ˜¯å¦å­˜åœ¨

### 3. AssertionError

```
AssertionError: Expected 1 to equal 0
```

**è§£æ³•**ï¼šèª¿æ•´å¯¦ä½œé‚è¼¯

## å®Œæˆæ¢ä»¶

ç•¶ä½ çœ‹åˆ°ä»¥ä¸‹è¼¸å‡ºï¼Œä»£è¡¨ç¶ ç‡ˆéšæ®µå®Œæˆï¼š

```
Feature: æ‰“å¡è¨˜éŒ„

  Scenario: æ–°å¢ä¸Šç­æ‰“å¡
    âœ” Given ç³»çµ±å·²æº–å‚™å¥½ã€Œæ‰“å¡è¨˜éŒ„ã€å·¥ä½œè¡¨
    âœ” When æˆ‘åŸ·è¡Œã€Œä¸Šç­ã€æ‰“å¡
    âœ” Then å·¥ä½œè¡¨æ‡‰è©²æœ‰ 1 ç­†è¨˜éŒ„
    âœ” And æœ€æ–°è¨˜éŒ„çš„é¡å‹æ‡‰è©²æ˜¯ã€Œä¸Šç­ã€

1 scenario (1 passed)
4 steps (4 passed)
```

**æª¢æŸ¥æ¸…å–®**ï¼š
- [ ] `npm test` å…¨éƒ¨ passed
- [ ] æ²’æœ‰ Pending æ­¥é©Ÿ
- [ ] æ²’æœ‰ Undefined æ­¥é©Ÿ
- [ ] æ²’æœ‰ Skipped æ­¥é©Ÿ

## ğŸ¯ é—œéµå¯¦ä½œæŒ‡å¼•

åŸºæ–¼æ¾„æ¸…æ±ºç­–ï¼Œå¯¦ä½œæ™‚éœ€æ³¨æ„ï¼š

### 1. createdAt æ¬„ä½ï¼ˆæ™‚é–“åˆ¤æ–·ï¼‰

```javascript
// âœ… æ­£ç¢ºï¼šä½¿ç”¨ createdAt åˆ¤æ–·ç•¶å¤©
function getTodayRecords() {
  const sheet = getSheet();
  const allRows = sheet.getDataRange().getValues();
  
  // å–å¾—ä»Šæ—¥æ—¥æœŸç¯„åœï¼ˆ00:00:00 - 23:59:59ï¼‰
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  
  const records = [];
  for (let i = 1; i < allRows.length; i++) {
    const createdAtISO = allRows[i][3]; // createdAt æ¬„ä½
    const createdAt = new Date(createdAtISO);
    
    // æ ¹æ“š createdAt åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å¤©
    if (createdAt >= today && createdAt < tomorrow) {
      records.push({
        'é¡å‹': allRows[i][1],
        'æ™‚é–“': allRows[i][2]
      });
    }
  }
  
  return records;
}

// âŒ éŒ¯èª¤ï¼šä½¿ç”¨ã€Œæ™‚é–“ã€æ¬„ä½åˆ¤æ–·ï¼ˆå¯èƒ½è¢«ä¿®æ”¹ï¼‰
function getTodayRecords() {
  // ä¸è¦ä½¿ç”¨ row[2] ä¾†åˆ¤æ–·æ—¥æœŸï¼
}
```

### 2. è¨˜éŒ„å€’åºï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰

```javascript
// âœ… æ­£ç¢ºï¼šè¿”å›å€’åºè¨˜éŒ„
function getTodayRecords() {
  // ... éæ¿¾é‚è¼¯ ...
  return records.reverse();  // æœ€æ–°è¨˜éŒ„åœ¨ç¬¬ä¸€å€‹
}

// âŒ éŒ¯èª¤ï¼šè¿”å›æ­£åº
function getTodayRecords() {
  return records;  // æ¸¬è©¦æœƒå¤±æ•—
}
```

### 3. HTML å¯¦ä½œè¦æ±‚

ç•¶å¯¦ä½œ `doGet()` æ™‚ï¼Œç¢ºä¿ HTML åŒ…å«å¿…è¦å…ƒç´ ï¼š

```javascript
// src/ç¨‹å¼ç¢¼.js
function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
    .setTitle('æ‰“å¡ç³»çµ±');
}
```

```html
<!-- src/Index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>æ‰“å¡ç³»çµ±</title>
</head>
<body>
  <h1>æ‰“å¡ç³»çµ±</h1>
  
  <!-- âš ï¸ å¿…é ˆï¼šå›ºå®šçš„è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
  <div id="message"></div>
  
  <button id="btn-in">IN ä¸Šç­</button>
  <button id="btn-out">OUT ä¸‹ç­</button>
</body>
</html>
```

### 4. æ¸¬è©¦éš”é›¢ç¢ºèª

å¦‚æœæ¸¬è©¦å¤±æ•—æç¤ºã€Œè¨˜éŒ„æ•¸ä¸å°ã€ï¼Œæª¢æŸ¥ï¼š

```javascript
// Before hook æ‡‰è©²æ¸…ç©ºå·¥ä½œè¡¨
Before(function() {
  ctx = loadGasCodeForTesting({ ... });
  
  // âš ï¸ ç¢ºä¿æ¯å€‹ Scenario å‰æ¸…ç©º
  const sheet = ctx.SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('æ‰“å¡è¨˜éŒ„');
  sheet.clear();
  sheet.appendRow(['UUID', 'é¡å‹', 'æ™‚é–“', 'createdAt']);
  
  this.ctx = ctx;
});
```

## å¤šå€‹å ´æ™¯çš„è™•ç†

å¦‚æœ Feature æœ‰å¤šå€‹å ´æ™¯ï¼Œé€ä¸€è™•ç†ï¼š

```gherkin
åŠŸèƒ½: æ‰“å¡è¨˜éŒ„

  å ´æ™¯: æ–°å¢ä¸Šç­æ‰“å¡    # â† å…ˆå®Œæˆé€™å€‹
    ...

  å ´æ™¯: æ–°å¢ä¸‹ç­æ‰“å¡    # â† å†è™•ç†é€™å€‹
    ...

  å ´æ™¯: æŸ¥è©¢æ‰“å¡è¨˜éŒ„    # â† æœ€å¾Œè™•ç†é€™å€‹
    ...
```

## ä¸‹ä¸€æ­¥

æ‰€æœ‰æ¸¬è©¦é€šéå¾Œï¼Œé€²å…¥ [04-é‡æ§‹](./04-é‡æ§‹.md) éšæ®µã€‚
