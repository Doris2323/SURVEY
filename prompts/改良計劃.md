# Apps Script BDD Workshop 改良計劃

## 目標
將 `教育訓練/Apps script/workshop_clock_in/` 的測試架構和 prompts 改良成**通用版本**，可以用在任何 Apps Script 專案的 AI X BDD 開發。

## 設計決策
- **Loader 設計**：設定檔模式（傳入 config 物件指定導出函式）
- **Prompt 語言**：中文
- **範例處理**：保留打卡專案作為參考範例
- **初始化工具**：建立 `specify init` CLI 工具

---

## 一、建立 `specify init` 初始化工具

在 `教育訓練/Apps script/workshop_clock_in` 建立 CLI 工具，讓學員可以快速初始化 Apps Script BDD 專案。

### 使用方式
```bash
# 在專案目錄執行
npx specify init

# 或
npm run specify init
```

### 初始化功能
`specify init` 會：
1. 建立目錄結構
2. 產生設定檔
3. 複製通用的 mock 和 loader
4. 建立範例 Feature 檔案

### 產生的結構
```
my-gas-project/
├── package.json              # 包含 cucumber.js 等依賴
├── cucumber.js               # Cucumber 設定
├── specify.config.js         # Specify 設定檔（指定導出函式、工作表等）
├── features/
│   ├── example.feature       # 範例 Feature
│   └── step_definitions/
│       └── example.steps.js  # 範例步驟定義
├── lib/
│   ├── gas-mock.js           # 通用 Mock（從模板複製）
│   └── gas-loader.js         # 通用 Loader（從模板複製）
├── src/
│   └── 程式碼.js              # Apps Script 主程式（空模板）
└── prompts/
    ├── 01-Feature-to-測試樣板.md
    ├── 02-紅燈.md
    ├── 03-綠燈.md
    └── 04-重構.md
```

### specify.config.js 設定檔
```javascript
export default {
  // Apps Script 程式碼路徑
  codePath: 'src/程式碼.js',

  // 要導出的函式名稱（測試時可用）
  exports: [
    // 'myFunction',
    // 'anotherFunction',
  ],

  // 初始工作表設定（可選）
  sheets: {
    // '工作表名稱': ['欄位1', '欄位2', '欄位3']
  }
};
```

### CLI 實作
```
bin/
└── specify.js               # CLI 入口
```

---

## 二、需要改良的檔案

### 1. Mock 基礎設施（通用化）

#### `lib/gas-mock.js`
**問題**：
- `createMockSheet()` 標題列寫死為 `['ID', '類型', '時間', '建立時間']`
- `createMockGoogleScriptRun()` 只有 `punch()` 和 `getRecordsForWeb()` 方法

**改良**：
```javascript
// 改成可設定標題列，或不預設
export function createMockSheet(headers = []) {
  let data = headers.length > 0 ? [headers] : [];
  // ...
}

// 改成動態代理，可呼叫任何後端函式
export function createMockGoogleScriptRun(gasContext) {
  return {
    withSuccessHandler(handler) { /* ... */ },
    withFailureHandler(handler) { /* ... */ },
    // 使用 Proxy 動態處理任何函式呼叫
  };
}
```

#### `lib/gas-loader.js`
**問題**：
- 第 57-70 行：導出函式名稱寫死
- 第 76 行：工作表名稱寫死為 `'打卡記錄'`

**改良**：
```javascript
// 改成接受設定參數
export function loadGasCodeForTesting(config = {}) {
  const {
    codePath = 'src/程式碼.js',
    exports = [],        // 要導出的函式/常數名稱
    sheetName = null,    // 初始工作表名稱（可選）
    sheetHeaders = []    // 初始標題列（可選）
  } = config;
  // ...
}
```

---

### 2. Prompts（適配 Apps Script + Cucumber.js）

現有 prompts 是為 **Python/FastAPI + PostgreSQL** 設計的，需要改成 **Apps Script + Cucumber.js**。

#### `prompts/01-Feature-to-測試樣板.md`
- 從 Gherkin → Cucumber.js step definitions 樣板
- 識別需要 mock 的 Apps Script API
- 使用 `Given/When/Then` 步驟定義

#### `prompts/02-紅燈.md`
- 測試失敗原因改為：Pending/Undefined Step 或 ReferenceError
- 不是 HTTP 404
- 使用 `npm test` 執行

#### `prompts/03-綠燈.md`
- 使用 `npm test` 執行 Cucumber.js
- Trial-and-Error 流程適用於 Apps Script
- 最小增量實作原則

#### `prompts/04-重構.md`
- 適用於 Apps Script 架構模式（Entry Points / Core Functions / Helpers）
- 不是 Controller/Service/Repository

#### `prompts/架構決策文件.md`
- 記錄 Apps Script BDD 測試架構的決策
- Mock 策略、測試組織方式

---

## 三、實作步驟

### Step 1: 建立 specify CLI 工具
1. 建立 `bin/specify.js` CLI 入口
2. 建立 `templates/` 目錄存放模板檔案
3. 實作 `init` 命令邏輯

### Step 2: 建立通用模板
1. `templates/gas-mock.js` - 通用 Mock（標題列可設定、Proxy 動態代理）
2. `templates/gas-loader.js` - 通用 Loader（讀取 specify.config.js）
3. `templates/specify.config.js` - 設定檔模板
4. `templates/cucumber.js` - Cucumber 設定
5. `templates/example.feature` - 範例 Feature
6. `templates/example.steps.js` - 範例 Step Definitions

### Step 3: 改寫 prompts（中文）
1. `prompts/架構決策文件.md` - 架構 ADR
2. `prompts/01-Feature-to-測試樣板.md` - Gherkin → Step Definitions
3. `prompts/02-紅燈.md` - Cucumber.js 紅燈階段
4. `prompts/03-綠燈.md` - npm test + Trial-and-Error
5. `prompts/04-重構.md` - Apps Script 架構重構

### Step 4: 更新 package.json
加入 specify CLI 的 bin 設定

---

## 四、關鍵檔案

| 檔案 | 用途 |
|------|------|
| `bin/specify.js` | CLI 入口 |
| `templates/gas-mock.js` | 通用 Mock 模板 |
| `templates/gas-loader.js` | 通用 Loader 模板 |
| `templates/specify.config.js` | 設定檔模板 |
| `prompts/*.md` | TDD prompts |

---

## 五、驗證方式

```bash
# 1. 測試 specify init
cd /tmp && mkdir test-project && cd test-project
npx /path/to/workshop_clock_in/bin/specify.js init

# 2. 確認產生的結構
ls -la

# 3. 執行測試
npm install
npm test

# 4. 預期結果：範例測試通過
```

---

## 六、Prompts 詳細設計

### 01-Feature-to-測試樣板.md

**Role**：從 Gherkin Feature File 生成 Cucumber.js step definitions 樣板

**輸入**：
- Feature File（Gherkin 格式）
- gas-mock.js（可用的 mock API）
- src/*.js（Apps Script 原始碼）

**輸出**：
```javascript
import { Given, When, Then, Before } from '@cucumber/cucumber';
import { strict as assert } from 'assert';
import { loadGasCodeForTesting } from '../../lib/gas-loader.js';

let ctx;

Before(function() {
  ctx = loadGasCodeForTesting({
    exports: ['函式1', '函式2'],
    sheetName: '工作表名稱',
    sheetHeaders: ['欄位1', '欄位2']
  });
});

Given('{語句}', function() {
  // [Mock 策略: 需要 mock 的 API]
  // TODO: 實作
});
```

**Mock 識別規則**：
- 「工作表」「記錄」→ SpreadsheetApp, Sheet
- 「時間」「日期」→ Utilities.formatDate
- 「頁面」「按鈕」(@e2e) → google.script.run, HtmlService

---

### 02-紅燈.md

**目標**：生成會失敗的測試

**Cucumber.js 紅燈狀態**：
1. **Pending**：`return 'pending';`
2. **Undefined**：步驟定義不存在
3. **Failed**：ReferenceError 或斷言失敗

**要做**：
- 建立 step definitions 檔案
- 設定測試上下文（Before hook）
- 寫入斷言邏輯

**不要做**：
- 不實作 Apps Script 函式
- 不讓測試通過

**預期**：`npm test` 顯示失敗

---

### 03-綠燈.md

**目標**：讓測試通過

**執行策略**：
```bash
# 開發階段：執行特定 Feature
npm test -- features/xxx.feature

# 完成驗證：執行所有測試
npm test
```

**流程**：
1. 執行測試 → 看錯誤
2. 寫最少的程式碼修正
3. 再次執行測試
4. 循環直到通過

**完成條件**：
- `npm test` 全部 passed
- 沒有 Pending 或 Undefined

---

### 04-重構.md

**Apps Script 架構模式**：
- Entry Points：`doGet()`, `doPost()`, `onOpen()`
- Core Functions：業務邏輯函式
- Helper Functions：輔助工具函式
- Constants：常數定義

**重構方向**：
- 函式職責單一化
- 常數提取
- Early Return
- JSDoc 註解

---

### 架構決策文件.md

記錄以下決策：
- ADR-001: 選擇 Cucumber.js 作為 BDD 框架
- ADR-002: 使用 Node.js VM 沙箱執行 Apps Script
- ADR-003: Mock 策略
- ADR-004: Feature 檔案組織方式
- ADR-005: 測試上下文管理
