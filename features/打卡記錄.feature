# language: en
Feature: 打卡記錄
  作為一個員工
  我想要記錄上下班打卡時間
  以便追蹤我的工作時數

  Background:
    Given 系統已準備好「打卡記錄」工作表

  # ========== 前置條件 - 參數驗證 ==========

  Rule: 前置條件 - 必須先有 IN 記錄才能打 OUT（否則失敗）

    Example: 未上班就下班應失敗
      Given 今日無打卡記錄
      When 我打卡「OUT」
      Then 打卡結果應該失敗
      And 錯誤訊息應包含「請先完成 IN 打卡」

  Rule: 前置條件 - 必須先有 OUT 記錄才能再打 IN（否則失敗）

    Example: 連續上班打卡應失敗
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      When 我打卡「IN」
      Then 打卡結果應該失敗
      And 錯誤訊息應包含「請先完成 OUT 打卡」

  # ========== 前置條件 - 狀態驗證 ==========

  Rule: 前置條件 - 打卡時間必須與前一筆不同（否則失敗）

    Example: 不能在相同時間打卡
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      When 我在「2026/1/27上午9:00:00」打卡「OUT」
      Then 打卡結果應該失敗
      And 錯誤訊息應包含「打卡時間不能相同」

  Rule: 前置條件 - OUT 時間必須晚於同日 IN 時間（否則失敗）

    Example: 同日下班時間不能早於上班時間
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27下午2:00:00」
      When 我在「2026/1/27上午9:00:00」打卡「OUT」
      Then 打卡結果應該失敗
      And 錯誤訊息應包含「OUT 時間不能早於 IN 時間」

  # ========== 後置條件 ==========

  Rule: 後置條件 - 無記錄時打 IN 應新增一筆 IN 記錄

    Example: 新增上班打卡記錄
      When 我在「2026/1/27上午9:00:00」打卡「IN」
      Then 打卡結果應該成功
      And 工作表應該有 1 筆記錄
      And 最新記錄的類型應該是「IN」
      And 最新記錄的時間應該是「2026/1/27上午9:00:00」

  Rule: 後置條件 - 完成一輪 IN/OUT 後可再打 IN

    Example: 完成一輪打卡後再次上班打卡
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      And 已有一筆打卡記錄：類型「OUT」時間「2026/1/27下午12:00:00」
      When 我在「2026/1/27下午1:00:00」打卡「IN」
      Then 打卡結果應該成功
      And 工作表應該有 3 筆記錄

  Rule: 後置條件 - 有 IN 記錄時打 OUT 應新增一筆 OUT 記錄

    Example: 新增下班打卡記錄
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      When 我在「2026/1/27下午6:00:00」打卡「OUT」
      Then 打卡結果應該成功
      And 工作表應該有 2 筆記錄
      And 最新記錄的類型應該是「OUT」
      And 最新記錄的時間應該是「2026/1/27下午6:00:00」

  Rule: 後置條件 - 查詢今日記錄應回傳所有今日打卡資料
  
  # 📋 澄清決策 (2026-01-27):
  # - 「今日記錄」基於 createdAt 欄位判斷（不是「時間」欄位）
  # - 原因：防止時間欄位被手動修改而造成資料不一致
  # - 跨日場景：昨天創建的記錄今天不會顯示

    Example: 查詢今日打卡記錄
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      And 已有一筆打卡記錄：類型「OUT」時間「2026/1/27下午6:00:00」
      When 我查詢今日打卡記錄
      Then 記錄應該包含：
        | 類型 | 時間                  |
        | IN   | 2026/1/27上午9:00:00  |
        | OUT  | 2026/1/27下午6:00:00  |

    Example: 時間欄位應為可解析的字串格式
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      When 我查詢今日打卡記錄
      Then 第 1 筆記錄的時間應該是文字格式「2026/1/27上午9:00:00」
      And 時間欄位應可用於字串比對

  Rule: 後置條件 - 工時應為所有 IN/OUT 配對的時間差總和

    Scenario Outline: 計算今日工時
      Given 已有一筆打卡記錄：類型「IN」時間「<上班時間>」
      And 已有一筆打卡記錄：類型「OUT」時間「<下班時間>」
      When 我查詢今日工時
      Then 工時應該是 <預期分鐘數> 分鐘

      Examples: 標準工時
        | 上班時間              | 下班時間              | 預期分鐘數 |
        | 2026/1/27上午9:00:00  | 2026/1/27下午6:00:00  | 540        |
        | 2026/1/27上午9:00:00  | 2026/1/27下午12:00:00 | 180        |
        | 2026/1/27上午8:30:00  | 2026/1/27下午5:30:00  | 540        |

      Examples: 短時工作
        | 上班時間              | 下班時間               | 預期分鐘數 |
        | 2026/1/27上午9:00:00  | 2026/1/27上午11:00:00  | 120        |
        | 2026/1/27下午2:00:00  | 2026/1/27下午4:30:00   | 150        |

      Examples: 跨夜加班
        | 上班時間               | 下班時間              | 預期分鐘數 |
        | 2026/1/27下午10:00:00  | 2026/1/28上午2:00:00  | 240        |

  Rule: 後置條件 - 網頁 API 應回傳完整資訊（記錄、工時、按鈕狀態）

    Example: API 回傳無記錄時的狀態
      When 我呼叫網頁 API
      Then API 應該回傳成功
      And API 記錄應該有 0 筆
      And API 工時應該是 0 分鐘
      And API 狀態應該是：
        | canPunchIn  | true  |
        | canPunchOut | false |

    Example: API 回傳有 IN 記錄時的狀態
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      When 我呼叫網頁 API
      Then API 應該回傳成功
      And API 記錄應該包含：
        | 類型 | 時間                  |
        | IN   | 2026/1/27上午9:00:00  |
      And API 工時應該是 0 分鐘
      And API 狀態應該是：
        | canPunchIn  | false |
        | canPunchOut | true  |

    Example: API 回傳完整 IN/OUT 配對記錄
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      And 已有一筆打卡記錄：類型「OUT」時間「2026/1/27下午6:00:00」
      When 我呼叫網頁 API
      Then API 應該回傳成功
      And API 記錄應該包含：
        | 類型 | 時間                  |
        | IN   | 2026/1/27上午9:00:00  |
        | OUT  | 2026/1/27下午6:00:00  |
      And API 工時應該是 540 分鐘
      And API 狀態應該是：
        | canPunchIn  | true  |
        | canPunchOut | false |

    Example: API 回傳多輪 IN/OUT 記錄
      Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
      And 已有一筆打卡記錄：類型「OUT」時間「2026/1/27下午12:00:00」
      And 已有一筆打卡記錄：類型「IN」時間「2026/1/27下午1:00:00」
      And 已有一筆打卡記錄：類型「OUT」時間「2026/1/27下午6:00:00」
      When 我呼叫網頁 API
      Then API 應該回傳成功
      And API 記錄應該包含：
        | 類型 | 時間                   |
        | IN   | 2026/1/27上午9:00:00   |
        | OUT  | 2026/1/27下午12:00:00  |
        | IN   | 2026/1/27下午1:00:00   |
        | OUT  | 2026/1/27下午6:00:00   |
      And API 工時應該是 480 分鐘
      And API 狀態應該是：
        | canPunchIn  | true  |
        | canPunchOut | false |
