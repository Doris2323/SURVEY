# Apps Script BDD æ¸¬è©¦æ¶æ§‹æ±ºç­–æ–‡ä»¶

## æ¦‚è¿°

æœ¬æ–‡ä»¶è¨˜éŒ„ Apps Script BDD æ¸¬è©¦æ¶æ§‹çš„é—œéµæŠ€è¡“æ±ºç­–ã€‚

---

## ADR-001: é¸æ“‡ Cucumber.js ä½œç‚º BDD æ¡†æ¶

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
éœ€è¦ä¸€å€‹æ”¯æ´ Gherkin èªæ³•çš„ BDD æ¸¬è©¦æ¡†æ¶ï¼Œè®“éæŠ€è¡“äººå“¡ä¹Ÿèƒ½ç†è§£æ¸¬è©¦æ¡ˆä¾‹ã€‚

### æ±ºç­–
ä½¿ç”¨ Cucumber.js ä½œç‚º BDD æ¸¬è©¦æ¡†æ¶ã€‚

### ç†ç”±
- æ”¯æ´ä¸­æ–‡ Gherkin èªæ³•ï¼ˆåŠŸèƒ½ã€å ´æ™¯ã€å‡è¨­ã€ç•¶ã€é‚£éº¼ï¼‰
- èˆ‡ Node.js ç”Ÿæ…‹ç³»æ•´åˆè‰¯å¥½
- ç¤¾ç¾¤æ´»èºï¼Œæ–‡ä»¶å®Œæ•´
- æ”¯æ´ Before/After hooks é€²è¡Œæ¸¬è©¦å‰å¾Œè™•ç†

### å¾Œæœ
- å­¸å“¡éœ€è¦å­¸ç¿’ Gherkin èªæ³•
- éœ€è¦æ’°å¯« Step Definitions å°æ‡‰ Feature æª”æ¡ˆ

---

## ADR-002: ä½¿ç”¨ Node.js VM æ²™ç®±åŸ·è¡Œ Apps Script

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
Apps Script ç¨‹å¼ç¢¼æ˜¯è¨­è¨ˆåœ¨ Google ç’°å¢ƒåŸ·è¡Œçš„ï¼Œç„¡æ³•ç›´æ¥åœ¨æœ¬åœ° Node.js ç’°å¢ƒåŸ·è¡Œã€‚

### æ±ºç­–
ä½¿ç”¨ Node.js å…§å»ºçš„ `vm` æ¨¡çµ„å»ºç«‹æ²™ç®±ç’°å¢ƒï¼Œæ³¨å…¥ Mock çš„ Google APIã€‚

### ç†ç”±
- ä¸éœ€è¦é¡å¤–çš„è½‰è­¯å·¥å…·
- å¯ä»¥ç²¾ç¢ºæ§åˆ¶æ²™ç®±ä¸­å¯ç”¨çš„ API
- åŸ·è¡Œé€Ÿåº¦å¿«
- ç¨‹å¼ç¢¼ä¸éœ€è¦ä¿®æ”¹å³å¯æ¸¬è©¦

### å¾Œæœ
- éœ€è¦ Mock æ‰€æœ‰ç”¨åˆ°çš„ Google API
- æŸäº› Node.js åŸç”ŸåŠŸèƒ½ï¼ˆå¦‚ requireï¼‰åœ¨æ²™ç®±ä¸­ä¸å¯ç”¨
- éœ€è¦è™•ç†å…¨åŸŸè®Šæ•¸çš„å°å‡º

### å¯¦ä½œ
```javascript
import vm from 'vm';

const sandbox = {
  SpreadsheetApp,  // Mock
  Utilities,       // Mock
  // ... å…¶ä»– Mock API
};

const context = vm.createContext(sandbox);
vm.runInContext(gasCode, context);
```

---

## ADR-003: Mock ç­–ç•¥

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
éœ€è¦æ¨¡æ“¬ Google Apps Script æä¾›çš„å„ç¨® APIã€‚

### æ±ºç­–
å»ºç«‹ä¸€å¥—å¯é…ç½®çš„ Mock ç‰©ä»¶ï¼Œæ¨¡æ“¬å¸¸ç”¨çš„ Google APIã€‚

### Mock æ¸…å–®
| Mock ç‰©ä»¶ | æ¨¡æ“¬ç›®æ¨™ | ç”¨é€” |
|-----------|----------|------|
| `createMockSpreadsheet()` | Spreadsheet | è©¦ç®—è¡¨æ“ä½œ |
| `createMockSheet()` | Sheet | å·¥ä½œè¡¨æ“ä½œ |
| `createMockSpreadsheetApp()` | SpreadsheetApp | å…¨åŸŸ API |
| `createMockUtilities()` | Utilities | å·¥å…·å‡½å¼ |
| `createMockSession()` | Session | ä½¿ç”¨è€…è³‡è¨Š |
| `createMockHtmlService()` | HtmlService | HTML è¼¸å‡º |
| `createMockContentService()` | ContentService | å…§å®¹è¼¸å‡º |
| `createMockPropertiesService()` | PropertiesService | å±¬æ€§å„²å­˜ |
| `createMockLogger()` | Logger | æ—¥èªŒè¨˜éŒ„ |
| `createMockGoogleScriptRun()` | google.script.run | å‰ç«¯å‘¼å«å¾Œç«¯ |

### è¨­è¨ˆåŸå‰‡
1. **å¯é…ç½®**ï¼šæ¨™é¡Œåˆ—ã€åˆå§‹è³‡æ–™ç­‰å¯é€éåƒæ•¸è¨­å®š
2. **æ¸¬è©¦å‹å–„**ï¼šæä¾› `_` é–‹é ­çš„æ¸¬è©¦è¼”åŠ©æ–¹æ³•ï¼ˆå¦‚ `_getData()`ï¼‰
3. **å‹•æ…‹ä»£ç†**ï¼šä½¿ç”¨ Proxy è™•ç†æœªé æœŸçš„æ–¹æ³•å‘¼å«
4. **æ¨¡æ“¬çœŸå¯¦è¡Œç‚º**ï¼šåºåˆ—åŒ–é™åˆ¶ç­‰é‚Šç•Œæƒ…æ³ä¹Ÿè¦æ¨¡æ“¬

### ç‰¹æ®Š Mock è¡Œç‚º

#### getValues() vs getDisplayValues()
```javascript
// getValues() æœƒå°‡æ—¥æœŸæ™‚é–“å­—ä¸²è½‰ç‚º Date ç‰©ä»¶ï¼ˆæ¨¡æ“¬çœŸå¯¦ GASï¼‰
sheet.getDataRange().getValues()
// â†’ [['id', 'IN', Date Object, Date Object]]

// getDisplayValues() å›å‚³å­—ä¸²ï¼ˆå®‰å…¨ï¼‰
sheet.getDataRange().getDisplayValues()
// â†’ [['id', 'IN', '2026-01-21 12:00:00', '2026-01-21 12:00:00']]
```

#### google.script.run åºåˆ—åŒ–æª¢æŸ¥
Mock æœƒæª¢æŸ¥å›å‚³å€¼æ˜¯å¦åŒ…å«ç„¡æ³•åºåˆ—åŒ–çš„å…§å®¹ï¼š

```javascript
// é è¨­æ¨¡å¼ï¼šæ¨¡æ“¬çœŸå¯¦è¡Œç‚ºï¼ˆå›å‚³ null + console è­¦å‘Šï¼‰
createMockGoogleScriptRun(gasContext)

// åš´æ ¼æ¨¡å¼ï¼šæ‹‹å‡ºéŒ¯èª¤è®“æ¸¬è©¦å¤±æ•—ï¼ˆæ¨è–¦ç”¨æ–¼é–‹ç™¼ï¼‰
createMockGoogleScriptRun(gasContext, { strictMode: true })
```

æª¢æŸ¥é …ç›®ï¼š
- `Date` ç‰©ä»¶ â†’ å»ºè­°ä½¿ç”¨ `getDisplayValues()`
- `NaN` â†’ å»ºè­°åŠ å…¥ `isNaN()` æª¢æŸ¥

---

## ADR-004: Feature æª”æ¡ˆçµ„ç¹”æ–¹å¼

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
éœ€è¦æ±ºå®šå¦‚ä½•çµ„ç¹” Feature æª”æ¡ˆå’Œ Step Definitionsã€‚

### æ±ºç­–
```
features/
â”œâ”€â”€ åŠŸèƒ½A.feature          # æ¥­å‹™åŠŸèƒ½ Feature
â”œâ”€â”€ åŠŸèƒ½B.feature
â”œâ”€â”€ é é¢æµç¨‹.feature       # E2E æ¸¬è©¦ï¼ˆ@e2e æ¨™ç±¤ï¼‰
â””â”€â”€ step_definitions/
    â”œâ”€â”€ åŠŸèƒ½A.steps.js     # å°æ‡‰çš„æ­¥é©Ÿå®šç¾©
    â”œâ”€â”€ åŠŸèƒ½B.steps.js
    â””â”€â”€ common.steps.js    # å…±ç”¨æ­¥é©Ÿ
```

### ç†ç”±
- Feature æª”æ¡ˆæŒ‰æ¥­å‹™åŠŸèƒ½åˆ†é¡
- Step Definitions èˆ‡ Feature ä¸€å°ä¸€å°æ‡‰
- å…±ç”¨æ­¥é©Ÿæ”¾åœ¨ common.steps.js

### æ¨™ç±¤ä½¿ç”¨
- `@e2e`ï¼šéœ€è¦å‰ç«¯äº’å‹•çš„æ¸¬è©¦
- `@wip`ï¼šé–‹ç™¼ä¸­çš„æ¸¬è©¦
- `@skip`ï¼šæš«æ™‚è·³éçš„æ¸¬è©¦

---

## ADR-005: æ¸¬è©¦ä¸Šä¸‹æ–‡ç®¡ç†

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
æ¯å€‹æ¸¬è©¦å ´æ™¯éœ€è¦ç¨ç«‹çš„æ¸¬è©¦ç’°å¢ƒï¼Œé¿å…æ¸¬è©¦ä¹‹é–“äº’ç›¸å½±éŸ¿ã€‚

### æ±ºç­–
ä½¿ç”¨ Cucumber.js çš„ `Before` hookï¼Œåœ¨æ¯å€‹å ´æ™¯å‰é‡æ–°è¼‰å…¥æ¸¬è©¦ç’°å¢ƒã€‚

### å¯¦ä½œ
```javascript
import { Before } from '@cucumber/cucumber';
import { loadGasCodeForTesting } from '../../lib/gas-loader.js';

let ctx;

Before(function() {
  ctx = loadGasCodeForTesting({
    sheets: {
      'å·¥ä½œè¡¨åç¨±': ['æ¬„ä½1', 'æ¬„ä½2', 'æ¬„ä½3']
    }
  });
});
```

### ç†ç”±
- æ¯å€‹å ´æ™¯æœ‰ä¹¾æ·¨çš„åˆå§‹ç‹€æ…‹
- Mock ç‰©ä»¶åœ¨å ´æ™¯é–“ä¸æœƒç´¯ç©é«’è³‡æ–™
- å¯ä»¥é‡å°ä¸åŒå ´æ™¯è¨­å®šä¸åŒçš„åˆå§‹ç‹€æ…‹

---

## ADR-006: è¨­å®šæª”è¨­è¨ˆ

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
éœ€è¦ä¸€å€‹æ–¹å¼è®“ä½¿ç”¨è€…é…ç½®æ¸¬è©¦ç’°å¢ƒã€‚

### æ±ºç­–
ä½¿ç”¨ `specify.config.js` ä½œç‚ºè¨­å®šæª”ã€‚

### è¨­å®šé …ç›®
```javascript
export default {
  // Apps Script åŸå§‹ç¢¼ç›®éŒ„
  srcDir: 'src',

  // è¦å°å‡ºçš„å‡½å¼åç¨±ï¼ˆå¯é¸ï¼Œä¸æŒ‡å®šå‰‡è‡ªå‹•åµæ¸¬ï¼‰
  exports: ['myFunction'],

  // åˆå§‹å·¥ä½œè¡¨è¨­å®š
  sheets: {
    'å·¥ä½œè¡¨åç¨±': ['æ¬„ä½1', 'æ¬„ä½2']
  }
};
```

### ç†ç”±
- JavaScript æ ¼å¼ï¼Œå¯ä»¥åŒ…å«å‹•æ…‹é‚è¼¯
- ES Module æ ¼å¼ï¼Œèˆ‡å°ˆæ¡ˆä¸€è‡´
- æ˜ç¢ºçš„è¨­å®šé …ç›®ï¼Œæ˜“æ–¼ç†è§£

---

## ADR-007: google.script.run åºåˆ—åŒ–é™åˆ¶

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
Web App é€é `google.script.run` å‘¼å«å¾Œç«¯å‡½å¼æ™‚ï¼Œå›å‚³å€¼å¿…é ˆèƒ½è¢«åºåˆ—åŒ–ç‚º JSONã€‚

### å•é¡Œ
ä»¥ä¸‹æƒ…æ³æœƒå°è‡´ `google.script.run` å›å‚³ `null`ï¼Œä¸”**ä¸æœƒæ‹‹å‡ºéŒ¯èª¤**ï¼š
1. å›å‚³å€¼åŒ…å« `Date` ç‰©ä»¶
2. å›å‚³å€¼åŒ…å« `NaN`
3. å›å‚³å€¼åŒ…å«ç„¡æ³•åºåˆ—åŒ–çš„ç‰©ä»¶

### æ±ºç­–
1. **æ°¸é ä½¿ç”¨ `getDisplayValues()` è€Œé `getValues()`**
   - `getValues()` æœƒå›å‚³ Date ç‰©ä»¶ï¼Œç„¡æ³•åºåˆ—åŒ–
   - `getDisplayValues()` å›å‚³å­—ä¸²ï¼Œå®‰å…¨

2. **æ•¸å€¼è¨ˆç®—åŠ  NaN æª¢æŸ¥**
   ```javascript
   let workHours = calculateWorkHours(records);
   if (isNaN(workHours)) {
     workHours = 0;
   }
   ```

3. **å‰ç«¯ç›´æ¥é¡¯ç¤ºæ™‚é–“å­—ä¸²ï¼Œä¸è¦ç”¨ new Date() è½‰æ›**
   ```javascript
   // âŒ éŒ¯èª¤ï¼šæœƒç”¢ç”Ÿ Invalid Date
   const time = new Date(r.time).toLocaleTimeString();

   // âœ… æ­£ç¢ºï¼šç›´æ¥é¡¯ç¤º
   const time = r.time;
   ```

### é™¤éŒ¯æŠ€å·§
ç•¶ `google.script.run` å›å‚³ `null` æ™‚ï¼š
1. å…ˆç”¨ç°¡å–®æ¸¬è©¦å‡½å¼ç¢ºèªé€£ç·šæ­£å¸¸
2. é€æ­¥æ’é™¤ï¼šå…ˆä¸è¨ˆç®—ï¼Œåªå›å‚³åŸå§‹è³‡æ–™
3. æª¢æŸ¥æ˜¯å¦æœ‰ Date ç‰©ä»¶æˆ– NaN

### ç¯„ä¾‹ï¼šå®‰å…¨çš„å›å‚³çµæ§‹
```javascript
function getRecordsForWeb() {
  try {
    const records = getTodayRecords();  // ä½¿ç”¨ getDisplayValues()
    let workHours = calculateWorkHours(records);

    // NaN é˜²è­·
    if (isNaN(workHours)) {
      workHours = 0;
    }

    return {
      records: records,  // ç´”å­—ä¸²é™£åˆ—
      workHours: Math.round(workHours * 10) / 10  // æ•¸å­—
    };
  } catch (e) {
    return {
      error: true,
      message: e.message,
      records: [],
      workHours: 0
    };
  }
}
```

---

## ADR-008: ç¨ç«‹è…³æœ¬ vs ç¶å®šè…³æœ¬

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
Apps Script æœ‰å…©ç¨®éƒ¨ç½²æ–¹å¼ï¼š
- **ç¶å®šè…³æœ¬**ï¼šé™„åŠ åœ¨ç‰¹å®šè©¦ç®—è¡¨ä¸Š
- **ç¨ç«‹è…³æœ¬**ï¼šç¨ç«‹å­˜åœ¨ï¼Œå¯é€£æ¥å¤šå€‹è©¦ç®—è¡¨

### å•é¡Œ
ç¨ç«‹è…³æœ¬ä¸­ `SpreadsheetApp.getActiveSpreadsheet()` æœƒå›å‚³ `null`ã€‚

### æ±ºç­–
ä½¿ç”¨ `SpreadsheetApp.openById(SPREADSHEET_ID)` æ˜ç¢ºæŒ‡å®šè©¦ç®—è¡¨ã€‚

```javascript
// âŒ ç¨ç«‹è…³æœ¬ä¸­æœƒå›å‚³ null
const ss = SpreadsheetApp.getActiveSpreadsheet();

// âœ… ä½¿ç”¨æ˜ç¢ºçš„ ID
const SPREADSHEET_ID = '1bze...';
const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
```

### OAuth Scope
éœ€è¦åœ¨ `appsscript.json` åŠ å…¥æ¬Šé™ï¼š
```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets"
  ]
}
```

---

## ADR-009: ä¸­æ–‡æ—¥æœŸæ ¼å¼è™•ç†

### ç‹€æ…‹
å·²æ¡ç”¨

### èƒŒæ™¯
Google Sheets åœ¨å°ç£åœ°å€æœƒé¡¯ç¤ºä¸­æ–‡æ—¥æœŸæ ¼å¼ï¼Œå¦‚ `2026/1/19 ä¸‹åˆ 4:44:36`ã€‚

### å•é¡Œ
JavaScript çš„ `new Date()` ç„¡æ³•è§£æä¸­æ–‡æ—¥æœŸæ ¼å¼ã€‚

### æ±ºç­–
å»ºç«‹ `parseTime()` å‡½å¼è™•ç†ä¸­æ–‡æ ¼å¼ï¼š

```javascript
function parseTime(timeStr) {
  // è™•ç†ä¸­æ–‡æ ¼å¼ï¼š2026/1/19 ä¸‹åˆ 4:44:36
  if (timeStr.includes('ä¸Šåˆ') || timeStr.includes('ä¸‹åˆ')) {
    const isPM = timeStr.includes('ä¸‹åˆ');
    const cleaned = timeStr.replace('ä¸Šåˆ', '').replace('ä¸‹åˆ', '').trim();
    const [datePart, timePart] = cleaned.split(' ');
    const [year, month, day] = datePart.split('/').map(Number);
    const [hour, minute, second] = timePart.split(':').map(Number);

    let hour24 = hour;
    if (isPM && hour !== 12) hour24 = hour + 12;
    if (!isPM && hour === 12) hour24 = 0;

    return new Date(year, month - 1, day, hour24, minute, second);
  }

  // æ¨™æº–æ ¼å¼ç›´æ¥è§£æ
  return new Date(timeStr);
}
```

---

## ADR-010: Google Sheet åœ°å€è¨­å®šå°æ™‚é–“æ ¼å¼çš„å½±éŸ¿

### ç‹€æ…‹
å·²æ¡ç”¨ï¼ˆ2026-01-27ï¼‰

### èƒŒæ™¯
åœ¨å¯¦éš›éƒ¨ç½²æ™‚ç™¼ç¾ï¼Œå³ä½¿ç¨‹å¼ç¢¼ä½¿ç”¨ `formatChineseDateTime()` è¼¸å‡ºä¸­æ–‡æ ¼å¼ï¼ˆå¦‚ `2026/1/27ä¸‹åˆ11:46:00`ï¼‰ï¼ŒGoogle Sheet ä»æœƒæ ¹æ“šå·¥ä½œè¡¨çš„**åœ°å€è¨­å®š**è‡ªå‹•è½‰æ›æ™‚é–“æ ¼å¼ã€‚

### å•é¡Œ
1. **å°ç£åœ°å€è¨­å®š**ï¼šä¿æŒä¸­æ–‡æ ¼å¼ `2026/1/27ä¸‹åˆ11:46:00`
2. **è‹±æ–‡åœ°å€è¨­å®š**ï¼šè‡ªå‹•è½‰æ›ç‚º `2026/1/27 PM11:46:00`ï¼ˆæ³¨æ„æ—¥æœŸå’Œ PM ä¹‹é–“æœ‰ç©ºæ ¼ï¼‰

é€™å°è‡´ï¼š
- ç´¯è¨ˆå·¥æ™‚é¡¯ç¤º `null` â†’ `parseChineseDate()` ç„¡æ³•è§£ææŸäº›æ ¼å¼
- æ™‚é–“æ ¼å¼ä¸ä¸€è‡´ â†’ æ··åˆå‡ºç¾ã€Œä¸Šåˆ/ä¸‹åˆã€å’Œã€ŒAM/PMã€

### æ±ºç­–
ç³»çµ±å¿…é ˆ**åŒæ™‚æ”¯æ´ä¸­æ–‡å’Œè‹±æ–‡å…©ç¨®æ™‚é–“æ ¼å¼**çš„è§£æå’Œè¨ˆç®—ã€‚

#### 1. ç¨‹å¼ç¢¼è¼¸å‡ºçµ±ä¸€ä½¿ç”¨ä¸­æ–‡æ ¼å¼
```javascript
function formatChineseDateTime(date) {
  const period = hours < 12 ? 'ä¸Šåˆ' : 'ä¸‹åˆ';
  let hour12 = hours % 12;
  if (hour12 === 0) hour12 = 12;
  
  return `${year}/${month}/${day}${period}${hour12}:${mm}:${ss}`;
}
// è¼¸å‡ºï¼š2026/1/27ä¸‹åˆ11:46:00
```

#### 2. parseChineseDate() å¿…é ˆæ”¯æ´å…©ç¨®æ ¼å¼
```javascript
function parseChineseDate(dateString) {
  // 1. ä¸­æ–‡æ ¼å¼ï¼ˆç„¡ç©ºæ ¼ï¼‰ï¼š2026/1/27ä¸Šåˆ9:00:00
  const chineseRegex = /(\d{4})\/(\d{1,2})\/(\d{1,2})(ä¸Šåˆ|ä¸‹åˆ)(\d{1,2}):(\d{2}):(\d{2})/;
  
  // 2. è‹±æ–‡æ ¼å¼ï¼ˆæœ‰ç©ºæ ¼ï¼‰ï¼š2026/1/27 AM9:00:00 æˆ– 2026/1/27 PM11:46:00
  const englishRegex = /(\d{4})\/(\d{1,2})\/(\d{1,2})\s*(AM|PM|am|pm)(\d{1,2}):(\d{2}):(\d{2})/i;
  
  // å…©ç¨®æ ¼å¼éƒ½è¦èƒ½æ­£ç¢ºè§£æ
}
```

#### 3. Feature æ¸¬è©¦å¿…é ˆæ¶µè“‹å…©ç¨®æ ¼å¼
```gherkin
Rule: å¾Œç½®æ¢ä»¶ - ç³»çµ±å¿…é ˆæ”¯æ´ä¸­æ–‡å’Œè‹±æ–‡å…©ç¨®æ™‚é–“æ ¼å¼

  Example: æ”¯æ´è‹±æ–‡ AM/PM æ ¼å¼çš„å·¥æ™‚è¨ˆç®—
    Given å·²æœ‰ä¸€ç­†æ‰“å¡è¨˜éŒ„ï¼šé¡å‹ã€ŒINã€æ™‚é–“ã€Œ2026/1/27 AM9:00:00ã€
    And å·²æœ‰ä¸€ç­†æ‰“å¡è¨˜éŒ„ï¼šé¡å‹ã€ŒOUTã€æ™‚é–“ã€Œ2026/1/27 PM6:00:00ã€
    When æˆ‘æŸ¥è©¢ä»Šæ—¥å·¥æ™‚
    Then å·¥æ™‚æ‡‰è©²æ˜¯ 540 åˆ†é˜
  
  Example: æ”¯æ´æ··åˆæ ¼å¼çš„å·¥æ™‚è¨ˆç®—ï¼ˆä¸­æ–‡ + è‹±æ–‡ï¼‰
    Given å·²æœ‰ä¸€ç­†æ‰“å¡è¨˜éŒ„ï¼šé¡å‹ã€ŒINã€æ™‚é–“ã€Œ2026/1/27ä¸Šåˆ9:00:00ã€
    And å·²æœ‰ä¸€ç­†æ‰“å¡è¨˜éŒ„ï¼šé¡å‹ã€ŒOUTã€æ™‚é–“ã€Œ2026/1/27 PM12:00:00ã€
    When æˆ‘æŸ¥è©¢ä»Šæ—¥å·¥æ™‚
    Then å·¥æ™‚æ‡‰è©²æ˜¯ 180 åˆ†é˜
```

### ç†ç”±
1. **ç„¡æ³•æ§åˆ¶ä½¿ç”¨è€…ç’°å¢ƒ**ï¼šä¸åŒä½¿ç”¨è€…çš„ Google Sheet å¯èƒ½æœ‰ä¸åŒçš„åœ°å€è¨­å®š
2. **è‡ªå‹•è½‰æ›ç„¡æ³•é¿å…**ï¼šGoogle Sheet æœƒè‡ªå‹•æ ¹æ“šåœ°å€è¨­å®šæ ¼å¼åŒ–æ™‚é–“
3. **å‘å¾Œç›¸å®¹**ï¼šå³ä½¿ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œå·²å­˜åœ¨çš„è³‡æ–™æ ¼å¼ä¸æœƒæ”¹è®Š
4. **æ··åˆç’°å¢ƒ**ï¼šå”ä½œå ´æ™¯ä¸‹å¯èƒ½å‡ºç¾æ··åˆæ ¼å¼ï¼ˆä¸åŒä½¿ç”¨è€…ç·¨è¼¯ï¼‰

### å¯¦ä½œç´°ç¯€

#### æ™‚é–“æ ¼å¼å·®ç•°æ¯”è¼ƒ
| æ ¼å¼é¡å‹ | ç¯„ä¾‹ | ç‰¹å¾µ |
|---------|------|------|
| ä¸­æ–‡ï¼ˆå°ç£ï¼‰ | `2026/1/27ä¸‹åˆ11:46:00` | ç„¡ç©ºæ ¼ï¼Œä½¿ç”¨ã€Œä¸Šåˆ/ä¸‹åˆã€ |
| è‹±æ–‡ï¼ˆç¾åœ‹ï¼‰ | `2026/1/27 PM11:46:00` | æœ‰ç©ºæ ¼ï¼Œä½¿ç”¨ã€ŒAM/PMã€ |

#### 12 å°æ™‚åˆ¶è½‰æ›è¦å‰‡
```javascript
// å…±åŒè¦å‰‡ï¼ˆä¸­æ–‡å’Œè‹±æ–‡æ ¼å¼éƒ½é©ç”¨ï¼‰
if (isPM && hours !== 12) {
  hours += 12;  // PM 1:00 â†’ 13:00
}
if (!isPM && hours === 12) {
  hours = 0;    // AM 12:00 â†’ 00:00
}
// PM 12:00 ä¿æŒ 12ï¼ˆä¸­åˆï¼‰
```

### æ¸¬è©¦ç­–ç•¥
1. **æ¸¬è©¦ç’°å¢ƒä½¿ç”¨ä¸­æ–‡æ ¼å¼**ï¼ˆgas-mock.js é è¨­ï¼‰
2. **Feature æ–‡ä»¶æ˜ç¢ºæ¸¬è©¦å…©ç¨®æ ¼å¼**
3. **å¯¦éš›éƒ¨ç½²å‰æ‰‹å‹•æ¸¬è©¦è‹±æ–‡åœ°å€è¨­å®š**

### å¾Œæœ
- âœ… ç³»çµ±åœ¨ä»»ä½•åœ°å€è¨­å®šä¸‹éƒ½èƒ½æ­£å¸¸é‹ä½œ
- âœ… å·¥æ™‚è¨ˆç®—ä¸å—æ ¼å¼å½±éŸ¿
- âš ï¸ ç¨‹å¼ç¢¼è¤‡é›œåº¦ç•¥å¾®å¢åŠ ï¼ˆéœ€è¦å…©å€‹ regexï¼‰
- âš ï¸ æ¸¬è©¦æ¡ˆä¾‹æ•¸é‡å¢åŠ 

### ç›¸é—œæ±ºç­–
- åƒè€ƒ ADR-009ï¼šä¸­æ–‡æ—¥æœŸæ ¼å¼è™•ç†ï¼ˆåŸºç¤æ±ºç­–ï¼‰
- æ“´å±• ADR-009ï¼šæ–°å¢è‹±æ–‡æ ¼å¼æ”¯æ´

### å»ºè­°éƒ¨ç½²æ­¥é©Ÿ
1. **æ¨è–¦è¨­å®š**ï¼šå°‡ Google Sheet åœ°å€è¨­å®šç‚ºã€Œå°ç£ã€
   - æª”æ¡ˆ â†’ è¨­å®š â†’ ä¸€èˆ¬ â†’ åœ°å€ï¼šå°ç£
   - æ™‚å€ï¼š(GMT+08:00) å°åŒ—
2. **æ¸¬è©¦å…©ç¨®æ ¼å¼**ï¼šéƒ¨ç½²å¾Œåœ¨å…©ç¨®åœ°å€è¨­å®šä¸‹æ¸¬è©¦å·¥æ™‚è¨ˆç®—
3. **ç›£æ§ç•°å¸¸**ï¼šè¨˜éŒ„ç´¯è¨ˆå·¥æ™‚ç‚º `null` æˆ– `NaN` çš„æƒ…æ³

---

## é™„éŒ„ï¼šå¸¸è¦‹å•é¡Œ

### Q1: å¦‚ä½•æ¸¬è©¦éœ€è¦çœŸå¯¦ Google API çš„åŠŸèƒ½ï¼Ÿ
A: é€™å¥—æ¶æ§‹å°ˆæ³¨æ–¼å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦ã€‚éœ€è¦çœŸå¯¦ API çš„æ¸¬è©¦æ‡‰è©²åœ¨ Google Apps Script ç·¨è¼¯å™¨ä¸­åŸ·è¡Œã€‚

### Q2: Mock æ²’æœ‰æ¶µè“‹åˆ°çš„ API æ€éº¼è¾¦ï¼Ÿ
A: å¯ä»¥åœ¨ `gas-mock.js` ä¸­æ“´å……ï¼Œæˆ–åœ¨æ¸¬è©¦ä¸­æ‰‹å‹•æ³¨å…¥ã€‚

### Q3: å¦‚ä½•è™•ç†éåŒæ­¥æ“ä½œï¼Ÿ
A: å¤§éƒ¨åˆ† Apps Script API æ˜¯åŒæ­¥çš„ã€‚Mock çš„ `google.script.run` ä½¿ç”¨ `setTimeout` æ¨¡æ“¬éåŒæ­¥è¡Œç‚ºã€‚

### Q4: google.script.run å›å‚³ null æ€éº¼è¾¦ï¼Ÿ
A: åƒè€ƒ ADR-007ã€‚æª¢æŸ¥å›å‚³å€¼æ˜¯å¦åŒ…å«ï¼š
- Date ç‰©ä»¶ï¼ˆç”¨ `getDisplayValues()` å–ä»£ `getValues()`ï¼‰
- NaNï¼ˆåŠ å…¥ `isNaN()` æª¢æŸ¥ï¼‰
- ç„¡æ³•åºåˆ—åŒ–çš„ç‰©ä»¶

### Q5: ç¨ç«‹è…³æœ¬ç„¡æ³•å­˜å–è©¦ç®—è¡¨æ€éº¼è¾¦ï¼Ÿ
A: åƒè€ƒ ADR-008ã€‚ä½¿ç”¨ `openById()` ä¸¦ç¢ºèª OAuth scope å·²è¨­å®šã€‚

---

## ADR-011: Mock å¿…é ˆæº–ç¢ºæ¨¡æ“¬ HtmlService æ¨¡æ¿èªæ³•

### ç‹€æ…‹
å·²æ¡ç”¨ï¼ˆ2026-01-27ï¼‰

### èƒŒæ™¯
åœ¨å¯¦ä½œæ‰“å¡ç³»çµ±æ™‚ï¼Œç™¼ç¾ç”Ÿç”¢ç’°å¢ƒå‡ºç¾**ç™½ç•«é¢å•é¡Œ**ï¼Œä½†æ¸¬è©¦ç’°å¢ƒæ²’æœ‰ç™¼ç¾ï¼š

**ç”Ÿç”¢ç’°å¢ƒå•é¡Œï¼š**
```javascript
// src/ç¨‹å¼ç¢¼.js
const template = HtmlService.createTemplateFromFile('Index');
template.workHours = workHours;
template.recordsHtml = recordsHtml;
return template.evaluate();  // âŒ å¯¦éš›ç’°å¢ƒå ±éŒ¯ï¼šæ¨¡æ¿è®Šæ•¸æœªè™•ç†
```

**æ¸¬è©¦ç’°å¢ƒæ²’ç™¼ç¾ï¼š**
- åŸå§‹çš„ Mock `createTemplateFromFile()` åªæ˜¯ç°¡å–®åœ°è®€å–æª”æ¡ˆ
- å®Œå…¨å¿½ç•¥äº†è¨­å®šçš„æ¨¡æ¿è®Šæ•¸ï¼ˆ`template.workHours`, `template.recordsHtml`ï¼‰
- æ¸¬è©¦ç”¨ cheerio è§£æ HTMLï¼ŒæŠŠ `<?= workHours ?>` ç•¶ä½œæ™®é€šæ–‡å­—ï¼Œä¸æœƒå ±éŒ¯
- å°è‡´**æ¸¬è©¦é€šéï¼Œä½†ç”Ÿç”¢ç’°å¢ƒç™½ç•«é¢**

**æ ¹æœ¬åŸå› ï¼š**
Mock ç’°å¢ƒèˆ‡çœŸå¯¦ç’°å¢ƒè¡Œç‚ºä¸ä¸€è‡´ï¼Œæ¸¬è©¦ç„¡æ³•ç™¼ç¾æ¨¡æ¿èªæ³•ç›¸é—œçš„å•é¡Œã€‚

### æ±ºç­–
ä¿®æ­£ `gas-mock.js` çš„ `createTemplateFromFile()`ï¼Œæº–ç¢ºæ¨¡æ“¬ Apps Script çš„æ¨¡æ¿èªæ³•è™•ç†ï¼š

1. ä½¿ç”¨ **Proxy** å‹•æ…‹æ””æˆªæ¨¡æ¿è®Šæ•¸çš„è¨­å®š
2. å¯¦ä½œ `_evaluateTemplate()` è™•ç† Apps Script æ¨¡æ¿èªæ³•
3. **æœªå®šç¾©è®Šæ•¸æ™‚æ‹‹å‡ºæ˜ç¢ºéŒ¯èª¤**ï¼Œå¹«åŠ©ææ—©ç™¼ç¾å•é¡Œ

### ç†ç”±
1. **æ¸¬è©¦èˆ‡ç”Ÿç”¢ç’°å¢ƒä¸€è‡´æ€§**ï¼šMock å¿…é ˆæº–ç¢ºæ¨¡æ“¬çœŸå¯¦è¡Œç‚ºï¼Œæ‰èƒ½ç™¼ç¾çœŸå¯¦å•é¡Œ
2. **ææ—©ç™¼ç¾éŒ¯èª¤**ï¼šåœ¨æ¸¬è©¦éšæ®µå°±ç™¼ç¾æ¨¡æ¿è®Šæ•¸æœªå®šç¾©ï¼Œè€Œéç­‰åˆ°éƒ¨ç½²å¾Œ
3. **é–‹ç™¼é«”é©—æå‡**ï¼šæ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯å¹«åŠ©å¿«é€Ÿå®šä½å•é¡Œ
4. **ç¶­è­·æœ€ä½³å¯¦è¸**ï¼šä½¿ç”¨æ¨™æº–çš„ Apps Script æ¨¡æ¿èªæ³•ï¼Œè€Œéè‡ªè¨‚æ›¿æ›æ–¹æ¡ˆ

### å¯¦ä½œ

#### 1. ä¿®æ­£ Mock å¯¦ä½œ

```javascript
// lib/gas-mock.js
createTemplateFromFile(filename) {
  const serviceInstance = this;
  const templateContext = {}; // å„²å­˜æ¨¡æ¿è®Šæ•¸
  
  // ä½¿ç”¨ Proxy æ””æˆªå±¬æ€§è¨­å®šå’Œè®€å–
  return new Proxy(templateContext, {
    set(target, prop, value) {
      target[prop] = value;
      return true;
    },
    get(target, prop) {
      // evaluate() æ–¹æ³•
      if (prop === 'evaluate') {
        return function() {
          return serviceInstance._evaluateTemplate(filename, target);
        };
      }
      return target[prop];
    }
  });
},

/**
 * è©•ä¼°æ¨¡æ¿ä¸¦æ›¿æ›è®Šæ•¸
 * æ”¯æ´ Apps Script æ¨¡æ¿èªæ³•ï¼š
 * - <?= variable ?> : è¼¸å‡ºè®Šæ•¸ï¼ˆHTML è½‰ç¾©ï¼‰
 * - <?!= variable ?> : è¼¸å‡ºè®Šæ•¸ï¼ˆä¸è½‰ç¾©ï¼‰
 */
_evaluateTemplate(filename, context) {
  const htmlOutput = this.createHtmlOutputFromFile(filename);
  let html = htmlOutput.getContent();
  
  // è™•ç† <?!= variable ?> (ä¸è½‰ç¾©è¼¸å‡º)
  html = html.replace(/<\?!=\s*(\w+)\s*\?>/g, (match, varName) => {
    if (!(varName in context)) {
      throw new Error(
        `æ¨¡æ¿éŒ¯èª¤ï¼šè®Šæ•¸ '${varName}' æœªå®šç¾©ã€‚\n` +
        `è«‹åœ¨ evaluate() å‰è¨­å®šï¼štemplate.${varName} = value`
      );
    }
    return context[varName];
  });
  
  // è™•ç† <?= variable ?> (HTML è½‰ç¾©è¼¸å‡º)
  html = html.replace(/<\?=\s*(\w+)\s*\?>/g, (match, varName) => {
    if (!(varName in context)) {
      throw new Error(
        `æ¨¡æ¿éŒ¯èª¤ï¼šè®Šæ•¸ '${varName}' æœªå®šç¾©ã€‚\n` +
        `è«‹åœ¨ evaluate() å‰è¨­å®šï¼štemplate.${varName} = value`
      );
    }
    // HTML è½‰ç¾©
    return String(context[varName])
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  });
  
  // æª¢æŸ¥æ˜¯å¦é‚„æœ‰æœªè™•ç†çš„æ¨¡æ¿èªæ³•
  const remainingTemplates = html.match(/<\?[!=]?\s*\w+\s*\?>/g);
  if (remainingTemplates) {
    throw new Error(
      `æ¨¡æ¿éŒ¯èª¤ï¼šç™¼ç¾æœªè™•ç†çš„æ¨¡æ¿èªæ³•ï¼š${remainingTemplates.join(', ')}\n` +
      `è«‹ç¢ºèªæ‰€æœ‰è®Šæ•¸éƒ½å·²è¨­å®šã€‚`
    );
  }
  
  return this.createHtmlOutput(html);
}
```

#### 2. æ­£ç¢ºçš„ç”Ÿç”¢ç¨‹å¼ç¢¼

```javascript
// src/ç¨‹å¼ç¢¼.js
function doGet() {
  try {
    const records = getTodayRecords();
    let workHours = getTodayWorkHours();
    
    if (isNaN(workHours)) {
      workHours = 0;
    }
    
    let recordsHtml = '';
    if (records.length === 0) {
      recordsHtml = '<li>å°šç„¡æ‰“å¡è¨˜éŒ„</li>';
    } else {
      records.forEach(record => {
        recordsHtml += `<li>${record.é¡å‹} - ${record.æ™‚é–“}</li>`;
      });
    }
    
    // âœ… ä½¿ç”¨æ¨™æº– Apps Script æ¨¡æ¿èªæ³•
    const template = HtmlService.createTemplateFromFile('Index');
    template.workHours = workHours;
    template.recordsHtml = recordsHtml;
    
    return template.evaluate()
      .setTitle('æ‰“å¡ç³»çµ±')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } catch (error) {
    // éŒ¯èª¤è™•ç†ï¼šè¿”å›éŒ¯èª¤é é¢è€Œéç™½ç•«é¢
    const errorHtml = `<!DOCTYPE html>...`;
    return HtmlService.createHtmlOutput(errorHtml);
  }
}
```

#### 3. HTML æ¨¡æ¿

```html
<!-- src/Index.html -->
<div id="work-hours">ç´¯è¨ˆå·¥æ™‚ï¼š<?= workHours ?> åˆ†é˜</div>

<h3>ä»Šæ—¥æ‰“å¡è¨˜éŒ„</h3>
<ul id="records">
  <?!= recordsHtml ?>
</ul>
```

### å¾Œæœ

#### å„ªé»
1. **âœ… æ¸¬è©¦èƒ½ç™¼ç¾ç™½ç•«é¢å•é¡Œ**ï¼šå¿˜è¨˜è¨­å®šæ¨¡æ¿è®Šæ•¸æ™‚ï¼Œæ¸¬è©¦æœƒç«‹å³å ±éŒ¯
2. **âœ… éŒ¯èª¤è¨Šæ¯æ¸…æ™°**ï¼šæ˜ç¢ºæŒ‡å‡ºå“ªå€‹è®Šæ•¸æœªå®šç¾©ï¼Œå¦‚ä½•ä¿®æ­£
3. **âœ… èˆ‡çœŸå¯¦ç’°å¢ƒä¸€è‡´**ï¼šä½¿ç”¨æ¨™æº–çš„ Apps Script æ¨¡æ¿èªæ³•
4. **âœ… é–‹ç™¼ä¿¡å¿ƒæå‡**ï¼šæ¸¬è©¦é€šé = ç”Ÿç”¢ç’°å¢ƒä¹Ÿæœƒæ­£å¸¸é‹ä½œ

#### æ¸¬è©¦æ•ˆæœå°æ¯”

**ä¿®æ­£å‰ï¼š**
```javascript
// æ¸¬è©¦é€šé âœ…ï¼ˆä½†ç”Ÿç”¢ç’°å¢ƒç™½ç•«é¢ âŒï¼‰
const template = HtmlService.createTemplateFromFile('Index');
template.workHours = 123;
// å¿˜è¨˜è¨­å®š recordsHtml
return template.evaluate();  // æ¸¬è©¦ä¸æœƒç™¼ç¾å•é¡Œ
```

**ä¿®æ­£å¾Œï¼š**
```javascript
// æ¸¬è©¦å¤±æ•— âŒï¼ˆææ—©ç™¼ç¾å•é¡Œï¼‰
const template = HtmlService.createTemplateFromFile('Index');
template.workHours = 123;
// å¿˜è¨˜è¨­å®š recordsHtml
return template.evaluate();
// Error: æ¨¡æ¿éŒ¯èª¤ï¼šè®Šæ•¸ 'recordsHtml' æœªå®šç¾©ã€‚
// è«‹åœ¨ evaluate() å‰è¨­å®šï¼štemplate.recordsHtml = value
```

#### æŒ‘æˆ°
1. **Mock ç¶­è­·æˆæœ¬å¢åŠ **ï¼šéœ€è¦æº–ç¢ºæ¨¡æ“¬æ›´å¤š Apps Script è¡Œç‚º
2. **æ¸¬è©¦åŸ·è¡Œæ™‚é–“ç•¥å¢**ï¼šæ­£å‰‡æ›¿æ›éœ€è¦é¡å¤–æ™‚é–“ï¼ˆä½†å½±éŸ¿å¾®ä¹å…¶å¾®ï¼‰

### æ•™è¨“èˆ‡æœ€ä½³å¯¦è¸

#### ç‚ºä»€éº¼ BDD æ¸¬è©¦æœ‰æ™‚æ¸¬ä¸å‡ºç”Ÿç”¢å•é¡Œï¼Ÿ

1. **æ¸¬è©¦ç’°å¢ƒ â‰  ç”Ÿç”¢ç’°å¢ƒ**
   - Mock å¯èƒ½å¯¦ä½œä¸å®Œæ•´æˆ–è¡Œç‚ºä¸ä¸€è‡´
   - éœ€è¦å®šæœŸç”¨çœŸå¯¦ç’°å¢ƒé©—è­‰

2. **E2E æ¸¬è©¦çš„å±€é™**
   - æ¸¬è©¦ç”¨éœæ…‹ HTML è§£æï¼ˆcheerioï¼‰
   - ç„¡æ³•æ¸¬è©¦å‹•æ…‹æ¨¡æ¿å¼•æ“çš„åŸ·è¡Œ

3. **Mock çš„è¨­è¨ˆåŸå‰‡**
   - **æº–ç¢ºæ€§ > ç°¡æ½”æ€§**ï¼šMock å¿…é ˆæº–ç¢ºæ¨¡æ“¬çœŸå¯¦è¡Œç‚ºï¼Œå³ä½¿å¯¦ä½œè¤‡é›œ
   - **å¤±æ•—å„ªæ–¼éœé»˜**ï¼šä¸ç¢ºå®šçš„æƒ…æ³æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤ï¼Œè€Œéå›å‚³ fallback å€¼
   - **æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯**ï¼šå¹«åŠ©é–‹ç™¼è€…å¿«é€Ÿå®šä½å•é¡Œ

#### å»ºè­°çš„æ¸¬è©¦ç­–ç•¥

1. **é–‹ç™¼éšæ®µ**ï¼šä½¿ç”¨ Mock é€²è¡Œå¿«é€Ÿè¿­ä»£
2. **æäº¤å‰**ï¼šåœ¨çœŸå¯¦ Apps Script ç’°å¢ƒä¸­åŸ·è¡Œå†’ç…™æ¸¬è©¦
3. **éƒ¨ç½²å¾Œ**ï¼šç›£æ§éŒ¯èª¤æ—¥èªŒï¼Œç™¼ç¾ Mock æœªæ¶µè“‹çš„é‚Šç•Œæƒ…æ³
4. **æŒçºŒæ”¹é€²**ï¼šç™¼ç¾ç”Ÿç”¢å•é¡Œæ™‚ï¼Œå„ªå…ˆä¿®æ­£ Mock è®“æ¸¬è©¦èƒ½ç™¼ç¾ç›¸åŒå•é¡Œ

### ç›¸é—œæ±ºç­–
- ADR-003: Mock ç­–ç•¥
- ADR-007: google.script.run åºåˆ—åŒ–é™åˆ¶ï¼ˆé¡ä¼¼çš„ã€Œæ¸¬è©¦ç’°å¢ƒèˆ‡ç”Ÿç”¢ç’°å¢ƒä¸ä¸€è‡´ã€å•é¡Œï¼‰

### åƒè€ƒè³‡æ–™
- [Apps Script HTML Service - Templated HTML](https://developers.google.com/apps-script/guides/html/templates)
- [Node.js Proxy](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy)

---

## ADR-012: GAS Web App iframe sandbox é™åˆ¶èˆ‡é é¢æ›´æ–°ç­–ç•¥

### ç‹€æ…‹
å·²æ¡ç”¨ï¼ˆ2026-01-28ï¼‰

### èƒŒæ™¯
åœ¨æ‰“å¡ç³»çµ±ä¸­ï¼Œæ‰“å¡æˆåŠŸå¾Œéœ€è¦æ›´æ–°é é¢é¡¯ç¤ºæœ€æ–°è¨˜éŒ„ã€‚æœ€åˆä½¿ç”¨ `location.reload()` é‡æ–°è¼‰å…¥é é¢ï¼Œä½†ç™¼ç¾åœ¨ GAS Web App ç’°å¢ƒä¸­æœƒå°è‡´**ç™½ç•«é¢**ã€‚

**å•é¡Œç¾è±¡ï¼š**
1. é»æ“Š IN/OUT æŒ‰éˆ•ï¼Œé¡¯ç¤ºã€Œæ‰“å¡æˆåŠŸã€è¨Šæ¯
2. 1 ç§’å¾Œè§¸ç™¼ `location.reload()`
3. é é¢è®Šæˆç™½ç•«é¢ï¼ˆè€Œæ‰‹å‹•é‡æ–°æ•´ç†å»æ­£å¸¸ï¼‰

**ç€è¦½å™¨æ§åˆ¶å°è­¦å‘Šï¼š**
```
Unrecognized feature: 'ambient-light-sensor'
Unrecognized feature: 'speaker'
Unrecognized feature: 'vibrate'
Unrecognized feature: 'vr'
An iframe which has both allow-scripts and allow-same-origin for its sandbox attribute can escape its sandboxing.
```

### å•é¡Œåˆ†æ

#### GAS Web App çš„ iframe æ¶æ§‹
Google Apps Script Web App åœ¨ iframe ä¸­é‹è¡Œï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **Sandbox é™åˆ¶**ï¼šiframe æœ‰ `sandbox` å±¬æ€§ï¼Œé™åˆ¶äº†æŸäº›æ“ä½œ
2. **è·¨åŸŸç’°å¢ƒ**ï¼šWeb App é‹è¡Œåœ¨ `script.google.com`ï¼Œä½†å¯¦éš›å…§å®¹åœ¨ä¸åŒçš„ origin
3. **å°èˆªé™åˆ¶**ï¼š`location.reload()` å’Œ `window.top.location` å¯èƒ½å› å®‰å…¨é™åˆ¶è€Œå¤±æ•—

#### ç‚ºä»€éº¼ `location.reload()` æœƒå¤±æ•—ï¼Ÿ

| æ“ä½œ | çµæœ | åŸå›  |
|------|------|------|
| æ‰‹å‹•é‡æ–°æ•´ç† | âœ… æ­£å¸¸ | ç€è¦½å™¨åŸç”Ÿæ“ä½œï¼Œä¸å— sandbox é™åˆ¶ |
| `location.reload()` | âŒ ç™½ç•«é¢ | JavaScript è§¸ç™¼çš„å°èˆªå¯èƒ½è¢« sandbox æ””æˆª |
| `window.top.location.href` | âŒ éŒ¯èª¤ | è·¨åŸŸé™åˆ¶ï¼Œç„¡æ³•å­˜å– top frame |

### æ±ºç­–
**ä½¿ç”¨ `google.script.run` çš„ AJAX æ–¹å¼å‹•æ…‹æ›´æ–°é é¢æ•¸æ“šï¼Œè€Œéé‡æ–°è¼‰å…¥æ•´å€‹é é¢ã€‚**

### å¯¦ä½œ

#### 1. å‰ç«¯ç¨‹å¼ç¢¼ï¼ˆIndex.htmlï¼‰

```html
<script>
  function handlePunch(type) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showMessage(result.message, 'success');
          // âœ… æ­£ç¢ºï¼šä½¿ç”¨ AJAX æ›´æ–°æ•¸æ“š
          setTimeout(refreshData, 1000);
        } else {
          showMessage(result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showMessage('æ‰“å¡å¤±æ•—ï¼š' + error.message, 'error');
      })
      .handlePunch(type);
  }

  // âœ… æ–°å¢ï¼šå‹•æ…‹æ›´æ–°é é¢æ•¸æ“š
  function refreshData() {
    google.script.run
      .withSuccessHandler(function(data) {
        // ç›´æ¥æ›´æ–° DOMï¼Œä¸éœ€é‡æ–°è¼‰å…¥é é¢
        document.getElementById('work-hours').textContent =
          'ç´¯è¨ˆå·¥æ™‚ï¼š' + data.workHours + ' åˆ†é˜';
        document.getElementById('records').innerHTML = data.recordsHtml;
      })
      .withFailureHandler(function(error) {
        showMessage('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
      })
      .getPageData();
  }

  function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = text;
    messageDiv.className = type;
    setTimeout(function() {
      messageDiv.textContent = '';
      messageDiv.className = '';
    }, 3000);
  }
</script>
```

#### 2. å¾Œç«¯ç¨‹å¼ç¢¼ï¼ˆç¨‹å¼ç¢¼.jsï¼‰

```javascript
// âœ… æ–°å¢ï¼šæä¾›é é¢æ•¸æ“š API
function getPageData() {
  const records = getTodayRecords();
  let workHours = getTodayWorkHours();

  if (isNaN(workHours) || workHours === null || workHours === undefined) {
    workHours = 0;
  }

  let recordsHtml = '';
  if (records.length === 0) {
    recordsHtml = '<li>å°šç„¡æ‰“å¡è¨˜éŒ„</li>';
  } else {
    records.forEach(function(record) {
      recordsHtml += '<li>' + record.é¡å‹ + ' - ' + record.æ™‚é–“ + '</li>';
    });
  }

  return {
    workHours: workHours,
    recordsHtml: recordsHtml
  };
}
```

### éŒ¯èª¤ç¨‹å¼ç¢¼ vs æ­£ç¢ºç¨‹å¼ç¢¼

#### âŒ éŒ¯èª¤ï¼šä½¿ç”¨ location.reload()

```javascript
// å¯èƒ½å°è‡´ç™½ç•«é¢ï¼
function handlePunch(type) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showMessage(result.message, 'success');
        setTimeout(function() {
          location.reload();  // âŒ åœ¨ iframe sandbox ä¸­å¯èƒ½å¤±æ•—
        }, 1000);
      }
    })
    .handlePunch(type);
}
```

#### âŒ éŒ¯èª¤ï¼šä½¿ç”¨ window.top.location

```javascript
// æœƒè§¸ç™¼è·¨åŸŸéŒ¯èª¤ï¼
setTimeout(function() {
  google.script.run
    .withSuccessHandler(function(url) {
      window.top.location.href = url;  // âŒ SecurityError: è·¨åŸŸé™åˆ¶
    })
    .getScriptUrl();
}, 1000);
```

#### âœ… æ­£ç¢ºï¼šä½¿ç”¨ AJAX æ›´æ–°

```javascript
// å‹•æ…‹æ›´æ–° DOMï¼Œä¸éœ€é‡æ–°è¼‰å…¥é é¢
function handlePunch(type) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showMessage(result.message, 'success');
        setTimeout(refreshData, 1000);  // âœ… å‘¼å«æ›´æ–°å‡½å¼
      }
    })
    .handlePunch(type);
}

function refreshData() {
  google.script.run
    .withSuccessHandler(function(data) {
      document.getElementById('work-hours').textContent =
        'ç´¯è¨ˆå·¥æ™‚ï¼š' + data.workHours + ' åˆ†é˜';
      document.getElementById('records').innerHTML = data.recordsHtml;
    })
    .getPageData();  // âœ… å¾Œç«¯æä¾›æ•¸æ“š API
}
```

### Mock å¼·åŒ–

ç‚ºäº†åœ¨æ¸¬è©¦éšæ®µç™¼ç¾é€™é¡å•é¡Œï¼Œæˆ‘å€‘åœ¨ `gas-mock.js` ä¸­æ–°å¢äº†ï¼š

#### 1. `createMockBrowserEnvironment()` - æ¨¡æ“¬ iframe sandbox ç’°å¢ƒ

```javascript
import { createMockBrowserEnvironment } from './gas-mock.js';

// å»ºç«‹ Mock ç€è¦½å™¨ç’°å¢ƒ
const browserEnv = createMockBrowserEnvironment({
  strictMode: true,      // åš´æ ¼æ¨¡å¼ï¼šåµæ¸¬åˆ°å•é¡Œæ™‚æ‹‹å‡ºéŒ¯èª¤
  simulateSandbox: true  // æ¨¡æ“¬ sandbox é™åˆ¶
});

// æ¸¬è©¦ç¨‹å¼ç¢¼ä½¿ç”¨ location.reload() æ™‚æœƒå ±éŒ¯
browserEnv.location.reload();  // æ‹‹å‡ºè­¦å‘Šæˆ–éŒ¯èª¤
```

#### 2. `checkHtmlForSandboxIssues()` - éœæ…‹åˆ†æ HTML

```javascript
import { checkHtmlForSandboxIssues } from './gas-mock.js';
import fs from 'fs';

// è®€å–ä¸¦æª¢æŸ¥ HTML
const html = fs.readFileSync('src/Index.html', 'utf-8');
const result = checkHtmlForSandboxIssues(html);

if (result.hasIssues) {
  console.log('ç™¼ç¾æ½›åœ¨å•é¡Œï¼š');
  result.issues.forEach(issue => {
    console.log(`  ç¬¬ ${issue.line} è¡Œï¼š${issue.type}`);
    console.log(`  ç¨‹å¼ç¢¼ï¼š${issue.code}`);
    console.log(`  å»ºè­°ï¼š${issue.suggestion}`);
  });
}
```

#### 3. å¯åŠ å…¥ CI/CD æª¢æŸ¥

```javascript
// features/step_definitions/é é¢æµç¨‹.steps.js
import { checkHtmlForSandboxIssues } from '../../lib/gas-mock.js';

Before(function() {
  // æª¢æŸ¥ HTML æ˜¯å¦æœ‰ iframe sandbox å•é¡Œ
  const html = fs.readFileSync('src/Index.html', 'utf-8');
  const result = checkHtmlForSandboxIssues(html);

  if (result.hasIssues) {
    const messages = result.issues.map(i =>
      `ç¬¬ ${i.line} è¡Œ: ${i.suggestion}`
    ).join('\n');

    console.warn(`âš ï¸ ç™¼ç¾ iframe sandbox æ½›åœ¨å•é¡Œï¼š\n${messages}`);
    // å¯é¸ï¼šåœ¨åš´æ ¼æ¨¡å¼ä¸‹è®“æ¸¬è©¦å¤±æ•—
    // throw new Error('HTML contains iframe sandbox issues');
  }
});
```

### ç†ç”±

1. **é¿å…ç™½ç•«é¢**ï¼šAJAX æ–¹å¼ä¸æ¶‰åŠé é¢å°èˆªï¼Œä¸æœƒè¢« sandbox æ””æˆª
2. **æ›´å¥½çš„ç”¨æˆ¶é«”é©—**ï¼šå±€éƒ¨æ›´æ–°æ¯”æ•´é é‡æ–°è¼‰å…¥æ›´å¿«é€Ÿæµæš¢
3. **æ›´å¯é **ï¼šä¸ä¾è³´ç€è¦½å™¨çš„å°èˆªè¡Œç‚ºï¼Œæ¸›å°‘ç’°å¢ƒå·®ç•°
4. **å¯æ¸¬è©¦æ€§**ï¼š`getPageData()` å‡½å¼å¯ä»¥ç¨ç«‹å–®å…ƒæ¸¬è©¦

### å¾Œæœ

#### å„ªé»
- âœ… è§£æ±ºç™½ç•«é¢å•é¡Œ
- âœ… æ›´å¿«çš„éŸ¿æ‡‰é€Ÿåº¦ï¼ˆç„¡éœ€é‡æ–°è¼‰å…¥æ•´å€‹é é¢ï¼‰
- âœ… æ›´å¥½çš„ç”¨æˆ¶é«”é©—ï¼ˆç„¡é–ƒçˆï¼‰
- âœ… Mock å¯ä»¥åœ¨æ¸¬è©¦éšæ®µç™¼ç¾å•é¡Œ

#### ä»£åƒ¹
- âš ï¸ éœ€è¦é¡å¤–çš„å¾Œç«¯ APIï¼ˆ`getPageData()`ï¼‰
- âš ï¸ éœ€è¦ç¶­è­·å…©ä»½æ¸²æŸ“é‚è¼¯ï¼ˆ`doGet()` å’Œ `getPageData()`ï¼‰
- âš ï¸ å‰ç«¯éœ€è¦æ‰‹å‹•æ›´æ–° DOM

### ç›¸é—œæ±ºç­–
- ADR-007: google.script.run åºåˆ—åŒ–é™åˆ¶
- ADR-011: Mock å¿…é ˆæº–ç¢ºæ¨¡æ“¬ HtmlService æ¨¡æ¿èªæ³•

### åƒè€ƒè³‡æ–™
- [HTML Service: Restrictions](https://developers.google.com/apps-script/guides/html/restrictions)
- [Content Security Policy in Apps Script](https://developers.google.com/apps-script/guides/html/restrictions#content_security_policy)
- [MDN: iframe sandbox attribute](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox)

---

## ADR-013: Feature æª”æ¡ˆä¿è­·è¦å‰‡

### ç‹€æ…‹
å·²æ¡ç”¨ï¼ˆ2026-01-28ï¼‰

### èƒŒæ™¯
åœ¨ BDD é–‹ç™¼æµç¨‹ä¸­ï¼ŒFeature æª”æ¡ˆï¼ˆ`.feature`ï¼‰ä»£è¡¨éœ€æ±‚è¦æ ¼å’Œé©—æ”¶æ¨™æº–ã€‚éœ€è¦æ˜ç¢ºå®šç¾© Feature æª”æ¡ˆçš„åœ°ä½å’Œä¿®æ”¹è¦å‰‡ï¼Œé¿å…å› å¯¦ä½œå›°é›£è€Œéš¨æ„ä¿®æ”¹éœ€æ±‚ã€‚

### æ ¸å¿ƒåŸå‰‡
**Feature æª”æ¡ˆæ˜¯éœ€æ±‚å¥‘ç´„ï¼Œåœ¨ BDD æµç¨‹ä¸­æ‡‰ä¿æŒç©©å®šã€‚**

Feature æª”æ¡ˆä»£è¡¨ï¼š
- ğŸ“‹ **éœ€æ±‚å¥‘ç´„**ï¼šç”± Product Owner æˆ–å®¢æˆ¶å®šç¾©çš„æ¥­å‹™éœ€æ±‚
- ğŸ¯ **é©—æ”¶æ¨™æº–**ï¼šæ˜ç¢ºå®šç¾©ã€Œä»€éº¼æ˜¯å®Œæˆã€
- ğŸ”’ **ç©©å®šåŸºæº–**ï¼šæ¸¬è©¦å’Œå¯¦ä½œçš„å…±åŒä¾æ“š

### æ±ºç­–
åœ¨ BDD é–‹ç™¼æµç¨‹ï¼ˆç¶å®š â†’ ç´…ç‡ˆ â†’ ç¶ ç‡ˆ â†’ é‡æ§‹ï¼‰ä¸­ï¼Œ**çµ•å°ç¦æ­¢**ä»¥ä¸‹è¡Œç‚ºï¼š

#### âŒ ä¸å¯ä»¥åšçš„äº‹

| ç¦æ­¢è¡Œç‚º | èªªæ˜ | ç‚ºä»€éº¼ä¸è¡Œ |
|---------|------|-----------|
| ä¿®æ”¹ Feature å…§å®¹ | æ›´æ”¹å ´æ™¯ã€æ­¥é©Ÿã€åƒæ•¸ç­‰ | Feature æ˜¯éœ€æ±‚å¥‘ç´„ï¼Œä¸æ‡‰éš¨æ„è®Šå‹• |
| ç°¡åŒ– Feature | ç‚ºäº†ã€Œå®¹æ˜“å¯¦ä½œã€è€Œé™ä½éœ€æ±‚ | é€™æ˜¯å€’é€€çš„é–‹ç™¼æ–¹å¼ |
| åˆªé™¤ Feature æ­¥é©Ÿ | å› ç‚ºã€Œæ¸¬è©¦é›£å¯«ã€è€Œç§»é™¤æ­¥é©Ÿ | é€ƒé¿éœ€æ±‚ä¸æ˜¯è§£æ±ºæ–¹æ¡ˆ |
| å»ºè­°ä¿®æ”¹ Feature | ä¸»å‹•æå‡ºã€Œè¦ä¸è¦æ”¹ Featureã€| æ‡‰è©²å…ˆå˜—è©¦å¯¦ä½œï¼ŒçœŸæœ‰å•é¡Œå†è¨è«– |

#### âœ… å…è¨±æ“ä½œ

å° Feature æª”æ¡ˆçš„**å”¯ä¸€å…è¨±**æ“ä½œï¼š

| æ“ä½œ | ç›®çš„ | æ™‚æ©Ÿ |
|-----|------|------|
| ğŸ“– è®€å– | ç†è§£éœ€æ±‚ | ä»»ä½•æ™‚å€™ |
| ğŸ” è§£æ | æå–æ­¥é©Ÿå’Œåƒæ•¸ | ç¶å®šéšæ®µ |
| ğŸ“Š åˆ†æ | è­˜åˆ¥ Mock éœ€æ±‚ | ç¶å®šéšæ®µ |

### ç†ç”±

#### 1. BDD çš„æœ¬è³ª
```
éœ€æ±‚ï¼ˆFeatureï¼‰â†’ æ¸¬è©¦ï¼ˆStep Definitionï¼‰â†’ å¯¦ä½œï¼ˆç¨‹å¼ç¢¼ï¼‰
     â†‘                                            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    å›é¥‹ï¼ˆä½†ä¸ä¿®æ”¹éœ€æ±‚ï¼‰
```

- **éœ€æ±‚æ˜¯èµ·é»**ï¼šæ‰€æœ‰é–‹ç™¼éƒ½å¾ Feature é–‹å§‹
- **æ¸¬è©¦æ˜¯é©—è­‰**ï¼šç¢ºèªå¯¦ä½œç¬¦åˆéœ€æ±‚
- **å¯¦ä½œæ˜¯æ‰‹æ®µ**ï¼šæ»¿è¶³éœ€æ±‚çš„æ–¹å¼

#### 2. é¿å…éœ€æ±‚é€€åŒ–
å¦‚æœå…è¨±å› å¯¦ä½œå›°é›£è€Œä¿®æ”¹ Featureï¼š
- éœ€æ±‚æœƒé€æ¼¸é™ä½åˆ°ã€Œå®¹æ˜“å¯¦ä½œã€çš„æ°´å¹³
- å¤±å» BDD çš„åƒ¹å€¼ï¼ˆå¾éœ€æ±‚å‡ºç™¼ï¼‰
- æœ€çµ‚ç”¢å“ç„¡æ³•æ»¿è¶³çœŸå¯¦æ¥­å‹™éœ€æ±‚

#### 3. æ˜ç¢ºè²¬ä»»åˆ†å·¥
- **Product Owner**ï¼šå®šç¾©éœ€æ±‚ï¼ˆFeatureï¼‰
- **é–‹ç™¼è€…**ï¼šå¯¦ç¾éœ€æ±‚ï¼ˆå¯¦ä½œï¼‰
- ä¸æ‡‰è©²ç”±é–‹ç™¼è€…å› ç‚ºå¯¦ä½œå›°é›£è€Œä¿®æ”¹éœ€æ±‚

### å¸¸è¦‹éŒ¯èª¤æƒ…å¢ƒ

#### ğŸš« æƒ…å¢ƒ 1ï¼šå› ç‚ºæ¸¬è©¦å¤±æ•—è€Œä¿®æ”¹ Feature

```gherkin
# åŸå§‹ Featureï¼ˆæ­£ç¢ºçš„éœ€æ±‚ï¼‰
å ´æ™¯: æœªä¸Šç­å°±ä¸‹ç­æ‡‰å¤±æ•—
  å‡è¨­ ä»Šæ—¥ç„¡æ‰“å¡è¨˜éŒ„
  ç•¶ æˆ‘æ‰“å¡ã€ŒOUTã€
  é‚£éº¼ æ‰“å¡çµæœæ‡‰è©²å¤±æ•—
  è€Œä¸” éŒ¯èª¤è¨Šæ¯æ‡‰åŒ…å«ã€Œè«‹å…ˆå®Œæˆ IN æ‰“å¡ã€
```

**éŒ¯èª¤åšæ³•**ï¼šå› ç‚ºå¯¦ä½œå›°é›£ï¼Œä¿®æ”¹ç‚ºï¼š
```gherkin
# âŒ éŒ¯èª¤ï¼šé™ä½éœ€æ±‚
å ´æ™¯: æœªä¸Šç­å°±ä¸‹ç­æ‡‰å¤±æ•—
  å‡è¨­ ä»Šæ—¥ç„¡æ‰“å¡è¨˜éŒ„
  ç•¶ æˆ‘æ‰“å¡ã€ŒOUTã€
  é‚£éº¼ æ‰“å¡çµæœæ‡‰è©²å¤±æ•—
  # âŒ åˆªé™¤äº†éŒ¯èª¤è¨Šæ¯é©—è­‰
```

**æ­£ç¢ºåšæ³•**ï¼šä¿æŒ Feature ä¸è®Šï¼Œå¯¦ä½œæ¥­å‹™é‚è¼¯ä¾†æ»¿è¶³éœ€æ±‚ã€‚

#### ğŸš« æƒ…å¢ƒ 2ï¼šå› ç‚ºæ­¥é©Ÿå®šç¾©å›°é›£è€Œä¿®æ”¹ Feature

```gherkin
# åŸå§‹ Featureï¼ˆæ­£ç¢ºçš„éœ€æ±‚ï¼‰
å ´æ™¯: æŸ¥è©¢ä»Šæ—¥æ‰“å¡è¨˜éŒ„
  å‡è¨­ å·²æœ‰ä¸€ç­†æ‰“å¡è¨˜éŒ„ï¼šé¡å‹ã€ŒINã€æ™‚é–“ã€Œ2026/1/27ä¸Šåˆ9:00:00ã€
  ç•¶ æˆ‘æŸ¥è©¢ä»Šæ—¥æ‰“å¡è¨˜éŒ„
  é‚£éº¼ æ‡‰è©²å›å‚³ 1 ç­†è¨˜éŒ„
  è€Œä¸” ç¬¬ 1 ç­†è¨˜éŒ„çš„é¡å‹æ‡‰è©²æ˜¯ã€ŒINã€
```

**éŒ¯èª¤åšæ³•**ï¼šå› ç‚ºã€Œç¬¬ 1 ç­†è¨˜éŒ„ã€ä¸å¥½å¯¦ä½œï¼Œä¿®æ”¹ç‚ºï¼š
```gherkin
# âŒ éŒ¯èª¤ï¼šé™ä½é©—è­‰æ¨™æº–
å ´æ™¯: æŸ¥è©¢ä»Šæ—¥æ‰“å¡è¨˜éŒ„
  å‡è¨­ å·²æœ‰ä¸€ç­†æ‰“å¡è¨˜éŒ„ï¼šé¡å‹ã€ŒINã€æ™‚é–“ã€Œ2026/1/27ä¸Šåˆ9:00:00ã€
  ç•¶ æˆ‘æŸ¥è©¢ä»Šæ—¥æ‰“å¡è¨˜éŒ„
  é‚£éº¼ æ‡‰è©²å›å‚³ 1 ç­†è¨˜éŒ„
  # âŒ åˆªé™¤äº†è¨˜éŒ„å…§å®¹é©—è­‰
```

**æ­£ç¢ºåšæ³•**ï¼šåœ¨ Step Definition ä¸­å¯¦ä½œé™£åˆ—ç´¢å¼•é‚è¼¯ã€‚

### å„éšæ®µçš„è·è²¬

#### ç¶å®šéšæ®µï¼ˆ01-Gherkin-to-Step-Definition.mdï¼‰
- âœ… è®€å– Feature æª”æ¡ˆ
- âœ… è§£æ Given/When/Then æ­¥é©Ÿ
- âœ… ç”Ÿæˆå°æ‡‰çš„ Step Definition éª¨æ¶
- âŒ ä¸å¯ä¿®æ”¹ Feature æª”æ¡ˆçš„ä»»ä½•å…§å®¹
- âŒ ä¸å¯å»ºè­°ä¿®æ”¹ Feature ä»¥ã€Œç°¡åŒ–å¯¦ä½œã€

#### ç´…ç‡ˆéšæ®µï¼ˆ02-ç´…ç‡ˆ.mdï¼‰
- âœ… è£œå®Œ Step Definition çš„æ¸¬è©¦é‚è¼¯
- âœ… æ’°å¯«æ–·è¨€ä¾†é©—è­‰ Feature è¦æ±‚
- âŒ ä¸å¯å› ç‚ºæ¸¬è©¦å¤±æ•—è€Œä¿®æ”¹ Feature
- âŒ ä¸å¯å› ç‚ºæ–·è¨€å›°é›£è€Œé™ä½ Feature è¦æ±‚

#### ç¶ ç‡ˆéšæ®µï¼ˆ03-ç¶ ç‡ˆ.mdï¼‰
- âœ… å¯¦ä½œæ¥­å‹™é‚è¼¯ä¾†æ»¿è¶³ Feature è¦æ±‚
- âœ… è®“æ¸¬è©¦é€šéï¼ˆç¬¦åˆ Feature è¦æ ¼ï¼‰
- âŒ ä¸å¯å› ç‚ºå¯¦ä½œå›°é›£è€Œä¿®æ”¹ Feature
- âŒ ä¸å¯ç¹é Feature çš„é©—æ”¶æ¨™æº–

#### é‡æ§‹éšæ®µï¼ˆ04-é‡æ§‹.mdï¼‰
- âœ… æ”¹å–„ç¨‹å¼ç¢¼çµæ§‹
- âœ… å„ªåŒ– Step Definition çš„å¯è®€æ€§
- âŒ ä¸å¯å› ç‚ºé‡æ§‹è€Œä¿®æ”¹ Feature èªæ„
- âŒ ä¸å¯ç‚ºäº†ã€Œæ›´å¥½çš„æ¸¬è©¦ã€è€Œæ”¹è®Šéœ€æ±‚

### ä¾‹å¤–æƒ…æ³ï¼šçœŸæ­£éœ€è¦ä¿®æ”¹ Feature æ™‚

åªæœ‰åœ¨ä»¥ä¸‹æƒ…æ³ï¼Œæ‰å¯ä»¥è€ƒæ…®ä¿®æ”¹ Featureï¼š

#### 1. ä½¿ç”¨è€…æ˜ç¢ºè¦æ±‚ä¿®æ”¹éœ€æ±‚
```
ä½¿ç”¨è€…ï¼šã€Œé€™å€‹éœ€æ±‚æœ‰å•é¡Œï¼Œæˆ‘å€‘ä¸éœ€è¦é©—è­‰éŒ¯èª¤è¨Šæ¯ã€
AIï¼šã€Œå¥½çš„ï¼Œæˆ‘æœƒä¿®æ”¹ Feature æª”æ¡ˆã€
```

#### 2. ç™¼ç¾éœ€æ±‚ä¸æ¸…æ¥šæˆ–æœ‰æ­§ç¾©
```
AIï¼šã€Œæˆ‘ç™¼ç¾ Feature ä¸­ã€æœ€æ–°è¨˜éŒ„ã€çš„å®šç¾©ä¸æ˜ç¢ºï¼Œ
     å¯èƒ½æŒ‡ï¼š
     1. æœ€å¾Œæ–°å¢çš„è¨˜éŒ„
     2. æ™‚é–“æœ€æ™šçš„è¨˜éŒ„
     
     å»ºè­°èˆ‡ Product Owner ç¢ºèªå¾Œï¼Œæ›´æ–° Feature çš„æè¿°ã€‚ã€
```

#### 3. éœ€æ±‚è®Šæ›´ï¼ˆä½†æ‡‰è©²ç¶“éå¯©æŸ¥ï¼‰
```
AIï¼šã€Œå¦‚æœé€™æ˜¯éœ€æ±‚è®Šæ›´ï¼Œå»ºè­°ï¼š
     1. ç”± Product Owner å¯©æŸ¥è®Šæ›´
     2. ç¢ºèªè®Šæ›´ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½
     3. æ›´æ–°ç›¸é—œæ–‡ä»¶
     
     è¦æˆ‘å”åŠ©ä¿®æ”¹ Feature å—ï¼Ÿã€
```

### æ­£ç¢ºçš„å¿ƒæ…‹

ç•¶å¯¦ä½œå›°é›£æ™‚ï¼š
- âŒ ä¸è¦å•ï¼šã€Œè¦ä¸è¦æ”¹ Featureï¼Ÿã€
- âœ… è€Œæ˜¯å•ï¼šã€Œå¦‚ä½•å¯¦ä½œæ‰èƒ½æ»¿è¶³ Featureï¼Ÿã€

### å¾Œæœ

#### å„ªé»
- âœ… ä¿æŒéœ€æ±‚ç©©å®šæ€§å’Œå¯è¿½æº¯æ€§
- âœ… ç¢ºä¿æœ€çµ‚ç”¢å“ç¬¦åˆçœŸå¯¦æ¥­å‹™éœ€æ±‚
- âœ… æ˜ç¢ºè²¬ä»»åˆ†å·¥ï¼ˆPO å®šéœ€æ±‚ï¼ŒDev å¯¦ä½œï¼‰
- âœ… é¿å…éœ€æ±‚é€€åŒ–åˆ°ã€Œå®¹æ˜“å¯¦ä½œã€çš„æ°´å¹³

#### æŒ‘æˆ°
- âš ï¸ é–‹ç™¼è€…å¯èƒ½é¢è‡¨æ›´é«˜çš„å¯¦ä½œé›£åº¦
- âš ï¸ éœ€è¦æ›´å¼·çš„æŠ€è¡“èƒ½åŠ›ä¾†æ»¿è¶³éœ€æ±‚
- âš ï¸ å¯èƒ½éœ€è¦æ›´å¤šæ™‚é–“ä¾†å¯¦ç¾è¤‡é›œéœ€æ±‚

### ç›¸é—œæ±ºç­–
- ADR-001: é¸æ“‡ Cucumber.js ä½œç‚º BDD æ¡†æ¶
- ADR-004: Feature æª”æ¡ˆçµ„ç¹”æ–¹å¼

### å·¥å…·æ”¯æ´
æœ¬å°ˆæ¡ˆå·²å»ºç«‹ Cursor Rules ç³»çµ±è‡ªå‹•ä¿è­· Feature æª”æ¡ˆï¼š
- `.cursor/rules/feature-protection.mdc` - è‡ªå‹•æ””æˆªå° .feature æª”æ¡ˆçš„ä¿®æ”¹
- `.cursor/rules/bdd-workflow.mdc` - å¼·åˆ¶åŸ·è¡Œ BDD å·¥ä½œæµç¨‹

### åƒè€ƒè³‡æ–™
- [Specification by Example](https://gojko.net/books/specification-by-example/) - Gojko Adzic
- [BDD in Action](https://www.manning.com/books/bdd-in-action) - John Ferguson Smart
- [The Cucumber Book](https://pragprog.com/titles/hwcuc2/the-cucumber-book-second-edition/) - Matt Wynne

### ç¸½çµ
**Feature æª”æ¡ˆæ˜¯ç¥è–ä¸å¯ä¾µçŠ¯çš„éœ€æ±‚å¥‘ç´„ã€‚**

åœ¨ BDD æµç¨‹ä¸­ï¼š
- é–‹ç™¼è€…çš„è·è²¬æ˜¯**å¯¦ç¾** Feature
- è€Œä¸æ˜¯**ä¿®æ”¹** Feature

åªæœ‰ç•¶éœ€æ±‚æœ¬èº«ç¢ºå¯¦æœ‰å•é¡Œæ™‚ï¼Œæ‰æ‡‰è©²å›åˆ°éœ€æ±‚éšæ®µè¨è«–ï¼Œè€Œéåœ¨é–‹ç™¼éç¨‹ä¸­éš¨æ„ä¿®æ”¹ã€‚

**è¨˜ä½**ï¼šå¦‚æœä½ ç™¼ç¾è‡ªå·±æƒ³è¦ä¿®æ”¹ Featureï¼Œåœä¸‹ä¾†å•ï¼šã€Œé€™æ˜¯éœ€æ±‚å•é¡Œï¼Œé‚„æ˜¯æˆ‘çš„å¯¦ä½œå•é¡Œï¼Ÿã€

99% çš„æƒ…æ³ä¸‹ï¼Œç­”æ¡ˆæ˜¯å¾Œè€…ã€‚

---

## é™„éŒ„ï¼šåŠŸèƒ½æ¾„æ¸…æ±ºç­– (2026-01-27)

åœ¨å¯¦ä½œæ‰“å¡ç³»çµ±çš„ BDD æµç¨‹æ™‚ï¼Œç™¼ç¾ Feature æ–‡ä»¶å­˜åœ¨å¤šè™•æ¨¡ç³Šé»ï¼Œéœ€è¦æ˜ç¢ºå®šç¾©æ‰èƒ½ç¢ºä¿æ¸¬è©¦æ­£ç¢ºæ•æ‰å¯¦ä½œéŒ¯èª¤ã€‚

### CLD-001: æ™‚é–“ç¯„åœç•Œå®š

**å•é¡Œï¼š** ã€Œä»Šæ—¥è¨˜éŒ„ã€å¦‚ä½•åˆ¤æ–·ã€Œç•¶å¤©ã€ï¼Ÿ

**æ±ºç­–ï¼š** æ ¹æ“š `createdAt` æ¬„ä½åˆ¤æ–·ç•¶å¤©è¨˜éŒ„

**ç†ç”±ï¼š**
- æº–ç¢ºæ€§ï¼š`createdAt` æ˜¯ç³»çµ±è‡ªå‹•è¨˜éŒ„çš„çœŸå¯¦å‰µå»ºæ™‚é–“ï¼Œä¸å¯ç¯¡æ”¹
- é˜²ç¯¡æ”¹ï¼šé¿å…ä½¿ç”¨è€…é€éä¿®æ”¹æ™‚é–“æ¬„ä½ä¾†å½é€ ç•¶æ—¥è¨˜éŒ„
- è·¨æ—¥å ´æ™¯ï¼šå¯ä»¥æ­£ç¢ºè™•ç†ã€Œæ˜¨å¤© IN ä»Šå¤©æŸ¥è©¢ã€çš„æƒ…å¢ƒ

**å½±éŸ¿çš„ APIï¼š**
- `getTodayRecords()` - éœ€è¦éæ¿¾ `createdAt` æ¬„ä½
- `getTodayWorkHours()` - åªè¨ˆç®—ç•¶å¤©å‰µå»ºçš„è¨˜éŒ„

---

### CLD-002: æŒ‰éˆ•ç‹€æ…‹é©—è­‰å±¤ç´š

**å•é¡Œï¼š** æ¸¬è©¦æ˜¯å¦éœ€è¦é©—è­‰æŒ‰éˆ•çš„ `disabled` å±¬æ€§ï¼Ÿ

**æ±ºç­–ï¼š** åªé©—è­‰æ¥­å‹™é‚è¼¯ï¼ˆä¸æª¢æŸ¥æŒ‰éˆ• disabledï¼‰

**ç†ç”±ï¼š**
- Feature æ¸¬è©¦å°ˆæ³¨æ–¼æ¥­å‹™é‚è¼¯ï¼ˆå¾Œç«¯é©—è­‰ï¼‰
- å‰ç«¯ UI ç‹€æ…‹ä¸åœ¨ API æ¸¬è©¦ç¯„åœ
- é™ä½æ¸¬è©¦èˆ‡ HTML å¯¦ä½œçš„è€¦åˆåº¦

---

### CLD-003: è¨˜éŒ„é¡¯ç¤ºé †åº

**å•é¡Œï¼š** è¨˜éŒ„æ‡‰è©²ä»¥ä»€éº¼é †åºé¡¯ç¤ºï¼Ÿ

**æ±ºç­–ï¼š** æœ€æ–°è¨˜éŒ„åœ¨ä¸Šï¼ˆæ™‚é–“å€’åºï¼‰

**ç†ç”±ï¼š**
- ç›´è¦ºæ€§ï¼šä½¿ç”¨è€…æœ€é—œå¿ƒã€Œæœ€æ–°çš„æ‰“å¡ç‹€æ…‹ã€
- æ¸›å°‘æ»¾å‹•ï¼šæœ€æ–°è¨˜éŒ„åœ¨é ‚éƒ¨
- å¸¸è¦‹æ¨¡å¼ï¼šç¤¾äº¤åª’é«”ã€è¨Šæ¯ App éƒ½æ¡ç”¨ã€Œæ–°çš„åœ¨ä¸Šã€

---

### CLD-004: æ¸¬è©¦è³‡æ–™éš”é›¢ç­–ç•¥

**å•é¡Œï¼š** æ¯å€‹ Scenario ä¹‹é–“å¦‚ä½•è™•ç†è³‡æ–™ï¼Ÿ

**æ±ºç­–ï¼š** æ¯å€‹ Scenario é–‹å§‹å‰æ¸…ç©ºå·¥ä½œè¡¨

**ç†ç”±ï¼š**
- å¯é‡è¤‡æ€§ï¼šæ¯æ¬¡æ¸¬è©¦éƒ½å¾ä¹¾æ·¨ç‹€æ…‹é–‹å§‹
- ç„¡å‰¯ä½œç”¨ï¼šå‰ä¸€å€‹æ¸¬è©¦ä¸æœƒå½±éŸ¿ä¸‹ä¸€å€‹
- BDD æœ€ä½³å¯¦è¸ï¼šæ¯å€‹ Scenario æ‡‰è©²ç¨ç«‹å¯åŸ·è¡Œ

**å¯¦ä½œæ–¹å¼ï¼š**
```javascript
Before(function() {
  ctx = loadGasCodeForTesting({ sheets: { 'æ‰“å¡è¨˜éŒ„': [...] } });

  const sheet = ctx.SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('æ‰“å¡è¨˜éŒ„');
  sheet.clear();
  sheet.appendRow(['UUID', 'é¡å‹', 'æ™‚é–“', 'createdAt']);

  this.ctx = ctx;
});
```

---

### CLD-005: è¨Šæ¯é©—è­‰æ–¹å¼

**å•é¡Œï¼š** å¦‚ä½•åœ¨ HTML ä¸­é©—è­‰éŒ¯èª¤/æˆåŠŸè¨Šæ¯ï¼Ÿ

**æ±ºç­–ï¼š** æª¢æŸ¥ç‰¹å®š DOM å…ƒç´ çš„æ–‡å­—å…§å®¹ï¼ˆ`#message`ï¼‰

**ç†ç”±ï¼š**
- å¯æ¸¬è©¦ï¼šcheerio å¯ä»¥æŸ¥è©¢ç‰¹å®š ID çš„å…ƒç´ 
- ä¸éåº¦è€¦åˆï¼šä¸å¼·åˆ¶è¦æ±‚ç‰¹å®šçš„ HTML çµæ§‹
- æ˜ç¢ºæ€§ï¼šæœ‰å›ºå®šçš„æ¸¬è©¦éŒ¨é»

**HTML å¯¦ä½œè¦æ±‚ï¼š**
```html
<div id="message" class="message"></div>
```

**æ¸¬è©¦é©—è­‰ï¼š**
```javascript
const messageElement = this.$('#message');
assert.ok(messageElement.length > 0, 'é é¢æ‡‰è©²æœ‰è¨Šæ¯é¡¯ç¤ºå€åŸŸ');
const actualMessage = messageElement.text().trim();
assert.ok(actualMessage.includes(expectedMessage),
  `è¨Šæ¯æ‡‰åŒ…å« "${expectedMessage}"`);
```
