# Apps Script BDD Workshop 改良紀錄

## 設計決策

- **Loader 設計**：設定檔模式（傳入 config 物件指定導出函式）
- **Prompt 語言**：中文
- **範例處理**：保留打卡專案作為參考範例

---

## 已完成的改良

### 1. Mock 基礎設施通用化

#### `lib/gas-mock.js`

**改良內容**：
- `createMockSheet()` 標題列可設定（不再寫死）
- `createMockGoogleScriptRun()` 使用 Proxy 動態代理，可呼叫任何後端函式
- 新增序列化檢查（Date 物件、NaN 檢測）
- 新增 HtmlService 模板語法支援

```javascript
// 標題列可設定
export function createMockSheet(headers = []) {
  let data = headers.length > 0 ? [headers] : [];
  // ...
}

// 動態代理任何函式呼叫
export function createMockGoogleScriptRun(gasContext) {
  return new Proxy({}, {
    get(target, prop) {
      // 動態攔截任何函式呼叫
    }
  });
}
```

### 2. Loader 通用化

#### `lib/gas-loader.js`

**改良內容**：
- 導出函式名稱可設定（不再寫死）
- 工作表名稱和標題列可設定

```javascript
// 接受設定參數
export function loadGasCodeForTesting(config = {}) {
  const {
    codePath = 'src/程式碼.js',
    exports = [],        // 要導出的函式/常數名稱
    sheets = {}          // { '工作表名稱': ['欄位1', '欄位2'] }
  } = config;
  // ...
}
```

### 3. Prompts 改寫（適配 Apps Script + Cucumber.js）

現有 prompts 已改成 **Apps Script + Cucumber.js** 版本：

| 檔案 | 用途 |
|------|------|
| `01-Gherkin-to-Step-Definition.md` | Gherkin → Step Definitions |
| `02-紅燈.md` | Cucumber.js 紅燈階段 |
| `03-綠燈.md` | npm test + Trial-and-Error |
| `04-重構.md` | Apps Script 架構重構 |
| `架構決策文件.md` | 架構 ADR 記錄 |
| `Mock學習指南.md` | Mock 使用指南 |

---

## 架構決策記錄

詳見 [架構決策文件.md](./架構決策文件.md)，包含：

- ADR-001: 選擇 Cucumber.js 作為 BDD 框架
- ADR-002: 使用 Node.js VM 沙箱執行 Apps Script
- ADR-003: Mock 策略
- ADR-004: Feature 檔案組織方式
- ADR-005: 測試上下文管理
- ADR-006: 設定檔設計
- ADR-007: google.script.run 序列化限制
- ADR-008: 獨立腳本 vs 綁定腳本
- ADR-009: 中文日期格式處理
- ADR-010: Google Sheet 地區設定對時間格式的影響
- ADR-011: Mock 必須準確模擬 HtmlService 模板語法
- ADR-012: GAS Web App iframe sandbox 限制與頁面更新策略
