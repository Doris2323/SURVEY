# 打卡功能範例解說

這份文件將帶你走過一個完整的 BDD 開發週期，以「新增上班打卡」為例。

## 目標功能

```gherkin
場景: 新增上班打卡
  假設 系統已準備好「打卡記錄」工作表
  當 我執行「IN」打卡
  那麼 打卡結果應該成功
  而且 工作表應該有 1 筆記錄
  而且 最新記錄的類型應該是「IN」
```

## 步驟 1：綁定測試

### 使用 Prompt

複製以下指令給 AI 助手：

```
do: @prompts/01-Gherkin-to-Step-Definition.md
for: @features/打卡記錄.feature
```

AI 會產生 Step Definition

### 產生的 Step Definition

```javascript
// features/step_definitions/打卡.steps.js

import { Given, When, Then, Before } from '@cucumber/cucumber';
import { strict as assert } from 'assert';
import { loadGasCodeForTesting } from '../../lib/gas-loader.js';

let ctx;

Before(function() {
  ctx = loadGasCodeForTesting({
    sheets: {
      '打卡記錄': ['ID', '類型', '時間', '建立時間']
    }
  });
});

Given('系統已準備好「{string}」工作表', function(sheetName) {
  const sheet = ctx._getSheet(sheetName);
  assert.ok(sheet, `工作表 "${sheetName}" 應該存在`);
});

When('我執行「{word}」打卡', function(type) {
  try {
    this.result = ctx.punch(type);  // 呼叫尚未實作的函式
  } catch (error) {
    this.error = error;
  }
});

Then('打卡結果應該成功', function() {
  assert.ok(!this.error, `不應該有錯誤: ${this.error?.message}`);
  assert.ok(this.result?.success, '打卡應該成功');
});

Then('工作表應該有 {int} 筆記錄', function(expectedCount) {
  const sheet = ctx._getSheet('打卡記錄');
  const data = sheet.getDataRange().getValues();
  const actualCount = data.length - 1;
  assert.strictEqual(actualCount, expectedCount);
});

Then('最新記錄的類型應該是「{word}」', function(expectedType) {
  const sheet = ctx._getSheet('打卡記錄');
  const data = sheet.getDataRange().getValues();
  const lastRow = data[data.length - 1];
  assert.strictEqual(lastRow[1], expectedType);
});
```

## 步驟 2：紅燈

### 執行測試

```bash
npm test
```

### 預期結果

```
Feature: 打卡記錄

  Scenario: 新增上班打卡
    ✔ Given 系統已準備好「打卡記錄」工作表
    ✖ When 我執行「IN」打卡
        ReferenceError: ctx.punch is not defined
    - Then 打卡結果應該成功
    - And 工作表應該有 1 筆記錄
    - And 最新記錄的類型應該是「IN」

1 scenario (1 failed)
5 steps (1 failed, 3 skipped, 1 passed)
```

### 解讀

- `✔` Given 通過：工作表已建立
- `✖` When 失敗：`punch` 函式不存在
- `-` Then 跳過：因為 When 失敗了

這就是**紅燈**！表示測試正確偵測到缺失的實作。

## 步驟 3：綠燈

### 使用 Prompt

複製以下指令給 AI 助手：

```
do: @prompts/03-綠燈.md
for: @features/打卡記錄.feature
```

AI 會根據紅燈錯誤訊息產生最小實作

### 產生的實作

```javascript
// src/程式碼.js

/**
 * 執行打卡
 * @param {string} type - 打卡類型 (IN/OUT)
 * @returns {Object} 打卡結果
 */
function punch(type) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('打卡記錄');

  // 產生新記錄
  const id = Utilities.getUuid();
  const now = new Date();

  // 新增記錄
  sheet.appendRow([id, type, now, now]);

  return {
    success: true,
    id: id,
    type: type,
    time: now
  };
}
```

### 再次執行測試

```bash
npm test
```

### 預期結果

```
Feature: 打卡記錄

  Scenario: 新增上班打卡
    ✔ Given 系統已準備好「打卡記錄」工作表
    ✔ When 我執行「IN」打卡
    ✔ Then 打卡結果應該成功
    ✔ And 工作表應該有 1 筆記錄
    ✔ And 最新記錄的類型應該是「IN」

1 scenario (1 passed)
5 steps (5 passed)
```

這就是**綠燈**！所有測試通過。

## 步驟 4：重構

### 檢視程式碼

現在程式碼可以運作，但可能有改善空間：

1. 沒有驗證 type 參數
2. 沒有處理工作表不存在的情況
3. 沒有防止重複打卡

### 使用 Prompt

複製以下指令給 AI 助手：

```
do: @prompts/04-重構.md
for: @src/程式碼.js
```

AI 會根據目前實作建議重構方向

### 重構後的程式碼

```javascript
// src/程式碼.js

const SHEET_NAME = '打卡記錄';
const VALID_TYPES = ['IN', 'OUT'];

/**
 * 執行打卡
 * @param {string} type - 打卡類型 (IN/OUT)
 * @returns {Object} 打卡結果
 */
function punch(type) {
  // 驗證類型
  if (!VALID_TYPES.includes(type)) {
    return {
      success: false,
      message: `無效的打卡類型: ${type}`
    };
  }

  const sheet = getSheet(SHEET_NAME);
  if (!sheet) {
    return {
      success: false,
      message: `找不到工作表: ${SHEET_NAME}`
    };
  }

  // 產生新記錄
  const id = Utilities.getUuid();
  const now = new Date();

  // 新增記錄
  sheet.appendRow([id, type, now, now]);

  return {
    success: true,
    id: id,
    type: type,
    time: now
  };
}

/**
 * 取得工作表
 * @param {string} name - 工作表名稱
 * @returns {Sheet|null}
 */
function getSheet(name) {
  return SpreadsheetApp.getActiveSpreadsheet().getSheetByName(name);
}
```

### 確認測試仍然通過

```bash
npm test
```

## 完整週期

```
┌──────────────────────────────────────────────────────────┐
│                                                          │
│   1. Feature        2. 紅燈         3. 綠燈     4. 重構  │
│   ┌─────────┐      ┌─────────┐     ┌─────────┐  ┌─────┐  │
│   │ Gherkin │ ──→  │  測試   │ ──→ │  實作   │ ─│改善 │  │
│   │  規格   │      │  失敗   │     │  通過   │  │品質 │  │
│   └─────────┘      └─────────┘     └─────────┘  └─────┘  │
│        │                                           │     │
│        └───────────── 下一個場景 ←─────────────────┘     │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

## 練習

試著完成 `打卡記錄.feature` 中的其他場景：

1. **新增下班打卡** - 需要檢查是否已有 IN 記錄
2. **連續上班打卡應失敗** - 需要驗證邏輯
3. **未上班就下班打卡應失敗** - 需要驗證邏輯

## 下一步

閱讀 [04-如何新增自己的功能.md](./04-如何新增自己的功能.md) 學習如何新增自己的功能。
