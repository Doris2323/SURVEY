# Feature 規格澄清決策 (2026-01-27)

## 背景

在實作打卡系統的 BDD 流程時，發現 Feature 文件存在多處模糊點，需要明確定義才能確保測試正確捕捉實作錯誤。

## 澄清的問題與決策

### 決策 1: 時間範圍界定（高優先）

**問題：** 「今日記錄」是否只顯示當天的打卡？如何判斷「當天」？

**決策：** ✅ **根據 `createdAt` 欄位判斷當天記錄**

**理由：**
- 準確性：打卡的「時間」欄位可能被手動修改，但 `createdAt` 是系統自動記錄的真實創建時間
- 防篡改：避免使用者透過修改時間欄位來偽造當日記錄
- 跨日場景：可以正確處理「昨天 IN 今天查詢」的情境（不會顯示昨天的未配對記錄）

**影響的 API：**
- `getTodayRecords()` - 需要過濾 `createdAt` 欄位（ISO 格式）與當前日期
- `getTodayWorkHours()` - 只計算當天創建的記錄的工時

**測試驗證：**
- 添加跨日測試：昨天創建的記錄今天不應該出現
- 測試應該捕捉「未過濾日期」的錯誤

---

### 決策 2: HTML 按鈕狀態驗證層級（高優先）

**問題：** 測試是否需要驗證按鈕的 `disabled` 屬性？

**決策：** ✅ **只驗證能否執行打卡（不檢查按鈕 disabled）**

**理由：**
- Feature 測試專注於業務邏輯（後端驗證）
- 前端 UI 狀態（disabled）不在 API 測試範圍
- 降低測試與 HTML 實作的耦合度

**測試策略：**
- 驗證點擊後的「錯誤訊息」
- 驗證 API 的驗證邏輯（例如：未 IN 就 OUT 會失敗）
- 不強制要求 HTML 實作 disabled 屬性

---

### 決策 3: 記錄顯示順序（中優先）

**問題：** 記錄應該以什麼順序顯示？

**決策：** ✅ **最新記錄在上（時間倒序）**

**理由：**
- 直覺性：使用者最關心「最新的打卡狀態」
- 減少滾動：最新記錄在頂部，不需要滾動到底部
- 常見模式：社交媒體、訊息 App 都採用「新的在上」

**影響的 API：**
- `getTodayRecords()` - 返回倒序排列的記錄
- `getWebPageData()` - records 陣列第一筆 = 最新記錄

**Feature 文件更新：**
- 添加明確說明：「記錄以時間倒序排列（最新在上）」
- 添加測試案例驗證順序

---

### 決策 4: 測試資料隔離策略（中優先）

**問題：** 每個 Scenario 之間如何處理資料？

**決策：** ✅ **每個 Scenario 開始前清空工作表**

**理由：**
- 可重複性：每次測試都從乾淨狀態開始
- 無副作用：前一個測試不會影響下一個
- 明確性：`Given 今日無打卡記錄` 真的是「無記錄」
- BDD 最佳實踐：每個 Scenario 應該獨立可執行

**實作方式：**
```javascript
Before(function() {
  // 初始化環境
  ctx = loadGasCodeForTesting({ sheets: { '打卡記錄': [...] } });
  
  // 關鍵：清空工作表
  const sheet = ctx.SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('打卡記錄');
  sheet.clear();
  sheet.appendRow(['UUID', '類型', '時間', 'createdAt']);
  
  this.ctx = ctx;
});
```

---

### 決策 5: 錯誤/成功訊息驗證方式（高優先）

**問題：** 如何在 HTML 中驗證訊息？

**決策：** ✅ **檢查特定 DOM 元素的文字內容**

**理由：**
- 可測試：cheerio 可以查詢特定 ID/class 的元素
- 不過度耦合：不強制要求特定的 HTML 結構
- 明確性：有固定的測試錨點（例如 `#message` div）
- 符合實務：前端框架通常有專門的訊息顯示區域

**HTML 實作要求：**
```html
<div id="message" class="message"></div>
```

**測試驗證：**
```javascript
// 決策 5: 檢查特定 DOM 元素
const messageElement = this.$('#message');
assert.ok(messageElement.length > 0, '頁面應該有訊息顯示區域');
const actualMessage = messageElement.text().trim();
assert.ok(actualMessage.includes(expectedMessage), 
  `訊息應包含 "${expectedMessage}"`);
```

---

## 實作影響總結

### Feature 文件需要更新的地方

1. **打卡記錄.feature (第 76 行附近)**
   - 添加說明：「查詢今日記錄基於 createdAt 欄位」
   - 添加跨日測試案例

2. **頁面流程.feature (第 43 行附近)**
   - 添加說明：「記錄以時間倒序排列（最新在上）」
   - 添加記錄順序測試案例

### Prompts 需要更新的地方

1. **01-Gherkin-to-Step-Definition.md**
   - 添加「Before hook 應清空工作表」的最佳實踐
   - 添加「使用 #message 元素驗證訊息」的範例

2. **02-紅燈.md**
   - 強調「測試應該能捕捉日期過濾錯誤」
   - 強調「測試應該能捕捉 HTML 缺失錯誤」

### Mock 環境已支援的功能

✅ **gas-mock.js** 已支援：
- `HtmlService.createHtmlOutputFromFile()` - 實際讀取 HTML 檔案
- `createdAt` 欄位模擬 - 使用 `new Date().toISOString()`
- 工作表清空 - `sheet.clear()` 和 `sheet.appendRow()`

✅ **gas-loader.js** 已支援：
- 自動載入 GAS 程式碼
- Mock 所有需要的 Google API

---

## 驗證清單

- [x] 決策 1: Mock 支援 createdAt 欄位過濾
- [x] 決策 2: 測試專注於業務邏輯，不檢查 disabled
- [ ] 決策 3: Feature 文件明確說明記錄順序
- [x] 決策 4: Before hook 實作工作表清空
- [x] 決策 5: HTML 包含 #message 元素，測試可驗證

---

## 下一步行動

1. **更新 Feature 文件** - 添加決策 1 和決策 3 的說明
2. **更新 Prompts** - 將這些最佳實踐寫入 prompts
3. **創建範例** - 在 prompts 中添加完整的範例
4. **記錄學習** - 更新 Mock學習指南.md

---

## 參考

- Clarification Session: 2026-01-27
- Related Files:
  - `features/打卡記錄.feature`
  - `features/頁面流程.feature`
  - `lib/gas-mock.js`
  - `features/step_definitions/打卡記錄.steps.js`
