# BDD 流程改進總結

> 2026-01-27 完成的 Feature 規格澄清與文檔優化

## 📋 改進目標

**核心目標：** 優化 BDD 流程的 prompts、mock 和 feature 文件，確保 BDD 後可以產生可執行的 Web App。

**不是實作程式碼**，而是建立清晰的規範和最佳實踐指南。

---

## ✅ 完成的工作

### 1. 澄清會議 (5 個關鍵決策)

透過系統化的澄清流程，解決了 Feature 文件中的模糊點：

| 決策 | 問題 | 解決方案 | 影響 |
|------|------|----------|------|
| 1 | 「今日記錄」如何定義？ | 使用 createdAt 欄位判斷 | 防止時間欄位被篡改 |
| 2 | 需要驗證 disabled 屬性嗎？ | 否，只驗證業務邏輯 | 降低測試與 UI 耦合 |
| 3 | 記錄順序如何排列？ | 最新記錄在上（倒序） | 符合使用者直覺 |
| 4 | 測試資料如何隔離？ | 每個 Scenario 前清空 | 確保測試獨立執行 |
| 5 | 如何驗證訊息顯示？ | 檢查 #message 元素 | 可測試且不過度耦合 |

詳見：`docs/澄清決策-2026-01-27.md`

### 2. 文檔創建與更新

#### 新增文檔

1. **`docs/澄清決策-2026-01-27.md`**
   - 記錄所有澄清決策
   - 說明每個決策的理由和影響
   - 提供實作指引和測試驗證方法

2. **`docs/Mock環境驗證清單.md`**
   - 驗證 Mock 環境支援所有決策
   - 列出 Mock 功能清單
   - 提供驗證測試腳本

3. **`prompts/BDD-最佳實踐.md`**
   - 總結打卡系統的實戰經驗
   - 提供 DO/DON'T 範例
   - 建立可重複使用的最佳實踐指南

#### 更新文檔

1. **`features/打卡記錄.feature`**
   - 添加澄清註解：說明使用 createdAt 判斷當天
   - 明確記錄日期過濾的邏輯

2. **`features/頁面流程.feature`**
   - 添加澄清註解：說明記錄倒序排列
   - 明確記錄顯示順序的規則

### 3. Mock 環境驗證

驗證結果：**✅ 所有決策都已在 Mock 環境中得到支援**

- ✅ createdAt 欄位支援（ISO 格式時間戳記）
- ✅ 工作表清空功能（sheet.clear()）
- ✅ HTML 檔案讀取（實際讀取 src/Index.html）
- ✅ HTML 解析（cheerio）
- ✅ 元素查詢（$('#message')）

詳見：`docs/Mock環境驗證清單.md`

---

## 📚 產出的文檔結構

```
workshop_clock_in_v2/
├── docs/
│   ├── 澄清決策-2026-01-27.md          ← 決策記錄
│   ├── Mock環境驗證清單.md             ← Mock 驗證
│   └── BDD流程改進總結.md (本文件)     ← 總結文檔
├── prompts/
│   ├── BDD-最佳實踐.md                 ← 新增：最佳實踐指南
│   ├── 01-Gherkin-to-Step-Definition.md
│   ├── 02-紅燈.md
│   ├── 03-綠燈.md
│   └── 04-重構.md
└── features/
    ├── 打卡記錄.feature                 ← 已更新：添加澄清註解
    └── 頁面流程.feature                 ← 已更新：添加澄清註解
```

---

## 🎓 關鍵學習

### 1. 澄清的重要性

**問題：** Feature 文件中的「今日記錄」有多種解釋
- 基於「時間」欄位？（可被修改）
- 基於「createdAt」欄位？（系統自動記錄）

**教訓：** 看似簡單的需求背後有複雜的決策，必須明確記錄。

### 2. 測試要能失敗

**問題：** 假斷言 `assert.ok(true)` 永遠通過
```javascript
// Bad: 無法捕捉錯誤
Then('頁面應該顯示錯誤訊息', function() {
  assert.ok(true, '應該有錯誤訊息');
});
```

**教訓：** 測試必須真實驗證，才能捕捉實作錯誤。

### 3. Mock 要貼近現實

**問題：** HtmlService 返回假內容，無法測試「檔案不存在」
```javascript
// Bad: 永遠成功
createHtmlOutputFromFile(filename) {
  return { getContent() { return '<html>Mock</html>'; } };
}
```

**教訓：** Mock 應該實際讀取檔案，測試才能捕捉真實錯誤。

### 4. 測試要獨立

**問題：** 測試資料累積，導致後續測試失敗
```javascript
// Scenario 1: 新增 1 筆記錄
// Scenario 2: 期望 1 筆，實際有 2 筆（包含 Scenario 1 的）
```

**教訓：** Before hook 清空資料，確保測試獨立。

### 5. 決策要記錄

**問題：** 未來維護時不知道為什麼這樣設計

**教訓：**
- 寫在 Feature 文件的註解中
- 寫在專門的決策文檔中
- 寫在 prompts 的最佳實踐中

---

## 🚀 如何使用這些文檔

### 對於開發者

1. **開始新 Feature 時**
   - 閱讀：`prompts/BDD-最佳實踐.md`
   - 參考：現有 Feature 文件的澄清註解
   - 使用：`prompts/01-Gherkin-to-Step-Definition.md` 生成骨架

2. **遇到模糊需求時**
   - 參考：`docs/澄清決策-2026-01-27.md` 的決策格式
   - 執行：澄清流程（問題 → 選項 → 決策 → 記錄）
   - 更新：Feature 文件和決策文檔

3. **測試失敗時**
   - 檢查：是否遵循「測試隔離」原則
   - 驗證：Mock 環境是否支援（參考驗證清單）
   - 確認：是否使用真實驗證（避免假斷言）

### 對於專案管理者

1. **評估進度時**
   - 檢查：Feature 文件是否有澄清註解
   - 確認：模糊需求是否已記錄決策
   - 驗證：測試是否能捕捉錯誤（破壞性測試）

2. **程式碼審查時**
   - 確認：Step Definitions 是否有 Before hook 清空資料
   - 檢查：斷言是否為真實驗證（不是 `assert.ok(true)`）
   - 驗證：Mock 是否貼近現實（例如讀取真實檔案）

---

## 📊 改進前後對比

### Feature 文件品質

| 項目 | 改進前 | 改進後 |
|------|--------|--------|
| 時間判斷邏輯 | ❓ 不明確 | ✅ 明確使用 createdAt |
| 記錄順序 | ❓ 未定義 | ✅ 明確倒序（最新在上） |
| 測試隔離 | ❌ 資料累積 | ✅ 每個 Scenario 清空 |
| HTML 驗證 | ❌ 假斷言 | ✅ 真實查詢 #message |
| 決策記錄 | ❌ 無記錄 | ✅ 文檔化 |

### Mock 環境完整性

| 功能 | 改進前 | 改進後 |
|------|--------|--------|
| HtmlService | ❌ 返回假內容 | ✅ 讀取真實檔案 |
| 測試隔離 | ❌ 未實作 | ✅ Before hook 清空 |
| 元素查詢 | ❌ 無法驗證 | ✅ cheerio 解析 HTML |
| 錯誤捕捉 | ❌ 無法捕捉 | ✅ 可捕捉檔案缺失 |

---

## 🎯 下一步建議

### 短期（立即可做）

1. **執行完整的 BDD 流程**
   ```bash
   # 紅燈 → 綠燈 → 重構
   npm test  # 確認紅燈
   # 實作程式碼
   npm test  # 確認綠燈
   # 重構
   ```

2. **添加記錄順序測試**
   - 在 Feature 文件中添加測試案例
   - 驗證 `records[0]` 是最新記錄

3. **執行破壞性測試**
   ```bash
   # 驗證測試的有效性
   rm src/Index.html && npm test  # 應該失敗
   ```

### 中期（後續優化）

1. **時間 Mock 增強**
   - 支援 Mock 固定時間
   - 方便測試跨日場景

2. **添加更多 HTML 驗證**
   - 驗證按鈕存在
   - 驗證列表渲染
   - 驗證工時顯示

3. **建立 Feature 範本**
   - 包含所有最佳實踐的註解
   - 包含常用的 Scenario 範例

### 長期（流程建立）

1. **建立澄清檢查清單**
   - 新 Feature 必須經過澄清
   - 模糊需求必須記錄決策

2. **自動化驗證**
   - CI/CD 執行破壞性測試
   - 自動檢查假斷言

3. **團隊培訓**
   - 分享 BDD 最佳實踐
   - 建立共同的測試文化

---

## 📖 參考文檔索引

### 核心文檔
- **澄清決策記錄**: `docs/澄清決策-2026-01-27.md`
- **Mock 環境驗證**: `docs/Mock環境驗證清單.md`
- **BDD 最佳實踐**: `prompts/BDD-最佳實踐.md`

### Feature 文件
- **打卡記錄**: `features/打卡記錄.feature`
- **頁面流程**: `features/頁面流程.feature`

### Prompts
- **Step Definition 生成**: `prompts/01-Gherkin-to-Step-Definition.md`
- **紅燈階段**: `prompts/02-紅燈.md`
- **綠燈階段**: `prompts/03-綠燈.md`
- **重構階段**: `prompts/04-重構.md`

### 學習資源
- **Mock 學習指南**: `prompts/Mock學習指南.md`
- **Mock 環境改進**: `prompts/更新紀錄-Mock環境改進.md`

---

## ✅ 結論

**這次改進的核心價值：**

1. **明確性** - 所有模糊需求都已澄清並記錄
2. **可測試性** - Mock 環境支援所有驗證需求
3. **可重複性** - 建立了可重複使用的最佳實踐
4. **可維護性** - 決策記錄在文檔中，未來可追溯

**現在可以自信地執行 BDD 流程，產生可執行的 Web App！** 🎉

---

*最後更新：2026-01-27*
*作者：AI Assistant*
*專案：workshop_clock_in_v2*
