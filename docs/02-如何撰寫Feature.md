# 如何撰寫 Feature

## Feature 檔案結構

Feature 檔案使用 `.feature` 副檔名，放在 `features/` 資料夾。

```gherkin
# language: en              ← 使用英文關鍵字

Feature: 功能名稱            ← 中文描述
  作為一個 [角色]            ← 使用者故事
  我想要 [目標]
  以便 [價值]

  Background:
    Given 前置條件設定

  Rule: 規則描述             ← 原子化規則
    Example: 場景名稱        ← 具體範例
      Given [前置條件]
      When [執行動作]
      Then [預期結果]
      And [額外驗證]
```

## 語言設定原則

| 元素 | 語言 | 說明 |
|------|------|------|
| Gherkin 關鍵字 | 英文 | `Feature`, `Rule`, `Example`, `Given`, `When`, `Then` |
| 描述內容 | 中文 | Feature 名稱、Rule 描述、步驟內容 |
| 時間格式 | 中文 | `2026/1/27上午9:00:00` |

## 結構層級

```
Feature > Rule > Example
```

每個 Feature 包含多個 Rule，每個 Rule 包含一或多個 Example。

## Gherkin 關鍵字對照表

| 關鍵字 | 用途 | 範例 |
|--------|------|------|
| Feature | 功能描述 | `Feature: 打卡記錄` |
| Background | 共用前置條件 | `Background:` |
| Rule | 業務規則 | `Rule: 前置條件 - 必須先有 IN 才能打 OUT` |
| Example | 測試場景 | `Example: 未上班就下班應失敗` |
| Scenario Outline | 參數化場景 | `Scenario Outline: 計算工時` |
| Examples | 參數表格 | `Examples: 標準工時` |
| Given | 前置條件 | `Given 已有一筆打卡記錄` |
| When | 執行動作 | `When 我打卡「OUT」` |
| Then | 預期結果 | `Then 打卡結果應該成功` |
| And | 延續上一個 | `And 工作表應該有 1 筆記錄` |

---

## Rule 撰寫規範

### 原子化原則

每個 Rule 只描述**一個具體規則**，不合併多個驗證邏輯。

```gherkin
# 好：一個 Rule 一個規則
Rule: 前置條件 - 必須先有 IN 記錄才能打 OUT（否則失敗）
Rule: 前置條件 - OUT 時間必須晚於同日 IN 時間（否則失敗）

# 不好：多個規則合併
Rule: 前置條件 - 參數驗證
  # 包含多種不同的驗證...
```

### Rule 分類

| 分類 | 子類 | 觸發情境 | 預期結果 |
|------|------|----------|----------|
| **前置條件** | 參數驗證 | 參數不合法 | 驗證失敗/錯誤 |
| **前置條件** | 狀態驗證 | 狀態不滿足 | 驗證失敗/錯誤 |
| **後置條件** | — | 參數合法 + 狀態滿足 | 驗證狀態預期 |

### Rule 命名格式

| 分類 | 命名格式 | 範例 |
|------|----------|------|
| 前置條件 | `前置條件 - xxx 必須 yyy（否則 zzz）` | `前置條件 - 必須先有 IN 記錄才能打 OUT（否則失敗）` |
| 後置條件 | `後置條件 - xxx 應 yyy` | `後置條件 - 無記錄時打 IN 應新增一筆 IN 記錄` |

---

## 完整結構範本

```gherkin
# language: en
Feature: 功能名稱
  作為一個 [角色]
  我想要 [目標]
  以便 [價值]

  Background:
    Given 系統已準備好「XXX」工作表

  # ========== 前置條件 - 參數驗證 ==========

  Rule: 前置條件 - A 必須 B（否則 C）

    Example: 場景描述
      Given 前置狀態
      When 執行動作
      Then 預期失敗結果
      And 錯誤訊息應包含「...」

  # ========== 前置條件 - 狀態驗證 ==========

  Rule: 前置條件 - X 必須 Y（否則 Z）

    Example: 場景描述
      Given 前置狀態
      When 執行動作
      Then 預期失敗結果

  # ========== 後置條件 ==========

  Rule: 後置條件 - P 應 Q

    Example: 場景描述
      Given 前置狀態
      When 執行動作
      Then 預期成功結果
      And 驗證狀態變更
```

---

## 參數化

使用引號標記參數，讓 Step Definition 可以捕捉：

```gherkin
# 字串參數
Given 系統已準備好「打卡記錄」工作表

# 數字參數
Then 工作表應該有 1 筆記錄

# 多個參數
Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
```

### Scenario Outline 參數化

當同一規則有多組測試資料時，使用 `Scenario Outline`：

```gherkin
Rule: 後置條件 - 工時應為所有 IN/OUT 配對的時間差總和

  Scenario Outline: 計算今日工時
    Given 已有一筆打卡記錄：類型「IN」時間「<上班時間>」
    And 已有一筆打卡記錄：類型「OUT」時間「<下班時間>」
    When 我查詢今日工時
    Then 工時應該是 <預期分鐘數> 分鐘

    Examples: 標準工時
      | 上班時間              | 下班時間              | 預期分鐘數 |
      | 2026/1/27上午9:00:00  | 2026/1/27下午6:00:00  | 540        |
      | 2026/1/27上午8:30:00  | 2026/1/27下午5:30:00  | 540        |

    Examples: 短時工作
      | 上班時間              | 下班時間               | 預期分鐘數 |
      | 2026/1/27上午9:00:00  | 2026/1/27上午11:00:00  | 120        |
```

---

## 撰寫原則

### 1. 使用者視角

用使用者的角度描述，而非技術細節。

```gherkin
# 好
When 我點擊「送出」按鈕

# 不好
When 我呼叫 submitForm() 函式
```

### 2. 獨立場景

每個 Example 應該可以獨立執行，不依賴其他場景。

```gherkin
# 好：每個場景自己建立前置條件
Example: 新增下班打卡記錄
  Given 已有一筆打卡記錄：類型「IN」時間「2026/1/27上午9:00:00」
  When 我在「2026/1/27下午6:00:00」打卡「OUT」
  Then 打卡結果應該成功

# 不好：依賴前一個場景的結果
Example: 新增下班打卡
  # 假設前一個場景已經打了上班卡...
  When 我打卡「OUT」
```

### 3. 具體例子

用具體的值而非抽象的描述。

```gherkin
# 好
Then 工作表應該有 1 筆記錄

# 不好
Then 工作表應該有記錄
```

### 4. 一個 Rule 一個規則

每個 Rule 只描述一個業務規則。

```gherkin
# 好：分開規則
Rule: 前置條件 - 必須先有 IN 記錄才能打 OUT（否則失敗）
  Example: 未上班就下班應失敗
    ...

Rule: 前置條件 - 必須先有 OUT 記錄才能再打 IN（否則失敗）
  Example: 連續上班打卡應失敗
    ...

# 不好：混在一起
Rule: 前置條件 - 打卡順序驗證
  Example: 未上班就下班應失敗
    ...
  Example: 連續上班打卡應失敗
    ...
```

---

## 常見錯誤

### 1. 過度技術化

```gherkin
# 不好
When 我呼叫 SpreadsheetApp.getActiveSpreadsheet().getSheetByName('打卡').appendRow([...])

# 好
When 我打卡「IN」
```

### 2. 步驟太長

```gherkin
# 不好
When 我填入員工編號「001」和姓名「王小明」和部門「工程部」然後點擊送出按鈕

# 好
When 我填入員工資料
  | 欄位     | 值       |
  | 員工編號 | 001      |
  | 姓名     | 王小明   |
  | 部門     | 工程部   |
And 我點擊「送出」按鈕
```

### 3. 缺少驗證

```gherkin
# 不好
Example: 打卡
  When 我打卡「IN」
  # 沒有驗證！

# 好
Example: 打卡
  When 我打卡「IN」
  Then 打卡結果應該成功
  And 工作表應該有 1 筆記錄
```

### 4. Rule 不夠原子化

```gherkin
# 不好：一個 Rule 包含多種不同的驗證邏輯
Rule: 前置條件 - 參數驗證
  Example: 未上班就下班應失敗
  Example: 連續上班打卡應失敗
  Example: 打卡時間不能相同

# 好：每個 Rule 專注於一個規則
Rule: 前置條件 - 必須先有 IN 記錄才能打 OUT（否則失敗）
  Example: 未上班就下班應失敗

Rule: 前置條件 - 必須先有 OUT 記錄才能再打 IN（否則失敗）
  Example: 連續上班打卡應失敗

Rule: 前置條件 - 打卡時間必須與前一筆不同（否則失敗）
  Example: 打卡時間不能相同
```

---

## 練習

試著為以下功能撰寫 Feature（使用 Rule 結構）：

1. 查詢今日打卡記錄
2. 計算本週工時
3. 修改打卡記錄

**提示：**
- 先列出前置條件（參數驗證、狀態驗證）
- 再列出後置條件（成功情境的預期結果）
- 每個規則寫成一個獨立的 Rule

## 下一步

閱讀 [03-打卡功能範例解說.md](./03-打卡功能範例解說.md) 看完整的 BDD 流程範例。
