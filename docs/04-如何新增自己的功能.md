# 如何新增自己的功能

學會了 BDD 流程後，你可以開始新增自己的功能了。

## 新增功能的步驟

### 1. 撰寫 Feature

在 `features/` 資料夾建立新的 `.feature` 檔案：

```gherkin
# language: zh-TW
# features/請假記錄.feature

功能: 請假記錄
  作為一個員工
  我想要申請請假
  以便追蹤我的假勤

  場景: 申請特休
    假設 系統已準備好「請假記錄」工作表
    當 我申請「特休」1 天
    那麼 申請結果應該成功
    而且 工作表應該有 1 筆記錄
```

### 2. 執行測試（應該失敗）

```bash
npm test -- features/請假記錄.feature
```

你會看到 "Undefined" 錯誤，因為還沒有 Step Definition。

### 3. 產生 Step Definition

複製以下指令給 AI 助手：

```
do: @prompts/01-Gherkin-to-Step-Definition.md
for: @features/請假記錄.feature
```

AI 會產生 Step Definition，將其存為 `features/step_definitions/請假.steps.js`

### 4. 確認紅燈

```bash
npm test -- features/請假記錄.feature
```

確認測試以正確的方式失敗（例如：函式不存在）。

### 5. 實作綠燈

複製以下指令給 AI 助手：

```
do: @prompts/03-綠燈.md
for: @features/請假記錄.feature
```

AI 會根據紅燈錯誤產生最小實作，將其加入 `src/程式碼.js`

### 6. 確認綠燈

```bash
npm test -- features/請假記錄.feature
```

確認所有測試通過。

### 7. 重構

複製以下指令給 AI 助手：

```
do: @prompts/04-重構.md
for: @src/程式碼.js
```

AI 會建議改善方向，修改後執行測試確認仍然通過

## 範例：加班申請功能

### Feature 檔案

```gherkin
# language: zh-TW
# features/加班記錄.feature

功能: 加班記錄
  作為一個員工
  我想要申請加班
  以便追蹤我的加班時數

  場景: 申請平日加班
    假設 系統已準備好「加班記錄」工作表
    當 我申請「2024-01-15」加班 2 小時
    那麼 申請結果應該成功
    而且 加班時數應該是 2 小時

  場景: 加班時數超過上限
    假設 系統已準備好「加班記錄」工作表
    當 我申請「2024-01-15」加班 5 小時
    那麼 申請結果應該失敗
    而且 錯誤訊息應該包含「超過每日加班上限」
```

### Step Definition

```javascript
// features/step_definitions/加班.steps.js

import { Given, When, Then, Before } from '@cucumber/cucumber';
import { strict as assert } from 'assert';
import { loadGasCodeForTesting } from '../../lib/gas-loader.js';

let ctx;

Before(function() {
  ctx = loadGasCodeForTesting({
    sheets: {
      '加班記錄': ['ID', '日期', '時數', '狀態', '建立時間']
    }
  });
});

Given('系統已準備好「加班記錄」工作表', function() {
  const sheet = ctx._getSheet('加班記錄');
  assert.ok(sheet, '工作表應該存在');
});

When('我申請「{string}」加班 {int} 小時', function(date, hours) {
  try {
    this.result = ctx.applyOvertime(date, hours);
  } catch (error) {
    this.error = error;
  }
});

Then('申請結果應該成功', function() {
  assert.ok(!this.error);
  assert.ok(this.result?.success);
});

Then('加班時數應該是 {int} 小時', function(hours) {
  assert.strictEqual(this.result?.hours, hours);
});

Then('申請結果應該失敗', function() {
  assert.ok(this.result?.success === false || this.error);
});

Then('錯誤訊息應該包含「{string}」', function(message) {
  const actual = this.result?.message || this.error?.message || '';
  assert.ok(actual.includes(message));
});
```

### 實作

```javascript
// src/程式碼.js

const MAX_DAILY_OVERTIME = 4;

function applyOvertime(date, hours) {
  if (hours > MAX_DAILY_OVERTIME) {
    return {
      success: false,
      message: '超過每日加班上限'
    };
  }

  const sheet = SpreadsheetApp.getActiveSpreadsheet()
    .getSheetByName('加班記錄');

  const id = Utilities.getUuid();
  const now = new Date();

  sheet.appendRow([id, date, hours, '待審核', now]);

  return {
    success: true,
    id: id,
    date: date,
    hours: hours
  };
}
```

## 常見問題

### Q: 如何處理多個工作表？

在 `loadGasCodeForTesting` 設定多個工作表：

```javascript
ctx = loadGasCodeForTesting({
  sheets: {
    '打卡記錄': ['ID', '類型', '時間', '建立時間'],
    '請假記錄': ['ID', '類型', '天數', '狀態', '建立時間'],
    '加班記錄': ['ID', '日期', '時數', '狀態', '建立時間']
  }
});
```

### Q: 如何模擬使用者身份？

```javascript
// 在測試中設定
ctx.Session._setEmail('user@example.com');

// 在 GAS 程式碼中使用
const email = Session.getActiveUser().getEmail();
```

### Q: 如何測試 Web App 介面？

參考 `features/頁面流程.feature` 和 `prompts/Mock學習指南.md`。

## 最佳實踐

### 1. 小步前進

每次只新增一個場景，確保通過後再進行下一個。

### 2. 保持獨立

每個功能的 Feature 和 Step Definition 放在獨立檔案。

### 3. 重用步驟

相同的 Given 步驟可以在不同 Feature 重用：

```javascript
// features/step_definitions/common.steps.js
Given('系統已準備好「{string}」工作表', function(sheetName) {
  const sheet = ctx._getSheet(sheetName);
  assert.ok(sheet);
});
```

### 4. 先跑測試

任何修改後都要執行 `npm test` 確認沒有破壞現有功能。

## 部署到 Apps Script

當功能完成後，可以部署到真實環境：

```bash
# 登入 clasp
npx clasp login

# 編輯 .clasp.json 填入 Script ID

# 推送程式碼
npx clasp push

# 開啟 Apps Script 編輯器
npx clasp open
```

## 恭喜！

你已經學會了 AI X BDD 的完整流程！

現在你可以：
1. 用 Gherkin 撰寫需求
2. 用 AI 產生測試和實作
3. 在本地驗證功能
4. 部署到 Apps Script

繼續練習，讓 BDD 成為你的開發習慣！
