Feature: 查詢花費方案分析

  Background:
    Given 系統中有以下旅遊計畫：
      | id | 計畫名稱       | 參與人數 | 預算上限 |
      | 1  | 2024 東京自由行 | 2        | 50000    |

  # ========== 前置條件 ==========

  Rule: 前置（參數）- 旅遊計畫ID必須提供

    Example: 未指定旅遊計畫時查詢失敗
      When 用戶 "Alice" 查詢花費方案分析
      Then 操作失敗
      And 錯誤訊息為 "旅遊計畫ID必須提供"

  # ========== 後置條件 ==========

  Rule: 後置（回應）- 應列出所有住宿與交通的組合

    Example: 顯示所有花費組合（笛卡爾積）
      Given 旅遊計畫 1 中有以下住宿選項：
        | 住宿名稱     | 總價  |
        | 東京車站飯店 | 9000  |
        | 新宿王子     | 7500  |
      And 旅遊計畫 1 中有以下交通方式：
        | 交通類型 | 起點 | 終點 | 費用 |
        | 飛機     | 台北 | 東京 | 8000 |
        | 廉航     | 台北 | 東京 | 5000 |
      When 用戶 "Alice" 查詢旅遊計畫 1 的花費方案分析
      Then 操作成功
      And 查詢結果應包含 4 個組合

  Rule: 後置（回應）- 組合總花費等於住宿總價加交通費用乘以人數

    Example: 計算組合總花費
      Given 旅遊計畫 1 中有以下住宿選項：
        | 住宿名稱     | 總價  |
        | 東京車站飯店 | 9000  |
      And 旅遊計畫 1 中有以下交通方式：
        | 交通類型 | 起點 | 終點 | 費用 |
        | 飛機     | 台北 | 東京 | 8000 |
      When 用戶 "Alice" 查詢旅遊計畫 1 的花費方案分析
      Then 操作成功
      And 查詢結果應包含：
        | 住宿名稱     | 住宿總價 | 交通方式 | 交通費用 | 組合總花費 | 每人平均花費 |
        | 東京車站飯店 | 9000     | 飛機     | 8000     | 25000      | 12500        |
      # 組合總花費 = 9000 + (8000 × 2) = 25000
      # 每人平均花費 = 25000 ÷ 2 = 12500

  Rule: 後置（回應）- 應標示是否超過預算

    Example: 標示超過預算的組合
      Given 旅遊計畫 1 中有以下住宿選項：
        | 住宿名稱     | 總價  |
        | 東京車站飯店 | 9000  |
        | 豪華酒店     | 30000 |
      And 旅遊計畫 1 中有以下交通方式：
        | 交通類型 | 起點 | 終點 | 費用  |
        | 飛機     | 台北 | 東京 | 8000  |
        | 商務艙   | 台北 | 東京 | 25000 |
      When 用戶 "Alice" 查詢旅遊計畫 1 的花費方案分析
      Then 操作成功
      And 查詢結果應包含：
        | 住宿名稱     | 交通方式 | 組合總花費 | 是否超過預算 |
        | 東京車站飯店 | 飛機     | 25000      | 否           |
        | 東京車站飯店 | 商務艙   | 59000      | 是           |
        | 豪華酒店     | 飛機     | 46000      | 否           |
        | 豪華酒店     | 商務艙   | 80000      | 是           |
      # 預算上限為 50000

  Rule: 後置（回應）- 結果應按總花費排序由低到高

    Example: 組合按總花費排序
      Given 旅遊計畫 1 中有以下住宿選項：
        | 住宿名稱     | 總價  |
        | 東京車站飯店 | 9000  |
        | 新宿王子     | 7500  |
      And 旅遊計畫 1 中有以下交通方式：
        | 交通類型 | 起點 | 終點 | 費用 |
        | 飛機     | 台北 | 東京 | 8000 |
        | 廉航     | 台北 | 東京 | 5000 |
      When 用戶 "Alice" 查詢旅遊計畫 1 的花費方案分析
      Then 操作成功
      And 查詢結果順序應為：
        | 順序 | 住宿名稱     | 交通方式 | 組合總花費 |
        | 1    | 新宿王子     | 廉航     | 17500      |
        | 2    | 東京車站飯店 | 廉航     | 19000      |
        | 3    | 新宿王子     | 飛機     | 23500      |
        | 4    | 東京車站飯店 | 飛機     | 25000      |
      # 新宿王子 + 廉航 = 7500 + (5000 × 2) = 17500
      # 東京車站飯店 + 廉航 = 9000 + (5000 × 2) = 19000
      # 新宿王子 + 飛機 = 7500 + (8000 × 2) = 23500
      # 東京車站飯店 + 飛機 = 9000 + (8000 × 2) = 25000

  Rule: 後置（回應）- 若無住宿或交通記錄應回傳空列表

    Example: 無住宿記錄時回傳空列表
      Given 旅遊計畫 1 中有以下交通方式：
        | 交通類型 | 起點 | 終點 | 費用 |
        | 飛機     | 台北 | 東京 | 8000 |
      When 用戶 "Alice" 查詢旅遊計畫 1 的花費方案分析
      Then 操作成功
      And 查詢結果應為空列表

    Example: 無交通記錄時回傳空列表
      Given 旅遊計畫 1 中有以下住宿選項：
        | 住宿名稱     | 總價 |
        | 東京車站飯店 | 9000 |
      When 用戶 "Alice" 查詢旅遊計畫 1 的花費方案分析
      Then 操作成功
      And 查詢結果應為空列表
